---
layout: post
title: 物联网核心组件
subtitle: 物联网介绍
author: Balbo Cheng
categories: programming-language
tags: [python, internet-of-things]
sidebar: []
---

一个完整的物联网应用通常是由传感器、处理芯片、通信模块、网络协议、应用软件、服务等组成的综合体，是一个多元化的应用形态。

与已有的传统产业相比，物联网应用往往需要：

- 更丰富的传感器：种类、结构、形态等需要多种多样
- 物联网特性的芯片：低功耗、小尺寸等
- 新的网络方案：低功耗、广域、大容量
- 新的通信协议：带宽低、流量低
- 具有物联网特性的云平台支撑

## 网络通信方案

网络类型、通信方式是物联网应用的基本硬件设施。在覆盖率、功耗、带宽、组网方式等方面，物联网针对不同的应用场景需要不同的网络类型或者是多种网络类型的组合。

### WIFI 网络

WIFI 的有点是速度相对较快，能够不需要网桥直接接入互联网，可以无缝地与手机进行通信，接入网络方便，带宽较宽；主要缺点在于，WIFI 芯片的封装尺寸稍大，功耗较高，对于动辄需要电池供电数年之久的物联网终端设备来说显然是不合适的。

### 移动网络

WIFI 网络速度快，带宽宽，相比移动网络来说覆盖率太低们，无法作为通用方案。使用移动网络芯片的物联网设备部署起来更加灵活，可有效填补 WIFI 网络覆盖不到的区域。他的缺点在于，设备采用 2G 或者 4G模块进行通信时需要消耗流量，运营商会收取流量费用。这对于数据量较低的应用来说缺点不明显，单数对于数据量很大的应用来说，则需要考虑流量的费用问题，因此,移动网络虽然比 WIFI 网络覆盖率更高，但是并不适合数据量太大的应用。

## Zigbee

Zigbee 技术是一种近距离、低复杂度、低功耗、低速率、低成本的双向无限通信技术，可由多到 65535 个无线数传模块组成一个无线数传网络平台，在整个网络范围内，每一个 Zigbee 网络数传模块之间可以相互通信，每个网络节点的距离可以从标准的 75m 无限扩展。

Zigbee 可无限连接，可工作在 2.4GHz（全球流行）、868MHz（欧洲流行）和915MHz（美国流行）3个频段上，分别具有最高250kb/s、20kb/s和40kb/s的传输速率，传输距离在 10~75m的范围内。

作为一种无限通信技术，Zigbee 具有如下特定：

- 低功耗
  
    由于 Zigbee 的传输速率低，发射功率仅为1mW，而且采用休眠模式，影刺Zigbee设备非常省电。据估算，Zigbee 设备仅靠两节5号电池就可以维持长达6个月到2年左右的时间

- 成本低
  
    Zigbee模块价格低，并且Zigbee协议是免专利费的。低成本对于Zigbee也是一个关键的因素

- 时延短
  
    通信时延和休眠状态激活的时延非常短，典型搜索设备的时延为 30ms，休眠激活的使用为 15ms，活动设备信道接入的时延为 15ms。因此，Zigbee 计数适用与对时延要求苛刻的无限控制应用。

- 网络容量大
  
    一个星形结构的Zigbee网络最多可以容纳 254 个从设备和一个煮设备，一个区域内可以同时存在最多 100 个 Zigbee网络，网络组成灵活

- 可靠
  
    采取碰撞避免策略，为需要固定带宽的通信业务预留了专用时隙，避开了发送数据的竞争和冲突。MAC 层采用完全确认的数据传输模式，每个发送的数据包都必须等待接收方的确认信息。如果在传输过程中出现问题，则可以重发。

- 安全
  
    Zigbee 提供了基于循环冗余校验（CRC）数据包的完整性检查功能，支持鉴权和认证，采用 AES-128的加密算法，各个应用可以灵活确认安全属性

### BLE

BLE 除了常规的对点通信之外，其 mesh 组网也即将面世，最大的优势在于可以直接与手机相连。

### LoRa

LoRa 是 LPWAN（低功耗广域网）通信技术中的一种，是美国 Semtech 公司采用和推广的一种基于扩频计数的超远距离无线传输方案。目前，LoRa 主要在全球免费频段运行，包括433MHz、868MHz和915MHz等

特点：

- 传输距离远
- 工作功率低
- 组网节点多

***LoRa 低功率***

我们知道，在通信系统中距离和功率事故矛盾的。发射功率降下来，传播距离必然就近了。LoRa 是如何解决这一矛盾呢？器根本原因是 LoRa 提高了接收机的灵敏度，从而拥有超强的链路预算，也就不需要很高的发射功率了

LoRa 接收端的灵敏度要归功与直接序列扩频计数，LoRa 采用高扩频因子，从而获得了较高的信号增益。一般 FSK 的信噪比需要 8dB,而 LoRa 只需要 -20dB

另外，LoRa 还应用了前向纠错编码技术，在传输信息中加入冗余，可有效抵抗多经衰落。虽然牺牲了一些传输效率。但有效提高了传输的可靠性，毕竟 LoRa 也不需要多块的传输速率

***LoRa 组网***

LoRa 网络主要由终端（可内置 LoRa 模块）、网关（或称基站）、网络服务器及应用服务器组成，应用数据可双向传输

LoRa 网络架构是一个典型的星形拓扑结构，LoRa 网关是一个透明传输的中继，连接终端设备和后端中央服务器。终端设备采用单跳与一个或多个网关通信。所有的节点与网关间均双向通信

***LoRa 终端设备***

LoRa 的终端节点可能是各种设备，如水表、气表、烟雾报警器、宠物跟踪器等，这些节点通过 LoRa 无线通信首先与 LoRa 网关连接，在通过移动网络或者以太网连接网络服务器。网关与网络服务器之间通过 TCP/IP 协议通信。

LoRa 网络将终端设备划分为A、B、C三类：

- Class A
  
    双向通信终端设备。这一类的终端设备允许双向通信每一个终端设备上行传输会伴随着两个下行接收窗口。终端设备的传输时隙基于自身的通信需求，微调基于 ALOHA 协议。Class A 设备的功耗最低，基站下行通信只能在终端上行通信之后

- Class B
  
    具有预设接收时隙的双向通信终端设备。这一类的终端设备会在预设时间中开放多余的接收窗口，为了达到这一目的，终端设备会同步从网关接收一个 Beacon，通过 Beacon 将基站与模块的时间同步。Class B 终端可以使基站知道终端正在接收数据

- Class C
  
    具有最大接收窗口的双向通信终端设备。这一类的终端设备持续开放接收窗口，只在传输时关闭。Class C 设备拥有最长的接收窗口，也最耗电

### NB-IoT

NB-IoT 时 IoT 领域一个新兴技术，支持低功耗设备在广域网的蜂窝数据连接们支持待机时间常、对网络要求较高设备的高效连接，能够提供非常全面的室内蜂窝数据连接覆盖

NB-IoT 在物联网应用中的优势显著，是传统蜂窝网计数及蓝牙、WIFI 等短距离传输计数所无法比拟的。首先，器覆盖更广，在同样的频段下，NB-IoT比现有的网络增益 20dB，覆盖面积扩大 100 倍

其次对海量连接的支撑能力，NB-IoT 的一个扇区能够支持10万个连接。目前，全球有约 500 万个物理站点，假设全部部署 NB-IoT，每个站点三个扇区，那么可以接入的物联网终端数将高达 4500 亿个

同时，NB-IoT 的功耗更低，仅为 2G 的 1/10，终端模块的待机时间可长达 10 年，在成本上也将更低，模块成本有望降至 5 美元之内。未来，随着市场发展带来的规模效应和计数演进。功耗和成本有望进一步降低

此外，在支持大数据方面，NB-IoT 连接所手机的数据可以直接上传云端，而蓝牙、WIFI等计数则没有这样的便利

## 网络通信协议

### HTTP

HTTP 协议是典型的 CS 通信模式，由客户端主动发起连接，向服务器请求 XML 或者 JSON 数据。该协议最早是为了使用 Web 浏览器上网浏览场景而设计的，目前在PC、随机、PDA等终端上都应用广泛，但并不适用物联网场景，弊端有三：

- 必须由设备主动向服务器发送数据，服务器难以主动向设备推送数据。对于单纯的数据采集等场景还勉强适用，但是对于频繁的操控场景，则只能通过设备的定期请求方式，实现成本和实时性都大打折扣。
- 安全性不高，Web的不安全是妇孺皆知的。HTTP 是明文协议，在很多要求高安全性的物联网场景，如果不做很多安全的准备工作，则后果不堪设想
- 不同于用户交互终端买入PC、手机，物联网场景中的设备多样化，对于运算和存储资源都十分受限的设备，通过 HTTP 协议实现 XML/JSON 数据格式的解析都是不可能的

### WebSocket

WebSocket 协议之前，双工通信时通过多个 HTTP 的连接实现的，导致效率低下。WebSocket的出现解决了这个问题

WebSocket 协议支持（在受控环境中运行不受信任的代码）客户端与（选择假如改代码的通信）远程主机之间进行全双工通信。其安全模型是 Web 浏览器常用的基于原始的安全模式。协议包括一个开放符握手及随后 TCP 层上的消息帧。该技术的目标是为基于浏览器的、需要和服务器进行双向通信的（服务器不能依赖打开多个 HTTP 连接，如使用 XMLHttpRequest 或 < iframe > 和长轮询）应用程序提供一种通信机制

### XMPP

XMPP（Extensible Messageing and Presence Protocol）是目前主流的四种 IM（instant messaging）协议之一。其他三种分别为即时信息和空间协议（IMPP）、空间和即时信息协议（PRIM）、针对即时通信和空间平衡扩充的进程开始协议SIP（SIMPLE)

XMPP 是基于可扩展标记语言（XML）的协议，可用于即时消息（IM）及在线现场探测，允许因特网用户向因特网上的其他任何人发送即时消息，即使操作系统和浏览器不同。XMPP 是基于 TCP/IP 的应用层协议

XMPP 定义3个角色客户端（Client）、服务器（Server）、网关（Gateway）。其通信能够在这三者的容易两个之间双向发生

服务器同时承担客户端的信息记录、连接管理和信息的路由功能

网关承担与异构即时通信系统的互联互通

客户端利用 XMPP 访问 Server，传输的是 XML

基本的网络形式是单客户端通过 TCP/IP 连接到单服务器，然后再之上传输 XML

XMPP 协议是公开的，由 JSF 开源社区组织开发。XMPP 协议并不属于任何的机构和个人，而是属于整个社区，这一点从根本上保证了开放性

XMPP 协议具有良好的扩展性。在 XMPP 中，即时消息和到场信息都是基于 XML 的结构化信息。这些信息以 XML 节的形式在通信实体间交换。XMPP 发挥了 XML 结构化数据通用传输层的作用，是数据以极高的效率传送给最合适的资源。基于 XML 建立起来的应用具有良好的语义完整性和扩展性

XMPP 协议基于 C/S 架构，本身并没有这样的限制。网络架构和电子邮件十分相似，没有结合任何特定的网络架构适用范围非常广泛

XMPP 具有很好的弹性，除了可用在即时通信的应用程序，还能用在网络管理、内容供稿、协同工具、档案共享、游戏、远端系统监控等

XMPP 在 Client-to-Server 通信和 Server-to-Server 通信中都使用 TLS（Transport Layer Security）协议作为通信通道的加密方法，可保证通信的安全。任何 XMPP 服务器都可以独立与公众 XMPP 网络（如企业内部网络中），使用 SASL 和 TLS 等计数更加增强了通信的安全性

### CoAP

CoAP 是受限应用协议（Constrained Application Protocol）的代名词。在最近几年的时间中，专家预测会有更多的设备相互连接，而这些设备的数量将远超人类的数量。在这种大背景下，物联网和 M2M 计数应运而生。虽然对人而言，接入互联网显得方便容易，但是对于那些微型设备而言，接入互联网非常困难

在当前由 PC 机组成的世界，信息交换是通过 TCP 和应用层协议 HTTP 实现的。对于小型设备而言，实现 TCP 和 HTTP 协议显然是一个过分的要求。为了让小设备可以接入互联网，CoAP 协议被设计出来。CoAP 是一种应用层协议，运行在 UDP 协议之上而不是像 HTTP 那样运行在 TCP 之上。CoAP 协议非常小巧抿嘴笑的数据白仅为4字节

CoAP 并不能替代 HTTP 协议、对于那些小设备（256KB Flash、32KB RAM、20MHz主频）而言，CoAP 确实是一个好的解决方案

CoAP 协议共有4种不同的消息类型：

- CON
  
    需要被确认的请求。如果 CON 请求被发送，那么对方必须做出响应

- NON
  
    不需要被确认的请求。如果 NON 请求被发送，那么对方不必做出响应

- ACK
  
    应答消息

- RST
  
    复位消息。当接收者收到的消息包含一个错误，则接收者会解析消息或者不在关心发送者发送的内容。复位消息将会被发送

***CoAP 的 URL***

一个 CoAP 资源可以被一个 URL 所描述，如一个设备可以测量温度，那么这个温度传感器的 URL 被描述为“//machine.address:5683/sebsors/temperature。CoAP 默认的 UDP 端口为 5683

***CoAP观察模式***

在物联网的世界中，你需要去监控某个传感器，如温度或湿度等。在这中情况下，CoAP 客户端可以发送一个观察请求到服务器端，从该时间点开始计算，服务器便会记住客户端的连接信息，一旦温度发生变化，服务器将会把新结果发送给客户端。如果客户端不在希望获得温度检测结果，则客户端会发送一个 RST 复位请求，此时服务器便会清除与客户端的连接信息

***CoAP块传输***

CoAP 协议的特点是传输的内容小巧精简，但是在某些情况下不得不传输较大的数据，在这种情况下，可以使用 CoAP 协议中的某个设定分块传输的大小，无论是服务器还是客户端都可完成分片和组装这两个动作

### MQTT

MQTT(消息队列遥测传输)是基于 TCP/IP 协议栈而构建的，已成为 IoT 通信的标准

MQTT 是一种轻量级的、灵活的网络协议，致力于为 IoT 开发人员实现适当的平衡：

- 这个轻量级协议可在严重受限的设备硬件和高延迟/带宽有限的网络上实现
- 他的灵活性使得为 IoT 设备和服务的多样化应用场景提供支持成为可能

MQTT 协议是为大量计算能力有限，且工作在低带宽、不可靠网络的远程传感器和控制设备通讯而设计的，具有以下主要的几项特性：

- 使用发布/订阅消息模式提供一对多的消息发布，解除应用程序耦合

- 对负载内容屏蔽的消息传输

- 使用 TCP/IP 提供网络连接

- 有三种消息发布服务质量
  
  + 至多一次
    
      消息发布完全依赖与底层 TCP/IP 网络，会发生消息丢失或重复，这一级别可用与环境传感器的数据传输，丢失一次记录无所谓，不久后还会有第二次
  
  + 至少一次
    
      确保消息到达，但消息可能会重复发送
  
  + 只有一次
    
      确保消息到达一次，在计费系统中，消息重复或丢失会导致不正确的结果
    
    * 小型传输，开销很小，协议交换最小化，以降低网络流量
    * 使用 Last Will 和 Testament 特性通知有关各方客户端异常中断的机制

## 硬件

- 传感器
  
    空气温湿度传感器、土壤湿度传感器、光照强度传感器、人体红外传感器、雨滴传感器、水位传感器

- 单片机
  
    本章使用 STM32 单片机的 TPYBoard 的作为 终端设备的核心板

- 树莓派
  
    采用树莓派作为网关，用到树莓派上的 ARM 处理器、TF 卡存储、WIFI 通信模块

- LoRa 通信模块
  
    网关与终端之间采用 LoRa 模块通信

- 2G 模块
  
    网关上搭载 2G 模块通过移动网络与后台服务器通信，通过 2G 你看打电话与发短信的功能实现报警

- 其他硬件外设
  
    舵机、水泵、LED灯等

## 物联网云平台

### OneNet

OneNet 是中移物联网有限公司自主研发的开放、共赢平台，是各种跨平台物联网应用、行业的解决方案，可提供简便的云端介入、存储、计算和展现

OneNet 的业务架构：

- 平台可提供多元化的API、完善的开发工具及众多的合作伙伴，帮助物联网应用开发商快速打造产品
- 专业的团队可提供 7*24 小时持续、安全、稳定的运营服务，平台架构可扩展，可帮助客户解决海量接入难题
- 设备的接入只是开始，通过平台对应用、设备、数据及用户的持续运营，应用开发商能挖掘更多的商机，激发无限的可能

OneNet 的功能：

- 设备资源管理，可实现设备的创建、激活、鉴权、修改、下线等整个生命周期的管理，可提供设备、数据流、数据点、传感器及 API-KEY 的增、删、查、改。
- 数据服务，可实现时间序列化数据的归档及获取
- 事件告警，可对数据流上的数据点实时监控、告警规则设置、告警通知等
- 消息总线，实时消息传输、路由，解决设备控制命令下行及实时通知消息的推送问题
- 各种接入协议支持，提供常用的 restful API 接口、socket 接口及对 MQTT\modbus 协议等的接入支持

OneNet 的特点：

- 有无限选择的开放平台。OneNet 支持创建产品和解决方案所需的多种软件和硬件的组合及多种语言和平台，包括 object C、C、Java、JavaScript、ruby等。API 支持灵活的 JSON 数据格式
- 端到端的安全。OneNet 提供在平台从终端到终端的安全性，并确保产品/解决方案的完整性，安全配置确保设备的控制，行业标准的对称数据加密（TLS, SSL）保护通信通道，细粒度权限管理（API 密钥）可确保正确的人在正确的时间进行正确的访问。另外，OneNet 的私有云基础架构可确保在任何时候的数据安全。
- 简单、轻松的开发体验。OneNet 开发中心通过文档、教程、视频和编程案例帮助用户学习，消减开发时间，直观的、基于 Web 的工具可简化物联网应用开发的复杂性，可提供交互连接差评的开发、调试工具，包括实时的 HTTP 消息监视、API 请求构造者、使用跟踪和可视化
- 选择性的数据共享。OneNet 平台允许设置气态应用程序访问设备的数据和控制权限，可以选择与全世界共享数据，也可以选择仅仅在私有系统中分享数据。一旦发布，连接的产品将成为连接对象云的一部分，通过 OneNet 的共享功能，可以选择性地互联第三方设备，将应用和服务整合到一个解决方案上
- 全互联的基础设施。OneNet 简历在中国移动大网环境下，提供全国性的互联基础设施，大量的设备投入可保障海量设备的接入和容灾，专业的开发和运营团队可保障平台 7*24 小时稳定运营
- 实时消息总线。OneNet 提供多样的通信方式，根据业务规模和需求，实时消息总线可利用 sockets 和 REST API 提供同步和异步通信方式
- 覆盖设备整个生命期管理。OneNet 可提供设备的注册、鉴权、接入、激活、删除等整个设备生命周期管理及便捷的大规模部署和实时数据监控
- 灵活的数据服务。高性能、时间序列的数据库使存储和检索一个数据点与 100 万个数据点一样容易，利用触发器，更多高级的监控、告警机制可以在设备和应用程序间实现

### AWS IoT

AWS IoT 解决方案是一个全托管的云平台，使互联设备可以轻松安全地与云应用程序及其他设备交互。AWS IoT 可支持数十亿台设备和数万跳消息，可以对这些消息进行处理并将器安全可靠地路由至 AWS 终端节点和其他设备

AWS IoT 平台支持设备连接到 AWS 服务和其他设备，保证数据和交互的安全，可处理设备数据并对其执行操作，可支持应用程序与即便处于离线状态的设备进行交互

- 连接并管理设备
- 保护设备连接和数据
- 处理设备数据并对其执行操作
- 随时读取和设置设备状态

AWS IoT 会保存设备的最新状态，以便能够随时进行读取或设置，使设备对应用程序来说似乎始终处于在线状态，表示应用程序可以读取设备的状态，并且允许设置设备状态，以及在设备重新连接后实施该状态

### Waston IoT

IBM Waston IoT 平台既可以提供云服务，也可以提供见客户专有服务。

IBM Waston IoT 提供如下功能特性：

- 设备注册
  
    提供百万级设备的注册设备互联，设备、网关和应用直接可以通过 MQTT 和 Waston IoT平台直连

- 网关支持
  
    支持其他设备通过网关接入

- 设备管理
  
    设备全生命周期管理

- 第三方服务接入
  
    基于 Service Broker，支持第三方服务开发接入历史数据管理，以 JSON 格式记录设备生成的所有数据

- 设备当前瞬时数据管理
  
    提供 API，给定 event-id，返回设备当前瞬时数据信息