I"›×<h2 id="-head">Â«Â«Â«&lt; HEAD</h2>
<p>layout:     post
title:      â€œä»£ç†â€
subtitle:   â€œâ€
date:       2019-11-28 14:36:05
author:     â€œBalboâ€
header-img: â€œimg/post-bg-2019.jpgâ€
tags:
    - reptile
â€”</p>
<h2 id="ä»£ç†çš„è®¾ç½®">ä»£ç†çš„è®¾ç½®</h2>

<h3 id="è·å–ä»£ç†">è·å–ä»£ç†</h3>

<p>åœ¨åšæµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·å–ä¸€ä¸ªå¯ç”¨ä»£ç†ï¼Œæœç´¢å¼•æ“æœç´¢â€œä»£ç†â€å…³é”®å­—ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ‰è®¸å¤šä»£ç†æœåŠ¡ç½‘ç«™ï¼Œåœ¨ç½‘ç«™ä¸Šä¼šæœ‰å¾ˆå¤šå…è´¹ä»£ç†ï¼Œæ¯”å¦‚è¥¿åˆºï¼šhttp://www.xicidaili.com/ ï¼Œè¿™é‡Œåˆ—å‡ºäº†å¾ˆå¤šå…è´¹ä»£ç†ï¼Œä½†æ˜¯è¿™äº›å…è´¹ä»£ç†å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä¸å¥½ç”¨çš„ï¼Œæ‰€ä»¥æ¯”è¾ƒé è°±çš„æ–¹æ³•æ˜¯è´­ä¹°ä»˜è´¹ä»£ç†ï¼Œå¾ˆå¤šç½‘ç«™éƒ½æœ‰å”®å–ï¼Œæ•°é‡ä¸ç”¨å¤šï¼Œä¹°ä¸€ä¸ªç¨³å®šå¯ç”¨çš„å³å¯ï¼Œå¯ä»¥è‡ªè¡Œé€‰è´­ã€‚</p>

<p>æˆ–è€…å¦‚æœæˆ‘ä»¬æœ¬æœºæœ‰ç›¸å…³ä»£ç†è½¯ä»¶çš„è¯ï¼Œè½¯ä»¶ä¸€èˆ¬ä¼šåœ¨æœ¬æœºåˆ›å»º HTTP æˆ– SOCKS ä»£ç†æœåŠ¡ï¼Œç›´æ¥ä½¿ç”¨æ­¤ä»£ç†ä¹Ÿå¯ä»¥ã€‚</p>

<h3 id="urllib">urllib</h3>
<p>é¦–å…ˆæˆ‘ä»¬ä»¥æœ€åŸºç¡€çš„ urllib ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹ä»£ç†çš„è®¾ç½®æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ProxyHandler</span><span class="p">,</span> <span class="n">build_opener</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">ProxyHandler</span><span class="p">({</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
    "Accept-Encoding": "identity", 
    "Connection": "close", 
    "Host": "httpbin.org", 
   "User-Agent": "Python-urllib/3.6"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>è¿è¡Œè¾“å‡ºç»“æœæ˜¯ä¸€ä¸ª Jsonï¼Œå®ƒæœ‰ä¸€ä¸ªå­—æ®µ originï¼Œæ ‡æ˜äº†å®¢æˆ·ç«¯çš„ IPï¼Œæ­¤å¤„çš„ IP éªŒè¯ä¸€ä¸‹ï¼Œç¡®å®ä¸ºä»£ç†çš„ IPï¼Œè€Œå¹¶ä¸æ˜¯æˆ‘ä»¬çœŸå®çš„ IPï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸè®¾ç½®å¥½ä»£ç†ï¼Œå¹¶å¯ä»¥éšè—çœŸå® IP äº†ã€‚</p>

<p>å¦‚æœé‡åˆ°éœ€è¦è®¤è¯çš„ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„æ–¹æ³•è®¾ç½®ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ProxyHandler</span><span class="p">,</span> <span class="n">build_opener</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
<span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">ProxyHandler</span><span class="p">({</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>å¦‚æœä»£ç†æ˜¯ SOCKS5 ç±»å‹ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼è®¾ç½®ä»£ç†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>æ­¤å¤„éœ€è¦ä¸€ä¸ª Socks æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install PySocks
</code></pre></div></div>

<h3 id="requests">requests</h3>

<p>å¯¹äº Requests æ¥è¯´ï¼Œä»£ç†è®¾ç½®æ›´åŠ ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ proxies å‚æ•°å³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
   
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
   "Accept": "*/*", 
   "Accept-Encoding": "gzip, deflate", 
   "Connection": "close", 
   "Host": "httpbin.org", 
   "User-Agent": "python-requests/2.18.1"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>å¦‚æœä»£ç†éœ€è¦è®¤è¯ï¼ŒåŒæ ·åœ¨ä»£ç†çš„å‰é¢åŠ ä¸Šç”¨æˆ·åå¯†ç å³å¯ï¼Œä»£ç†çš„å†™æ³•å°±å˜æˆï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
</code></pre></div></div>

<p>å¦‚æœéœ€è¦ä½¿ç”¨ SOCKS5 ä»£ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
    
proxy = '127.0.0.1:9742'
proxies = {
    'http': 'socks5://' + proxy,
    'https': 'socks5://' + proxy
}
try:
    response = requests.get('http://httpbin.org/get', proxies=proxies)
    print(response.text)
except requests.exceptions.ConnectionError as e:
    print('Error', e.args)
</code></pre></div></div>

<p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ª Socks æ¨¡å—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install "requests[socks]"
</code></pre></div></div>

<p>å¦å¤–è¿˜æœ‰ä¸€ç§è®¾ç½®æ–¹å¼ï¼Œå’Œ Urllib ä¸­çš„æ–¹æ³•ç›¸åŒï¼Œä½¿ç”¨ socks æ¨¡å—ï¼Œä¹Ÿéœ€è¦åƒä¸Šæ–‡ä¸€æ ·å®‰è£…è¯¥åº“ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
   <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™æ ·ä¹Ÿå¯ä»¥è®¾ç½® SOCKS5 ä»£ç†ï¼Œè¿è¡Œç»“æœå®Œå…¨ç›¸åŒï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å…¨å±€è®¾ç½®ï¼Œä¸åŒæƒ…å†µå¯ä»¥é€‰ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>

<h3 id="requests-1">requests</h3>

<p>å¯¹äº Requests æ¥è¯´ï¼Œä»£ç†è®¾ç½®æ›´åŠ ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ proxies å‚æ•°å³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
   
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
   "Accept": "*/*", 
   "Accept-Encoding": "gzip, deflate", 
   "Connection": "close", 
   "Host": "httpbin.org", 
   "User-Agent": "python-requests/2.18.1"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>å¦‚æœä»£ç†éœ€è¦è®¤è¯ï¼ŒåŒæ ·åœ¨ä»£ç†çš„å‰é¢åŠ ä¸Šç”¨æˆ·åå¯†ç å³å¯ï¼Œä»£ç†çš„å†™æ³•å°±å˜æˆï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
</code></pre></div></div>

<p>å¦‚æœéœ€è¦ä½¿ç”¨ SOCKS5 ä»£ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
    
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9742'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ª Socks æ¨¡å—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install "requests[socks]"
</code></pre></div></div>

<p>å¦å¤–è¿˜æœ‰ä¸€ç§è®¾ç½®æ–¹å¼ï¼Œå’Œ Urllib ä¸­çš„æ–¹æ³•ç›¸åŒï¼Œä½¿ç”¨ socks æ¨¡å—ï¼Œä¹Ÿéœ€è¦åƒä¸Šæ–‡ä¸€æ ·å®‰è£…è¯¥åº“ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
   <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™æ ·ä¹Ÿå¯ä»¥è®¾ç½® SOCKS5 ä»£ç†ï¼Œè¿è¡Œç»“æœå®Œå…¨ç›¸åŒï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å…¨å±€è®¾ç½®ï¼Œä¸åŒæƒ…å†µå¯ä»¥é€‰ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>

<h3 id="selenium">Selenium</h3>

<ul>
  <li>
    <p>chrome</p>

    <p>å¯¹äº Chrome æ¥è¯´ï¼Œç”¨ Selenium è®¾ç½®ä»£ç†çš„æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
        
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--proxy-server=http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">chrome_options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>è¿è¡Œç»“æœï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
"args": {}, 
"headers": {
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8", 
   "Accept-Encoding": "gzip, deflate", 
     "Accept-Language": "zh-CN,zh;q=0.8", 
     "Connection": "close", 
     "Host": "httpbin.org", 
     "Upgrade-Insecure-Requests": "1", 
     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"
}, 
"origin": "106.185.45.153", 
"url": "http://httpbin.org/get"
}
</code></pre></div>    </div>

    <p>å¦‚æœä»£ç†æ˜¯è®¤è¯ä»£ç†ï¼Œåˆ™è®¾ç½®æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.chrome.options</span> <span class="kn">import</span> <span class="n">Options</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
        
<span class="n">ip</span> <span class="o">=</span> <span class="s">'127.0.0.1'</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">9743</span>
<span class="n">username</span> <span class="o">=</span> <span class="s">'foo'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'bar'</span>
        
<span class="n">manifest_json</span> <span class="o">=</span> <span class="s">"""
{
    "version": "1.0.0",
    "manifest_version": 2,
    "name": "Chrome Proxy",
    "permissions": [
       "proxy",
       "tabs",
       "unlimitedStorage",
       "storage",
       "&lt;all_urls&gt;",
       "webRequest",
       "webRequestBlocking"
    ],
     "background": {
     "scripts": ["background.js"]
     }
}
        
background_js = """</span>
<span class="n">var</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">mode</span><span class="p">:</span> <span class="s">"fixed_servers"</span><span class="p">,</span>
        <span class="n">rules</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">singleProxy</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">scheme</span><span class="p">:</span> <span class="s">"http"</span><span class="p">,</span>
            <span class="n">host</span><span class="p">:</span> <span class="s">"%(ip)s"</span><span class="p">,</span>
            <span class="n">port</span><span class="p">:</span> <span class="o">%</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="n">s</span>
        <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
            
          <span class="n">chrome</span><span class="p">.</span><span class="n">proxy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="nb">set</span><span class="p">({</span><span class="n">value</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="s">"regular"</span><span class="p">},</span> <span class="n">function</span><span class="p">()</span> <span class="p">{});</span>
            
          <span class="n">function</span> <span class="n">callbackFn</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="p">{</span>
                  <span class="n">authCredentials</span><span class="p">:</span> <span class="p">{</span>
                      <span class="n">username</span><span class="p">:</span> <span class="s">"%(username)s"</span><span class="p">,</span>
                      <span class="n">password</span><span class="p">:</span> <span class="s">"%(password)s"</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
            
          <span class="n">chrome</span><span class="p">.</span><span class="n">webRequest</span><span class="p">.</span><span class="n">onAuthRequired</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span>
                      <span class="n">callbackFn</span><span class="p">,</span>
                      <span class="p">{</span><span class="n">urls</span><span class="p">:</span> <span class="p">[</span><span class="s">"&lt;all_urls&gt;"</span><span class="p">]},</span>
                      <span class="p">[</span><span class="s">'blocking'</span><span class="p">]</span>
          <span class="p">)</span>
          <span class="s">""" % {'ip': ip, 'port': port, 'username': username, 'password': password}
            
          plugin_file = 'proxy_auth_plugin.zip'
          with zipfile.ZipFile(plugin_file, 'w') as zp:
              zp.writestr("manifest.json", manifest_json)
              zp.writestr("background.js", background_js)
          chrome_options = Options()
          chrome_options.add_argument("--start-maximized")
          chrome_options.add_extension(plugin_file)
          browser = webdriver.Chrome(chrome_options=chrome_options)
          browser.get('http://httpbin.org/get')
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>PhantomJS</p>

    <p>å¯¹äº PhantomJSï¼Œä»£ç†è®¾ç½®æ–¹æ³•å¯ä»¥å€ŸåŠ©äº service_args å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œä»£ç†è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
  
<span class="n">service_args</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'--proxy=127.0.0.1:9743'</span><span class="p">,</span>
    <span class="s">'--proxy-type=http'</span>
<span class="p">]</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">(</span><span class="n">service_args</span><span class="o">=</span><span class="n">service_args</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">page_source</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>è¿è¡Œç»“æœï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "args": {},
    "headers": {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,en,*",
        "Connection": "close",
        "Host": "httpbin.org",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.0 Safari/538.1"
    },
    "origin": "106.185.45.153",
    "url": "http://httpbin.org/get"
}
</code></pre></div>    </div>

    <p>å¦‚æœéœ€è¦è®¤è¯ï¼Œé‚£ä¹ˆåªéœ€è¦å†åŠ å…¥ â€“proxy-auth é€‰é¡¹å³å¯ï¼Œè¿™æ ·å‚æ•°å°±æ”¹ä¸ºï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service_args = [
      '--proxy=127.0.0.1:9743',
      '--proxy-type=http',
      '--proxy-auth=username:password'
  ]
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="ä»£ç†æ± çš„ç»´æŠ¤">ä»£ç†æ± çš„ç»´æŠ¤</h2>

<h3 id="ä»£ç†æ± çš„ç›®æ ‡">ä»£ç†æ± çš„ç›®æ ‡</h3>

<p>ä»£ç†æ± è¦åšåˆ°æ˜“ç”¨ã€é«˜æ•ˆï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦åšåˆ°ä¸‹é¢çš„å‡ ä¸ªç›®æ ‡ï¼š</p>

<ul>
  <li>åŸºæœ¬æ¨¡å—åˆ†ä¸ºå››å—ï¼Œè·å–æ¨¡å—ã€å­˜å‚¨æ¨¡å—ã€æ£€æŸ¥æ¨¡å—ã€æ¥å£æ¨¡å—ã€‚
    <ul>
      <li>è·å–æ¨¡å—éœ€è¦å®šæ—¶å»å„å¤§ä»£ç†ç½‘ç«™æŠ“å–ä»£ç†ï¼Œä»£ç†å¯ä»¥æ˜¯å…è´¹å…¬å¼€ä»£ç†ä¹Ÿå¯ä»¥æ˜¯ä»˜è´¹ä»£ç†ï¼Œä»£ç†çš„å½¢å¼éƒ½æ˜¯ IP åŠ ç«¯å£ï¼Œå°½é‡ä»ä¸åŒæ¥æºè·å–ï¼Œå°½é‡æŠ“å–é«˜åŒ¿ä»£ç†ï¼ŒæŠ“å–å®Œä¹‹åå°†å¯ç”¨ä»£ç†ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</li>
      <li>å­˜å‚¨æ¨¡å—è´Ÿè´£å­˜å‚¨æŠ“å–ä¸‹æ¥çš„ä»£ç†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿è¯ä»£ç†ä¸é‡å¤ï¼Œå¦å¤–æˆ‘ä»¬è¿˜éœ€è¦æ ‡è¯†ä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œè€Œä¸”éœ€è¦åŠ¨æ€å®æ—¶å¤„ç†æ¯ä¸ªä»£ç†ï¼Œæ‰€ä»¥è¯´ï¼Œä¸€ç§æ¯”è¾ƒé«˜æ•ˆå’Œæ–¹ä¾¿çš„å­˜å‚¨æ–¹å¼å°±æ˜¯ä½¿ç”¨ Redis çš„ Sorted Setï¼Œä¹Ÿå°±æ˜¯æœ‰åºé›†åˆã€‚</li>
      <li>æ£€æµ‹æ¨¡å—éœ€è¦å®šæ—¶å°†æ•°æ®åº“ä¸­çš„ä»£ç†è¿›è¡Œæ£€æµ‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæ£€æµ‹é“¾æ¥ï¼Œæœ€å¥½æ˜¯çˆ¬å–å“ªä¸ªç½‘ç«™å°±æ£€æµ‹å“ªä¸ªç½‘ç«™ï¼Œè¿™æ ·æ›´åŠ æœ‰é’ˆå¯¹æ€§ï¼Œå¦‚æœè¦åšä¸€ä¸ªé€šç”¨å‹çš„ä»£ç†ï¼Œé‚£å¯ä»¥è®¾ç½®ç™¾åº¦ç­‰é“¾æ¥æ¥æ£€æµ‹ã€‚å¦å¤–æˆ‘ä»¬éœ€è¦æ ‡è¯†æ¯ä¸€ä¸ªä»£ç†çš„çŠ¶æ€ï¼Œå¦‚è®¾ç½®åˆ†æ•°æ ‡è¯†ï¼Œ100 åˆ†ä»£è¡¨å¯ç”¨ï¼Œåˆ†æ•°è¶Šå°‘ä»£è¡¨è¶Šä¸å¯ç”¨ï¼Œæ£€æµ‹ä¸€æ¬¡å¦‚æœå¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç«‹å³è®¾ç½®ä¸º100 æ»¡åˆ†ï¼Œä¹Ÿå¯ä»¥åœ¨åŸåŸºç¡€ä¸ŠåŠ  1 åˆ†ï¼Œå½“ä¸å¯ç”¨ï¼Œå¯ä»¥å°†å…¶å‡ 1 åˆ†ï¼Œå½“å‡åˆ°ä¸€å®šé˜ˆå€¼åå°±ç›´æ¥ä»æ•°æ®åº“ç§»é™¤ã€‚é€šè¿‡è¿™æ ·çš„æ ‡è¯†åˆ†æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒºåˆ†å‡ºä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œé€‰ç”¨çš„æ—¶å€™ä¼šæ›´æœ‰é’ˆå¯¹æ€§ã€‚</li>
      <li>æ¥å£æ¨¡å—éœ€è¦ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿æ•°æ®åº“æ¥å–ï¼Œä½†æ˜¯è¿™æ ·å°±éœ€è¦çŸ¥é“æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ï¼Œä¸å¤ªå®‰å…¨ï¼Œè€Œä¸”éœ€è¦é…ç½®è¿æ¥ï¼Œæ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒå®‰å…¨å’Œæ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯æä¾›ä¸€ä¸ª Web API æ¥å£ï¼Œé€šè¿‡è®¿é—®æ¥å£å³å¯æ‹¿åˆ°å¯ç”¨ä»£ç†ã€‚å¦å¤–ç”±äºå¯ç”¨ä»£ç†å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬å¯ä»¥æä¾›éšæœºè¿”å›ä¸€ä¸ªå¯ç”¨ä»£ç†çš„æ¥å£ï¼Œè¿™æ ·ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½å¯ä»¥å–åˆ°ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="ä»£ç†æ± çš„æ¶æ„">ä»£ç†æ± çš„æ¶æ„</h3>

<p>ä»£ç†æ± åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œè·å–æ¨¡å—ã€å­˜å‚¨æ¨¡å—ã€æ£€æµ‹æ¨¡å—ã€æ¥å£æ¨¡å—ã€‚</p>

<ul>
  <li>å­˜å‚¨æ¨¡å—ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œç”¨æ¥åšä»£ç†çš„å»é‡å’ŒçŠ¶æ€æ ‡è¯†ï¼ŒåŒæ—¶ä»–ä¹Ÿæ˜¯ä¸­å¿ƒæ¨¡å—å’ŒåŸºç¡€æ¨¡å—ï¼Œå°†å…¶ä»–æ¨¡å—ä¸²è”èµ·æ¥</li>
  <li>è·å–æ¨¡å—å®šæ—¶ä»ä»£ç†ç½‘ç«™è·å–ä»£ç†ï¼Œå°†è·å–çš„ä»£ç†ä¼ é€’ç»™å­˜å‚¨æ¨¡å—ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“</li>
  <li>æ£€æµ‹æ¨¡å—å®šæ—¶é€šè¿‡å­˜å‚¨æ¨¡å—è·å–æ‰€æœ‰ä»£ç†ï¼Œå¹¶å¯¹ä»£ç†è¿›è¡Œæ£€æµ‹ï¼Œæ ¹æ®ä¸åŒçš„æ£€æµ‹ç»“æœå¯¹ä»£ç†è®¾ç½®ä¸åŒçš„æ ‡è¯†</li>
  <li>æ¥å£æ¨¡å—é€šè¿‡ Web API æä¾›æœåŠ¡æ¥å£ï¼Œæ¥å£é€šè¿‡é“¾æ¥æ•°æ®åº“å¹¶é€šè¿‡ Web å½¢å¼è¿”å›å¯ç”¨çš„ä»£ç†</li>
</ul>

<h3 id="ä»£ç†æ± çš„å®ç°">ä»£ç†æ± çš„å®ç°</h3>

<ul>
  <li>
    <p>å­˜å‚¨æ¨¡å—</p>

    <p>å­˜å‚¨åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„ï¼Œå¯¹äºä»£ç†ä»£ç†æ± æ¥è¯´ï¼Œé›†åˆçš„å…ƒç´ å°±å˜æˆäº†ä¸€ä¸ªä¸ªä»£ç†ï¼Œä¹Ÿå°±æ˜¯ IP åŠ ç«¯å£çš„å½¢å¼ï¼Œå¦‚ 60.207.237.111:8888ï¼Œè¿™æ ·çš„ä¸€ä¸ªä»£ç†å°±æ˜¯é›†åˆçš„ä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æœ‰åºé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ è¿˜éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°å­—æ®µï¼Œåˆ†æ•°æ˜¯å¯ä»¥é‡å¤çš„ï¼Œæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•´æ•°ç±»å‹ã€‚è¯¥é›†åˆä¼šæ ¹æ®æ¯ä¸€ä¸ªå…ƒç´ çš„åˆ†æ•°å¯¹é›†åˆè¿›è¡Œæ’åºï¼Œæ•°å€¼å°çš„æ’åœ¨å‰é¢ï¼Œæ•°å€¼å¤§çš„æ’åœ¨åé¢ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°é›†åˆå…ƒç´ çš„æ’åºäº†ã€‚</p>

    <p>å¯¹äºä»£ç†æ± æ¥è¯´ï¼Œè¿™ä¸ªåˆ†æ•°å¯ä»¥ä½œä¸ºæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸ªä»£ç†å¯ç”¨ä¸å¯ç”¨çš„æ ‡å¿—ï¼Œæˆ‘ä»¬å°† 100 è®¾ä¸ºæœ€é«˜åˆ†ï¼Œä»£è¡¨å¯ç”¨ï¼Œ0 è®¾ä¸ºæœ€ä½åˆ†ï¼Œä»£è¡¨ä¸å¯ç”¨ã€‚ä»ä»£ç†æ± ä¸­è·å–ä»£ç†çš„æ—¶å€™ä¼šéšæœºè·å–åˆ†æ•°æœ€é«˜çš„ä»£ç†ï¼Œæ³¨æ„è¿™é‡Œæ˜¯éšæœºï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½ä¼šè¢«è°ƒç”¨åˆ°ã€‚</p>

    <ul>
      <li>åˆ†æ•° 100 ä¸ºå¯ç”¨ï¼Œæ£€æµ‹å™¨ä¼šå®šæ—¶å¾ªç¯æ£€æµ‹æ¯ä¸ªä»£ç†å¯ç”¨æƒ…å†µï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰å¯ç”¨çš„ä»£ç†å°±ç«‹å³ç½®ä¸º 100ï¼Œæ£€æµ‹åˆ°ä¸å¯ç”¨å°±å°†åˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åä»£ç†ç§»é™¤</li>
      <li>æ–°è·å–çš„ä»£ç†çš„åˆ†æ•°ä¸º10ï¼Œå¦‚æœæµ‹è¯•å¯è¡Œï¼Œåˆ†æ•°ç«‹å³ç½®ä¸º100ï¼Œä¸å¯è¡Œåˆ™åˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åä»£ç†ç§»é™¤</li>
    </ul>

    <p>è¿™åªæ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå½“ç„¶å¯èƒ½è¿˜æœ‰åˆç†çš„æ–¹æ¡ˆï¼Œä¹‹æ‰€ä»¥è®¾ç½®æ­¤æ–¹æ¡ˆæœ‰å¦‚ä¸‹å‡ ä¸ªåŸå› ï¼š</p>

    <ul>
      <li>åœ¨æ£€æµ‹åˆ°ä»£ç†å¯ç”¨æ—¶ï¼Œåˆ†æ•°ç«‹å³ç½®ä¸º100ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰å¯ç”¨ä»£ç†æœ‰æ›´å¤§çš„æœºä¼šè¢«è·å–åˆ°ã€‚ä¸ºä»€ä¹ˆä¸å°†åˆ†æ•°åŠ 1è€Œæ˜¯ç›´æ¥è®¾ä¸ºæœ€é«˜100å‘¢ï¼Ÿæœ‰ç‚¹ä»£ç†æ˜¯ä»å„å¤§å…è´¹å…¬å¼€ä»£ç†ç½‘ç«™è·å–çš„ï¼Œå¸¸å¸¸ä¸€ä¸ªä»£ç†å¹¶æ²¡æœ‰é‚£ä¹ˆç¨³å®šï¼Œå¹³å‡5æ¬¡è¯·æ±‚å¯èƒ½æœ‰2æ¬¡æˆåŠŸï¼Œ3æ¬¡å¤±è´¥ï¼Œå¦‚æœæŒ‰ç…§è¿™ç§åˆ†æ•°æ¥è®¾ç½®åˆ†æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªä»£ç†å‡ ä¹ä¸å¯èƒ½è¾¾åˆ°ä¸€ä¸ªé«˜çš„åˆ†æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä¾¿ä»–æœ‰æ—¶æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯ç­›é€‰çš„åˆ†æ•°æœ€é«˜ï¼Œé‚£è¿™æ ·çš„ä»£ç†å‡ ä¹ä¸å¯èƒ½è¢«å–åˆ°ã€‚å¦‚æœæƒ³è¿½æ±‚ä»£ç†ç¨³å®šæ€§ï¼Œå¯ç”¨ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å¯ç¡®ä¿åˆ†æ•°æœ€é«˜çš„ä»£ç†ä¸€å®šæ˜¯æœ€ç¨³å®šå¯ç”¨çš„ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡å–â€œå¯ç”¨å³è®¾ç½®ä¸º100â€çš„æ–¹æ³•ï¼Œç¡®ä¿åªè¦å¯ç”¨çš„ä»£ç†éƒ½å¯ä»¥è¢«è·å–</li>
      <li>åœ¨æ£€æµ‹åˆ°ä»£ç†ä¸å¯ç”¨æ—¶ï¼Œåˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åï¼Œä»£ç†ç§»é™¤ã€‚è¿™æ ·ä¸€ä¸ªæœ‰æ•ˆä»£ç†å¦‚æœè¦è¢«ç§»é™¤éœ€è¦è¿ç»­ä¸æ–­å¤±è´¥100æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªå¯ç”¨ä»£ç†å¦‚æœå°è¯•äº†100æ¬¡éƒ½å¤±è´¥äº†ï¼Œå°±ä¸€ç›´å‡åˆ†çŸ¥é“ç§»é™¤ï¼Œä¸€æ—¦æˆåŠŸå°±é‡æ–°ç½®å›100ã€‚å°è¯•çš„æœºä¼šè¶Šå¤šï¼Œåˆ™è¿™ä¸ªä»£ç†æ‹¯æ•‘å›æ¥çš„æœºä¼šè¶Šå¤šï¼Œè¿™æ ·å°±ä¸å®¹æ˜“å°†æ›¾ç»ä¸€ä¸ªå¯ç”¨ä»£ç†ä¸¢å¼ƒï¼Œä»¥ä¸ºä»£ç†ä¸å¯ç”¨çš„åŸå› å¯èƒ½æ—¶ç½‘ç»œç¹å¿™æˆ–è€…å…¶ä»–äººç”¨æ­¤ä»£ç†è¿‡äºé¢‘ç¹ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸º100</li>
      <li>æ–°è·å–çš„ä»£ç†çš„åˆ†æ•°è®¾ç½®ä¸º10.ç”±äºå¾ˆå¤šä»£ç†æ˜¯ä»å…è´¹ç½‘ç«™è·å–çš„ï¼Œæ‰€ä»¥æ–°è·å–çš„ä»£ç†æ— æ•ˆçš„æ¯”ä¾‹éå¸¸é«˜ï¼Œå¯èƒ½å¯ç”¨çš„ä»£ç†ä¸è¶³ 10%ã€‚æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°†åˆ†æ•°è®¾ç½®ä¸º10ï¼Œæ£€æµ‹çš„æœºä¼šæ²¡æœ‰å¯ç”¨ä»£ç†çš„100æ­¤é‚£ä¹ˆå¤šï¼Œè¿™ä¹Ÿå¯ä»¥é€‚å½“å‡å°‘å¼€é”€</li>
    </ul>

    <p>æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å®šä¹‰ä¸€ä¸ªç±»æ¥æ“ä½œæ•°æ®åº“çš„æœ‰åºé›†åˆï¼Œå®šä¹‰ä¸€äº›æ–¹æ³•æ¥å®ç°åˆ†æ•°çš„è®¾ç½®ï¼Œä»£ç†çš„è·å–ç­‰ç­‰ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MAX_SCORE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">MIN_SCORE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">INITIAL_SCORE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">REDIS_KEY</span> <span class="o">=</span> <span class="s">'proxies'</span>
  
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
  
  
<span class="k">class</span> <span class="nc">RedisClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ–
        :param host: Redis åœ°å€
        :param port: Redis ç«¯å£
        :param password: Rediså¯†ç 
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">INITIAL_SCORE</span><span class="p">):</span>
        <span class="s">"""
        æ·»åŠ ä»£ç†ï¼Œè®¾ç½®åˆ†æ•°ä¸ºæœ€é«˜
        :param proxy: ä»£ç†
        :param score: åˆ†æ•°
        :return: æ·»åŠ ç»“æœ
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zadd</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        éšæœºè·å–æœ‰æ•ˆä»£ç†ï¼Œé¦–å…ˆå°è¯•è·å–æœ€é«˜åˆ†æ•°ä»£ç†ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ŒæŒ‰ç…§æ’åè·å–ï¼Œå¦åˆ™å¼‚å¸¸
        :return: éšæœºä»£ç†
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrangebyscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">choice</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrevrange</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">choice</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PoolEmptyError</span>
  
    <span class="k">def</span> <span class="nf">decrease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        ä»£ç†å€¼å‡ä¸€åˆ†ï¼Œå°äºæœ€å°å€¼åˆ™åˆ é™¤
        :param proxy: ä»£ç†
        :return: ä¿®æ”¹åçš„ä»£ç†åˆ†æ•°
        """</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">MIN_SCORE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å½“å‰åˆ†æ•°'</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="s">'å‡1'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zincrby</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å½“å‰åˆ†æ•°'</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="s">'ç§»é™¤'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrem</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        :param proxy: ä»£ç†
        :return: æ˜¯å¦å­˜åœ¨
        """</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span>
  
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        å°†ä»£ç†è®¾ç½®ä¸ºMAX_SCORE
        :param proxy: ä»£ç†
        :return: è®¾ç½®ç»“æœ
        """</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å¯ç”¨ï¼Œè®¾ç½®ä¸º'</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zadd</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ•°é‡
        :return: æ•°é‡
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zcard</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–å…¨éƒ¨ä»£ç†
        :return: å…¨éƒ¨ä»£ç†åˆ—è¡¨
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrangebyscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MIN_SCORE</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ª RedisClient ç±»ï¼Œç”¨ä»¥æ“ä½œ Redis çš„æœ‰åºé›†åˆï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€äº›æ–¹æ³•æ¥å¯¹é›†åˆä¸­çš„å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

    <ul>
      <li>__init__() æ–¹æ³•æ˜¯åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ Redis çš„è¿æ¥ä¿¡æ¯ï¼Œé»˜è®¤çš„è¿æ¥ä¿¡æ¯å·²ç»å®šä¹‰ä¸ºå¸¸é‡ï¼Œåœ¨ __init__() æ–¹æ³•ç§åˆå§‹åŒ–ä¸€ä¸ª StrictRedis çš„ç±»ï¼Œå»ºç«‹ Redis è¿æ¥</li>
      <li>add() æ–¹æ³•å‘æ•°æ®åº“æ·»åŠ ä»£ç†å¹¶è®¾ç½®åˆ†æ•°ï¼Œé»˜è®¤çš„åˆ†æ•°æ˜¯ INITIAL_SCOREï¼Œä¹Ÿå°±æ˜¯10ï¼Œè¿”å›ç»“æœæ˜¯æ·»åŠ ä»£ç†çš„æ•°é‡</li>
      <li>random() æ–¹æ³•æ˜¯éšæœºè·å–ä»£ç†çš„æ–¹æ³•ï¼Œé¦–å…ˆè·å–100åˆ†çš„ä»£ç†ï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªè¿”å›ã€‚å¦‚æœä¸å­˜åœ¨100åˆ†çš„ä»£ç†ï¼Œåˆ™æ­¤æ–¹æ³•æŒ‰ç…§æ’åæ¥è·å–ï¼Œé€‰å–å‰100åï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªè¿”å›ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</li>
      <li>
        <p>decrease() æ–¹æ³•æ˜¯åœ¨ä»£ç†æ£€æµ‹æ— æ•ˆçš„æ—¶å€™è®¾ç½®åˆ†æ•°å‡1çš„æ–¹æ³•ï¼Œä»£ç†ä¼ å…¥é¦–ï¼Œæ­¤æ–¹æ³•å°†ä»£ç†çš„åˆ†æ•°å‡1ï¼Œå¦‚æœåˆ†æ•°è¾¾åˆ°æœ€ä½å€¼ï¼Œé‚£ä¹ˆä»£ç†å°±åˆ é™¤</p>
      </li>
      <li>è·å–æ¨¡å—</li>
    </ul>

    <p>è·å–æ¨¡å—çš„é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ª Crawler æ¥ä»å„å¤§ç½‘ç«™æŠ“å–ä»£ç†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_page</span>
<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
  
<span class="k">class</span> <span class="nc">ProxyMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFunc__'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">'crawl_'</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFunc__'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFuncCount__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
  
<span class="k">class</span> <span class="nc">Crawler</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ProxyMetaclass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="s">"self.{}()"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">callback</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸè·å–åˆ°ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
            <span class="n">proxies</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proxies</span>
  
    <span class="k">def</span> <span class="nf">crawl_daili66</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_count</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="s">"""
        è·å–ä»£ç†66
        :param page_count: é¡µç 
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.66ip.cn/{}.html'</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_url</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Crawling'</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                <span class="n">trs</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.containerbox table tr:gt(0)'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="p">:</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">tr</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'td:nth-child(1)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">tr</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'td:nth-child(2)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="s">':'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">])</span>
  
    <span class="k">def</span> <span class="nf">crawl_proxy360</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–Proxy360
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.proxy360.cn/Region/China'</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Crawling'</span><span class="p">,</span> <span class="n">start_url</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'div[name="list_proxy_ip"]'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.tbBottomLine:nth-child(1)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.tbBottomLine:nth-child(2)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                <span class="k">yield</span> <span class="s">':'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">])</span>
  
    <span class="k">def</span> <span class="nf">crawl_goubanjia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–Goubanjia
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.goubanjia.com/free/gngn/index.shtml'</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">tds</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'td.ip'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tds</span><span class="p">:</span>
                <span class="n">td</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p'</span><span class="p">).</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">td</span><span class="p">.</span><span class="n">text</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>ä½ å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯æ€æ ·è·å–äº†æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•åç§°çš„ã€‚å…¶å®è¿™é‡Œå€ŸåŠ©äºå…ƒç±»æ¥å®ç°ï¼Œå®šä¹‰äº†ä¸€ä¸ª ProxyMetaclassï¼ŒCrawl ç±»å°†å®ƒè®¾ç½®ä¸ºå…ƒç±»ï¼Œå…ƒç±»ä¸­å®ç°äº† new() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å›ºå®šçš„å‡ ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬å››ä¸ªå‚æ•° attrs ä¸­åŒ…å«äº†ç±»çš„ä¸€äº›å±æ€§ï¼Œè¿™å…¶ä¸­å°±åŒ…å«äº†ç±»ä¸­æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† attrs è¿™ä¸ªå˜é‡å³å¯è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ã€‚æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬åœ¨ new() æ–¹æ³•ä¸­éå†äº† attrs çš„è¿™ä¸ªå±æ€§ï¼Œå°±åƒéå†ä¸€ä¸ªå­—å…¸ä¸€æ ·ï¼Œé”®åå¯¹åº”çš„å°±æ˜¯æ–¹æ³•çš„åç§°ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­å…¶å¼€å¤´æ˜¯å¦æ˜¯ crawlï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å…¶åŠ å…¥åˆ° CrawlFunc å±æ€§ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸå°†æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•å®šä¹‰æˆäº†ä¸€ä¸ªå±æ€§ï¼Œå°±æˆåŠŸåŠ¨æ€åœ°è·å–åˆ°æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•åˆ—è¡¨äº†ã€‚</p>

    <p>æ‰€ä»¥è¯´ï¼Œå¦‚æœè¦åšæ‰©å±•çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€ä¸ªä»¥ crawlå¼€å¤´çš„æ–¹æ³•ï¼Œä¾‹å¦‚æŠ“å–å¿«ä»£ç†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ Crawler ç±»ä¸­å¢åŠ  crawl_kuaidaili() æ–¹æ³•ï¼Œä»¿ç…§å…¶ä»–çš„å‡ ä¸ªæ–¹æ³•å°†å…¶å®šä¹‰æˆç”Ÿæˆå™¨ï¼ŒæŠ“å–å…¶ç½‘ç«™çš„ä»£ç†ï¼Œç„¶åé€šè¿‡ yield è¿”å›ä»£ç†å³å¯ï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ‰©å±•ï¼Œè€Œä¸ç”¨å…³å¿ƒç±»å…¶ä»–éƒ¨åˆ†çš„å®ç°é€»è¾‘ã€‚</p>

    <p>ä»£ç†ç½‘ç«™çš„æ·»åŠ éå¸¸çµæ´»ï¼Œä¸ä»…å¯ä»¥æ·»åŠ å…è´¹ä»£ç†ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä»˜è´¹ä»£ç†ï¼Œä¸€äº›ä»˜è´¹ä»£ç†çš„æå–æ–¹å¼å…¶å®ä¹Ÿç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡ Web çš„å½¢å¼è·å–ï¼Œç„¶åè¿›è¡Œè§£æï¼Œè§£ææ–¹å¼å¯èƒ½æ›´åŠ ç®€å•ï¼Œå¦‚è§£æçº¯æ–‡æœ¬æˆ– Jsonï¼Œè§£æä¹‹åä»¥åŒæ ·çš„æ–¹å¼è¿”å›å³å¯ï¼Œåœ¨æ­¤ä¸å†æ·»åŠ ï¼Œå¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚</p>

    <p>æ—¢ç„¶å®šä¹‰äº†è¿™ä¸ª Crawler ç±»ï¼Œæˆ‘ä»¬å°±è¦è°ƒç”¨å•Šï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå†å®šä¹‰ä¸€ä¸ª Getter ç±»ï¼ŒåŠ¨æ€åœ°è°ƒç”¨æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•ï¼Œç„¶åè·å–æŠ“å–åˆ°çš„ä»£ç†ï¼Œå°†å…¶åŠ å…¥åˆ°æ•°æ®åº“å­˜å‚¨èµ·æ¥ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
<span class="kn">from</span> <span class="nn">crawler</span> <span class="kn">import</span> <span class="n">Crawler</span>
  
<span class="n">POOL_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mi">10000</span>
  
<span class="k">class</span> <span class="nc">Getter</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span> <span class="o">=</span> <span class="n">Crawler</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">is_over_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        åˆ¤æ–­æ˜¯å¦è¾¾åˆ°äº†ä»£ç†æ± é™åˆ¶
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">POOL_UPPER_THRESHOLD</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
  
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'è·å–å™¨å¼€å§‹æ‰§è¡Œ'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_over_threshold</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">callback_label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">__CrawlFuncCount__</span><span class="p">):</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">__CrawlFunc__</span><span class="p">[</span><span class="n">callback_label</span><span class="p">]</span>
                <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">get_proxies</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>æ£€æµ‹æ¨¡å—</p>

        <p>åœ¨è·å–æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸå°†å„ä¸ªç½‘ç«™çš„ä»£ç†è·å–ä¸‹æ¥äº†ï¼Œç„¶åå°±éœ€è¦ä¸€ä¸ªæ£€æµ‹æ¨¡å—æ¥å¯¹æ‰€æœ‰çš„ä»£ç†è¿›è¡Œä¸€è½®è½®çš„æ£€æµ‹ï¼Œæ£€æµ‹å¯ç”¨å°±è®¾ç½®ä¸º 100ï¼Œä¸å¯ç”¨å°±åˆ†æ•°å‡ 1ï¼Œè¿™æ ·å°±å¯ä»¥å®æ—¶æ”¹å˜æ¯ä¸ªä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œåœ¨è·å–æœ‰æ•ˆä»£ç†çš„æ—¶å€™åªéœ€è¦è·å–åˆ†æ•°é«˜çš„ä»£ç†å³å¯ã€‚</p>

        <p>ç”±äºä»£ç†çš„æ•°é‡éå¸¸å¤šï¼Œä¸ºäº†æé«˜ä»£ç†çš„æ£€æµ‹æ•ˆç‡ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ Aiohttp æ¥è¿›è¡Œæ£€æµ‹ã€‚</p>

        <p>Requests ä½œä¸ºä¸€ä¸ªåŒæ­¥è¯·æ±‚åº“ï¼Œæˆ‘ä»¬åœ¨å‘å‡ºä¸€ä¸ªè¯·æ±‚ä¹‹åéœ€è¦ç­‰å¾…ç½‘é¡µåŠ è½½å®Œæˆä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¼šé˜»å¡åœ¨ç­‰å¾…å“åº”è¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœæœåŠ¡å™¨å“åº”éå¸¸æ…¢ï¼Œæ¯”å¦‚ä¸€ä¸ªè¯·æ±‚ç­‰å¾…åå‡ ç§’ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨ Requests å®Œæˆä¸€ä¸ªè¯·æ±‚å°±ä¼šéœ€è¦åå‡ ç§’çš„æ—¶é—´ï¼Œä¸­é—´å…¶å®å°±æ˜¯ä¸€ä¸ªç­‰å¾…å“åº”çš„è¿‡ç¨‹ï¼Œç¨‹åºä¹Ÿä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè€Œè¿™åå‡ ç§’çš„æ—¶é—´å…¶å®å®Œå…¨å¯ä»¥å»åšå…¶ä»–çš„äº‹æƒ…ï¼Œæ¯”å¦‚è°ƒåº¦å…¶ä»–çš„è¯·æ±‚æˆ–è€…è¿›è¡Œç½‘é¡µè§£æç­‰ç­‰ã€‚</p>

        <p>å¼‚æ­¥è¯·æ±‚åº“å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒç±»ä¼¼ JavaScript ä¸­çš„å›è°ƒï¼Œæ„æ€æ˜¯è¯´åœ¨è¯·æ±‚å‘å‡ºä¹‹åï¼Œç¨‹åºå¯ä»¥ç»§ç»­æ¥ä¸‹å»æ‰§è¡Œå»åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“å“åº”åˆ°è¾¾æ—¶ï¼Œä¼šé€šçŸ¥ç¨‹åºå†å»å¤„ç†è¿™ä¸ªå“åº”ï¼Œè¿™æ ·ç¨‹åºå°±æ²¡æœ‰è¢«é˜»å¡ï¼Œå……åˆ†æŠŠæ—¶é—´å’Œèµ„æºåˆ©ç”¨èµ·æ¥ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚</p>

        <p>å¯¹äºå“åº”é€Ÿåº¦æ¯”è¾ƒå¿«çš„ç½‘ç«™ï¼Œå¯èƒ½ Requests åŒæ­¥è¯·æ±‚å’Œ Aiohttp å¼‚æ­¥è¯·æ±‚çš„æ•ˆæœå·®è·æ²¡é‚£ä¹ˆå¤§ï¼Œå¯å¯¹äºæ£€æµ‹ä»£ç†è¿™ç§äº‹æƒ…ï¼Œä¸€èˆ¬æ˜¯éœ€è¦åå¤šç§’ç”šè‡³å‡ åç§’çš„æ—¶é—´ï¼Œè¿™æ—¶å€™ä½¿ç”¨ Aiohttp å¼‚æ­¥è¯·æ±‚åº“çš„ä¼˜åŠ¿å°±å¤§å¤§ä½“ç°å‡ºæ¥äº†ï¼Œæ•ˆç‡å¯èƒ½ä¼šæé«˜å‡ åå€ä¸æ­¢ã€‚</p>

        <p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬çš„ä»£ç†æ£€æµ‹ä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ Aiohttpï¼Œå®ç°ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VALID_STATUS_CODES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">]</span>
<span class="n">TEST_URL</span> <span class="o">=</span> <span class="s">'http://www.baidu.com'</span>
<span class="n">BATCH_TEST_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    
    
<span class="k">class</span> <span class="nc">Tester</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_single_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        æµ‹è¯•å•ä¸ªä»£ç†
        :param proxy: å•ä¸ªä»£ç†
        :return: None
        """</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">verify_ssl</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">real_proxy</span> <span class="o">=</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨æµ‹è¯•'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">TEST_URL</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">real_proxy</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">VALID_STATUS_CODES</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†å¯ç”¨'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">decrease</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'è¯·æ±‚å“åº”ç ä¸åˆæ³•'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">ClientConnectorError</span><span class="p">,</span> <span class="nb">TimeoutError</span><span class="p">,</span> <span class="nb">AttributeError</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">decrease</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†è¯·æ±‚å¤±è´¥'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        æµ‹è¯•ä¸»å‡½æ•°
        :return: None
        """</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="c1"># æ‰¹é‡æµ‹è¯•
</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">),</span> <span class="n">BATCH_TEST_SIZE</span><span class="p">):</span>
                <span class="n">test_proxies</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">BATCH_TEST_SIZE</span><span class="p">]</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">test_single_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">test_proxies</span><span class="p">]</span>
                <span class="n">loop</span><span class="p">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å‘ç”Ÿé”™è¯¯'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>        </div>

        <p>åœ¨è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç±» Testerï¼Œinit() æ–¹æ³•ä¸­å»ºç«‹äº†ä¸€ä¸ª RedisClient å¯¹è±¡ï¼Œä¾›ç±»ä¸­å…¶ä»–æ–¹æ³•ä½¿ç”¨ã€‚æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ª test_single_proxy() æ–¹æ³•ï¼Œç”¨æ¥æ£€æµ‹å•ä¸ªä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œå…¶å‚æ•°å°±æ˜¯è¢«æ£€æµ‹çš„ä»£ç†ï¼Œæ³¨æ„è¿™ä¸ªæ–¹æ³•å‰é¢åŠ äº† async å…³é”®è¯ï¼Œä»£è¡¨è¿™ä¸ªæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ–¹æ³•å†…éƒ¨é¦–å…ˆåˆ›å»ºäº† Aiohttp çš„ ClientSession å¯¹è±¡ï¼Œæ­¤å¯¹è±¡ç±»ä¼¼äº Requests çš„ Session å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥å¯¹è±¡çš„ get() æ–¹æ³•æ¥è®¿é—®é¡µé¢ï¼Œåœ¨è¿™é‡Œä»£ç†çš„è®¾ç½®æ–¹å¼æ˜¯é€šè¿‡ proxy å‚æ•°ä¼ é€’ç»™ get() æ–¹æ³•ï¼Œè¯·æ±‚æ–¹æ³•å‰é¢ä¹Ÿéœ€è¦åŠ ä¸Š async å…³é”®è¯æ ‡æ˜æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œè¿™ä¹Ÿæ˜¯ Aiohttp ä½¿ç”¨æ—¶çš„å¸¸è§å†™æ³•ã€‚</p>

        <p>æµ‹è¯•çš„é“¾æ¥åœ¨è¿™é‡Œå®šä¹‰å¸¸é‡ä¸º TEST_URLï¼Œå¦‚æœé’ˆå¯¹æŸä¸ªç½‘ç«™æœ‰æŠ“å–éœ€æ±‚ï¼Œå»ºè®®å°† TEST_URL è®¾ç½®ä¸ºç›®æ ‡ç½‘ç«™çš„åœ°å€ï¼Œå› ä¸ºåœ¨æŠ“å–çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä»£ç†æœ¬èº«æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯è¯¥ä»£ç†çš„ IP å·²ç»è¢«ç›®æ ‡ç½‘ç«™å°æ‰äº†ã€‚ä¾‹å¦‚ï¼Œå¦‚è¦æŠ“å–çŸ¥ä¹ï¼Œå¯èƒ½å…¶ä¸­æŸäº›ä»£ç†æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚è®¿é—®ç™¾åº¦ç­‰é¡µé¢æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¯èƒ½å¯¹çŸ¥ä¹æ¥è¯´å¯èƒ½å°±è¢«å°äº†ï¼Œæ‰€ä»¥å¯ä»¥å°† TEST_URL è®¾ç½®ä¸ºçŸ¥ä¹çš„æŸä¸ªé¡µé¢çš„é“¾æ¥ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶ï¼Œå½“ä»£ç†è¢«å°æ—¶ï¼Œåˆ†æ•°è‡ªç„¶ä¼šå‡ä¸‹æ¥ï¼Œå°±ä¸ä¼šè¢«å–åˆ°äº†ã€‚</p>

        <p>å¦‚æœæƒ³åšä¸€ä¸ªé€šç”¨çš„ä»£ç†æ± ï¼Œåˆ™ä¸éœ€è¦ä¸“é—¨è®¾ç½® TEST_URLï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªä¸ä¼šå° IP çš„ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºç™¾åº¦è¿™ç±»å“åº”ç¨³å®šçš„ç½‘ç«™ã€‚</p>

        <p>å¦å¤–æˆ‘ä»¬è¿˜å®šä¹‰äº† VALID_STATUS_CODES å˜é‡ï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼ï¼ŒåŒ…å«äº†æ­£å¸¸çš„çŠ¶æ€ç ï¼Œå¦‚å¯ä»¥å®šä¹‰æˆ [200]ï¼Œå½“ç„¶å¯¹äºæŸäº›æ£€æµ‹ç›®æ ‡ç½‘ç«™å¯èƒ½ä¼šå‡ºç°å…¶ä»–çš„çŠ¶æ€ç ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥è‡ªè¡Œé…ç½®ã€‚</p>

        <p>è·å– Response åéœ€è¦åˆ¤æ–­å“åº”çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€ç åœ¨ VALID_STATUS_CODES è¿™ä¸ªåˆ—è¡¨é‡Œï¼Œåˆ™ä»£è¡¨ä»£ç†å¯ç”¨ï¼Œè°ƒç”¨ RedisClient çš„ max() æ–¹æ³•å°†ä»£ç†åˆ†æ•°è®¾ä¸º 100ï¼Œå¦åˆ™è°ƒç”¨ decrease() æ–¹æ³•å°†ä»£ç†åˆ†æ•°å‡ 1ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ä¹ŸåŒæ ·å°†ä»£ç†åˆ†æ•°å‡ 1ã€‚</p>

        <p>å¦å¤–åœ¨æµ‹è¯•çš„æ—¶å€™è®¾ç½®äº†æ‰¹é‡æµ‹è¯•çš„æœ€å¤§å€¼ BATCH_TEST_SIZE ä¸º 100ï¼Œä¹Ÿå°±æ˜¯ä¸€æ‰¹æµ‹è¯•æœ€å¤šæµ‹è¯• 100ä¸ªï¼Œè¿™å¯ä»¥é¿å…å½“ä»£ç†æ± è¿‡å¤§æ—¶å…¨éƒ¨æµ‹è¯•å¯¼è‡´å†…å­˜å¼€é”€è¿‡å¤§çš„é—®é¢˜ã€‚</p>

        <p>éšååœ¨ run() æ–¹æ³•é‡Œé¢è·å–äº†æ‰€æœ‰çš„ä»£ç†åˆ—è¡¨ï¼Œä½¿ç”¨ Aiohttp åˆ†é…ä»»åŠ¡ï¼Œå¯åŠ¨è¿è¡Œï¼Œè¿™æ ·å°±å¯ä»¥è¿›è¡Œå¼‚æ­¥æ£€æµ‹äº†ï¼Œå†™æ³•å¯ä»¥å‚è€ƒ Aiohttp çš„å®˜æ–¹ç¤ºä¾‹ï¼šhttp://aiohttp.readthedocs.io/ã€‚</p>
      </li>
      <li>
        <p>æ¥å£æ¨¡å—</p>

        <p>è¿‡ä¸Šè¿°ä¸‰ä¸ªæ¨¡å—æˆ‘ä»¬å·²ç»å¯ä»¥åšåˆ°ä»£ç†çš„è·å–ã€æ£€æµ‹å’Œæ›´æ–°äº†ï¼Œæ•°æ®åº“ä¸­å°±ä¼šä»¥æœ‰åºé›†åˆçš„å½¢å¼å­˜å‚¨å„ä¸ªä»£ç†è¿˜æœ‰å¯¹åº”çš„åˆ†æ•°ï¼Œåˆ†æ•° 100 ä»£è¡¨å¯ç”¨ï¼Œåˆ†æ•°è¶Šå°ä»£è¡¨è¶Šä¸å¯ç”¨ã€‚</p>

        <p>ä½†æ˜¯æˆ‘ä»¬æ€æ ·æ¥æ–¹ä¾¿åœ°è·å–å¯ç”¨ä»£ç†å‘¢ï¼Ÿç”¨ RedisClient ç±»æ¥ç›´æ¥è¿æ¥ Redis ç„¶åè°ƒç”¨ random() æ–¹æ³•è·å–å½“ç„¶æ²¡é—®é¢˜ï¼Œè¿™æ ·åšæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯æœ‰è¿™ä¹ˆå‡ ä¸ªå¼Šç«¯ï¼š</p>

        <ul>
          <li>å¦‚æœå…¶ä»–äººä½¿ç”¨è¿™ä¸ªä»£ç†æ± ï¼Œä»–éœ€è¦çŸ¥é“ Redis è¿æ¥çš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ï¼Œè¿™æ ·å¾ˆä¸å®‰å…¨ã€‚</li>
          <li>å¦‚æœä»£ç†æ± éœ€è¦éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œï¼ŒäºŒè¿œç¨‹æœåŠ¡å™¨çš„ Redis åªå…è®¸æœ¬åœ°è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½è¿œç¨‹ç›´è¿ Redis æ¥è·å–ä»£ç†</li>
          <li>å¦‚æœçˆ¬è™«æ‰€åœ¨çš„ä¸»æœºæ²¡æœ‰è¿æ¥ Redis æ¨¡å—ï¼Œæˆ–è€…çˆ¬è™«ä¸æ˜¯ç”± Python è¯­è¨€ç¼–å†™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ— æ³•ä½¿ç”¨ RedisClient æ¥è·å–ä»£ç†</li>
          <li>å¦‚æœ RedisClient ç±»æˆ–è€…æ•°æ®åº“ç»“æ„æœ‰æ›´æ–°ï¼Œå‘¢å—çˆ¬è™«ç«¯å¿…é¡»åŒæ­¥è¿™äº›æ›´æ–°ï¼Œè¿™æ ·éå¸¸éº»çƒ¦</li>
        </ul>

        <p>ç»¼ä¸Šè€ƒè™‘ï¼Œä¸ºäº†ä½¿å¾—ä»£ç†æ± å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹æœåŠ¡è¿è¡Œï¼Œæˆ‘ä»¬æœ€å¥½å¢åŠ ä¸€ä¸ªæ¥å£æ¨¡å—ï¼Œä»¥ Web API çš„å½¢å¼æš´éœ²å¯ç”¨ä»£ç†ã€‚</p>

        <p>è¿™æ ·è·å–ä»£ç†åªéœ€è¦è¯·æ±‚ä¸€ä¸‹æ¥å£å³å¯ï¼Œä»¥ä¸Šçš„å‡ ä¸ªç¼ºç‚¹å¼Šç«¯å¯ä»¥è§£å†³ã€‚</p>

        <p>æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„åº“ Flask æ¥å®ç°è¿™ä¸ªæ¥å£æ¨¡å—ï¼Œå®ç°ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
    
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    
<span class="k">def</span> <span class="nf">get_conn</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'redis'</span><span class="p">):</span>
        <span class="n">g</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">redis</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;'</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/random'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="s">"""
    è·å–éšæœºå¯ç”¨ä»£ç†
    :return: éšæœºä»£ç†
    """</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">conn</span><span class="p">.</span><span class="n">random</span><span class="p">()</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/count'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_counts</span><span class="p">():</span>
    <span class="s">"""
    è·å–ä»£ç†æ± æ€»é‡
    :return: ä»£ç†æ± æ€»é‡
    """</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">count</span><span class="p">())</span>
    
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>        </div>

        <p>è¿è¡Œä¹‹å Flask ä¼šå¯åŠ¨ä¸€ä¸ª Web æœåŠ¡ï¼Œæˆ‘ä»¬åªéœ€è¦è®¿é—®å¯¹åº”çš„æ¥å£å³å¯è·å–åˆ°å¯ç”¨ä»£ç†ã€‚</p>
      </li>
      <li>
        <p>è°ƒåº¦æ¨¡å—</p>

        <p>è¿™ä¸ªæ¨¡å—å…¶å®å°±æ˜¯è°ƒç”¨ä»¥ä¸Šæ‰€å®šä¹‰çš„ä¸‰ä¸ªæ¨¡å—ï¼Œå°†ä»¥ä¸Šä¸‰ä¸ªæ¨¡å—é€šè¿‡å¤šè¿›ç¨‹çš„å½¢å¼è¿è¡Œèµ·æ¥ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">TESTER_CYCLE</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">GETTER_CYCLE</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">TESTER_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">GETTER_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">API_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
      
  <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
  <span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span>
  <span class="kn">from</span> <span class="nn">getter</span> <span class="kn">import</span> <span class="n">Getter</span>
  <span class="kn">from</span> <span class="nn">tester</span> <span class="kn">import</span> <span class="n">Tester</span>
      
      
  <span class="k">class</span> <span class="nc">Scheduler</span><span class="p">():</span>
      <span class="k">def</span> <span class="nf">schedule_tester</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">TESTER_CYCLE</span><span class="p">):</span>
          <span class="s">"""
          å®šæ—¶æµ‹è¯•ä»£ç†
          """</span>
          <span class="n">tester</span> <span class="o">=</span> <span class="n">Tester</span><span class="p">()</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="n">tester</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
              <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">schedule_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">GETTER_CYCLE</span><span class="p">):</span>
          <span class="s">"""
          å®šæ—¶è·å–ä»£ç†
          """</span>
          <span class="n">getter</span> <span class="o">=</span> <span class="n">Getter</span><span class="p">()</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'å¼€å§‹æŠ“å–ä»£ç†'</span><span class="p">)</span>
              <span class="n">getter</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
              <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">schedule_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="s">"""
          å¼€å¯API
          """</span>
          <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">API_HOST</span><span class="p">,</span> <span class="n">API_PORT</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†æ± å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">TESTER_ENABLED</span><span class="p">:</span>
              <span class="n">tester_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_tester</span><span class="p">)</span>
              <span class="n">tester_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
      
          <span class="k">if</span> <span class="n">GETTER_ENABLED</span><span class="p">:</span>
              <span class="n">getter_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_getter</span><span class="p">)</span>
              <span class="n">getter_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
      
          <span class="k">if</span> <span class="n">API_ENABLED</span><span class="p">:</span>
              <span class="n">api_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_api</span><span class="p">)</span>
              <span class="n">api_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>        </div>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯åŠ¨å…¥å£æ˜¯ run() æ–¹æ³•ï¼Œå…¶åˆ†åˆ«åˆ¤æ–­äº†ä¸‰ä¸ªæ¨¡å—çš„å¼€å…³ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œå°±æ–°å»ºä¸€ä¸ª Process è¿›ç¨‹ï¼Œè®¾ç½®å¥½å¯åŠ¨ç›®æ ‡ï¼Œç„¶åè°ƒç”¨ start() æ–¹æ³•è¿è¡Œï¼Œè¿™æ ·ä¸‰ä¸ªè¿›ç¨‹å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚
  
ä¸‰ä¸ªè°ƒåº¦æ–¹æ³•ç»“æ„ä¹Ÿéå¸¸æ¸…æ™°ï¼Œæ¯”å¦‚ schedule_tester() æ–¹æ³•ï¼Œè¿™æ˜¯ç”¨æ¥è°ƒåº¦æµ‹è¯•æ¨¡å—çš„æ–¹æ³•ï¼Œé¦–å…ˆå£°æ˜ä¸€ä¸ª Tester å¯¹è±¡ï¼Œç„¶åè¿›å…¥æ­»å¾ªç¯ä¸æ–­å¾ªç¯è°ƒç”¨å…¶ run() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œä¸€è½®ä¹‹åå°±ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œä¼‘çœ ç»“æŸä¹‹åé‡æ–°å†æ‰§è¡Œã€‚åœ¨è¿™é‡Œä¼‘çœ æ—¶é—´ä¹Ÿå®šä¹‰ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå¦‚ 20 ç§’ï¼Œè¿™æ ·å°±ä¼šæ¯éš” 20 ç§’è¿›è¡Œä¸€æ¬¡ä»£ç†æ£€æµ‹ã€‚
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="è¿è¡Œ">è¿è¡Œ</h3>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»£ç æ•´åˆä¸€ä¸‹ï¼Œå°†ä»£ç†è¿è¡Œèµ·æ¥</p>

<p>ä»¥ä¸Šæ˜¯ä»£ç†æ± çš„æ§åˆ¶å°è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°å¯ç”¨ä»£ç†è®¾ç½®ä¸º 100ï¼Œä¸å¯ç”¨ä»£ç†åˆ†æ•°å‡ 1ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†æ‰“å¼€æµè§ˆå™¨ï¼Œå½“å‰é…ç½®äº†è¿è¡Œåœ¨ 5555 ç«¯å£ï¼Œæ‰€ä»¥æ‰“å¼€ï¼šhttp://127.0.0.1:5555ï¼Œå³å¯çœ‹åˆ°å…¶é¦–é¡µ</p>

<p>å†è®¿é—®ï¼šhttp://127.0.0.1:5555/randomï¼Œå³å¯è·å–éšæœºå¯ç”¨ä»£ç†</p>

<p>æ‰€ä»¥åé¢æˆ‘ä»¬åªéœ€è¦è®¿é—®æ­¤æ¥å£å³å¯è·å–ä¸€ä¸ªéšæœºå¯ç”¨ä»£ç†ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>

<p>è·å–ä»£ç†çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">PROXY_POOL_URL</span> <span class="o">=</span> <span class="s">'http://localhost:5555/random'</span>

<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
    <span class="k">except</span> <span class="nb">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<p>æœ‰äº†ä»£ç†æ± ä¹‹åï¼Œæˆ‘ä»¬å†å–å‡ºä»£ç†å³å¯æœ‰æ•ˆé˜²æ­¢IPè¢«å°ç¦çš„æƒ…å†µã€‚</p>

<h2 id="ä½¿ç”¨ä»£ç†çˆ¬å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« ">ä½¿ç”¨ä»£ç†çˆ¬å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« </h2>

<h3 id="çˆ¬å–åˆ†æ">çˆ¬å–åˆ†æ</h3>

<p>æœç‹—å¯¹å¾®ä¿¡å…¬ä¼—å¹³å°çš„å…¬ä¼—å·å’Œæ–‡ç« åšäº†æ•´åˆã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„é“¾æ¥æœç´¢åˆ°ç›¸å…³çš„å…¬ä¼—å·å’Œæ–‡ç« ï¼Œä¾‹å¦‚æœç´¢ NBAï¼Œå¯ä»¥æœç´¢åˆ°æœ€æ–°çš„æ–‡ç« </p>

<p>ç‚¹å‡»æœç´¢åï¼Œæœç´¢ç»“æœçš„ URL ä¸­å…¶å®æœ‰å¾ˆå¤šæ— å…³ GET è¯·æ±‚å‚æ•°ï¼Œå°†æ— å…³çš„å‚æ•°å»æ‰ï¼Œåªä¿ç•™ type å’Œ query å‚æ•°ï¼Œä¾‹å¦‚ http://weixin.sogou.com/weixin?type=2&amp;query=NBAï¼Œæœç´¢å…³é”®è¯ä¸º NBAï¼Œç±»å‹ä¸º 2ï¼Œ2 ä»£è¡¨æœç´¢å¾®ä¿¡æ–‡ç« ã€‚</p>

<p>ä¸‹æ‹‰ç½‘é¡µï¼Œç‚¹å‡»ä¸‹ä¸€é¡µå³å¯ç¿»é¡µ</p>

<p>æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥è´¦å·ç™»å½•ï¼Œé‚£åªèƒ½çœ‹åˆ° 10 é¡µçš„å†…å®¹ï¼Œç™»å½•ä¹‹åå¯ä»¥çœ‹åˆ° 100 é¡µå†…å®¹</p>

<p>å¦‚æœéœ€è¦çˆ¬å–æ›´å¤šå†…å®¹ï¼Œå°±éœ€è¦ç™»å½•å¹¶ä½¿ç”¨ Cookies æ¥çˆ¬å–ã€‚</p>

<p>æœç‹—å¾®ä¿¡ç«™ç‚¹çš„åçˆ¬è™«èƒ½åŠ›å¾ˆå¼ºï¼Œå¦‚è¿ç»­åˆ·æ–°ï¼Œç«™ç‚¹å°±ä¼šå¼¹å‡ºéªŒè¯ã€‚</p>

<p>ç½‘ç»œè¯·æ±‚å‡ºç°äº† 302 è·³è½¬ï¼Œè¿”å›çŠ¶æ€ç ä¸º 302ï¼Œè·³è½¬çš„é“¾æ¥å¼€å¤´ä¸º http://weixin.sogou.com/antispider/ ï¼Œè¿™å¾ˆæ˜æ˜¾å°±æ˜¯ä¸€ä¸ªåçˆ¬è™«çš„éªŒè¯é¡µé¢ã€‚æ‰€ä»¥æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›çŠ¶æ€ç ä¸º 302 è€Œé 200ï¼Œåˆ™ IP è®¿é—®æ¬¡æ•°å¤ªé«˜ï¼ŒIP è¢«å°ç¦ï¼Œæ­¤è¯·æ±‚å°±æ˜¯å¤±è´¥äº†ã€‚</p>

<p>å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¯†åˆ«éªŒè¯ç å¹¶è§£å°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»£ç†ç›´æ¥åˆ‡æ¢ IPã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨ä»£ç†ç›´æ¥è·³è¿‡è¿™ä¸ªéªŒè¯ã€‚ä»£ç†ä½¿ç”¨ä¸Šä¸€èŠ‚æ‰€è®²çš„ä»£ç†æ± ï¼Œè¿˜éœ€è¦æ›´æ”¹æ£€æµ‹çš„ URL ä¸ºæœç‹—å¾®ä¿¡çš„ç«™ç‚¹ã€‚</p>

<p>å¯¹äºè¿™ç§åçˆ¬èƒ½åŠ›å¾ˆå¼ºçš„ç½‘ç«™æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬é‡åˆ°æ­¤ç§è¿”å›çŠ¶æ€å°±éœ€è¦é‡è¯•ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å¦ä¸€ç§çˆ¬å–æ–¹å¼ï¼Œå€ŸåŠ©æ•°æ®åº“æ„é€ ä¸€ä¸ªçˆ¬å–é˜Ÿåˆ—ï¼Œå¾…çˆ¬å–çš„è¯·æ±‚éƒ½æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œå¦‚æœè¯·æ±‚å¤±è´¥äº†é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œå°±ä¼šè¢«é‡æ–°è°ƒåº¦çˆ¬å–ã€‚</p>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Redis çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œæ–°çš„è¯·æ±‚å°±åŠ å…¥é˜Ÿåˆ—ï¼Œæˆ–è€…æœ‰éœ€è¦é‡è¯•çš„è¯·æ±‚ä¹Ÿæ”¾å›é˜Ÿåˆ—ã€‚è°ƒåº¦çš„æ—¶å€™å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œé‚£å°±æŠŠä¸€ä¸ªä¸ªè¯·æ±‚å–å‡ºæ¥æ‰§è¡Œï¼Œå¾—åˆ°å“åº”åå†è¿›è¡Œè§£æï¼Œæå–å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>

<p>è¿™æ¬¡æˆ‘ä»¬é‡‡ç”¨ MySQL å­˜å‚¨ï¼Œå€ŸåŠ© PyMySQL åº“ï¼Œå°†çˆ¬å–ç»“æœæ„é€ ä¸ºä¸€ä¸ªå­—å…¸ï¼Œå®ç°åŠ¨æ€å­˜å‚¨ã€‚</p>

<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬æœ¬èŠ‚å®ç°çš„åŠŸèƒ½æœ‰å¦‚ä¸‹å‡ ç‚¹ã€‚</p>

<ul>
  <li>ä¿®æ”¹ä»£ç†æ± æ£€æµ‹é“¾æ¥ä¸ºæœç‹—å¾®ä¿¡ç«™ç‚¹</li>
  <li>æ„é€  Redis çˆ¬å–é˜Ÿåˆ—ï¼Œç”¨é˜Ÿåˆ—å®ç°è¯·æ±‚çš„å­˜å–</li>
  <li>å®ç°å¼‚å¸¸å¤„ç†ï¼Œå¤±è´¥çš„è¯·æ±‚é‡æ–°åŠ å…¥é˜Ÿåˆ—</li>
  <li>å®ç°ç¿»é¡µå’Œæå–æ–‡ç« åˆ—è¡¨å¹¶æŠŠå¯¹åº”è¯·æ±‚åŠ å…¥é˜Ÿåˆ—</li>
  <li>å®ç°å¾®ä¿¡æ–‡ç« çš„ä¿¡æ¯çš„æå–</li>
  <li>å°†æå–åˆ°çš„ä¿¡æ¯ä¿å­˜åˆ° MySQL</li>
</ul>

<h3 id="è¯·æ±‚æ„é€ ">è¯·æ±‚æ„é€ </h3>

<p>æ—¢ç„¶æˆ‘ä»¬è¦ç”¨é˜Ÿåˆ—æ¥å­˜å‚¨è¯·æ±‚ï¼Œé‚£ä¹ˆè‚¯å®šè¦å®ç°ä¸€ä¸ªè¯·æ±‚ Request çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªè¯·æ±‚éœ€è¦åŒ…å«ä¸€äº›å¿…è¦ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚é“¾æ¥ã€è¯·æ±‚å¤´ã€è¯·æ±‚æ–¹å¼ã€è¶…æ—¶æ—¶é—´ã€‚å¦å¤–å¯¹äºæŸä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å¯¹åº”çš„æ–¹æ³•æ¥å¤„ç†å®ƒçš„å“åº”ï¼Œæ‰€ä»¥éœ€è¦å†åŠ ä¸€ä¸ª Callback å›è°ƒå‡½æ•°ã€‚æ¯æ¬¡ç¿»é¡µè¯·æ±‚éœ€è¦ä»£ç†æ¥å®ç°ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå‚æ•° NeedProxyã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚å¤±è´¥æ¬¡æ•°å¤ªå¤šï¼Œé‚£å°±ä¸å†é‡æ–°è¯·æ±‚äº†ï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ å¤±è´¥æ¬¡æ•°çš„è®°å½•ã€‚</p>

<p>è¿™äº›å­—æ®µéƒ½éœ€è¦ä½œä¸º Request çš„ä¸€éƒ¨åˆ†ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„ Request å¯¹è±¡æ”¾å…¥é˜Ÿåˆ—å»è°ƒåº¦ï¼Œè¿™æ ·ä»é˜Ÿåˆ—è·å–å‡ºæ¥çš„æ—¶å€™ç›´æ¥æ‰§è¡Œè¿™ä¸ª Request å¯¹è±¡å°±å¥½äº†ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç»§æ‰¿ reqeusts åº“ä¸­çš„ Request å¯¹è±¡çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªæ•°æ®ç»“æ„ã€‚requests åº“ä¸­å·²ç»æœ‰äº† Request å¯¹è±¡ï¼Œå®ƒå°†è¯·æ±‚ Request ä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹è±¡å»æ‰§è¡Œï¼Œå¾—åˆ°å“åº”åå†è¿”å›ã€‚å…¶å® requests åº“çš„ get()ã€post() ç­‰æ–¹æ³•éƒ½æ˜¯é€šè¿‡æ‰§è¡Œ Request å¯¹è±¡å®ç°çš„ã€‚</p>

<p>æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ Request å¯¹è±¡çš„æºç ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">RequestHooksMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c1"># Default empty dicts for dict params.
</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">data</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">files</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">headers</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">hooks</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">hooks</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">default_hooks</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hooks</span><span class="p">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">register_hook</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">hook</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">json</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">cookies</span>
</code></pre></div></div>

<p>è¿™æ˜¯ requests åº“ä¸­ Request å¯¹è±¡çš„æ„é€ æ–¹æ³•ã€‚è¿™ä¸ª Request å·²ç»åŒ…å«äº†è¯·æ±‚æ–¹å¼ã€è¯·æ±‚é“¾æ¥ã€è¯·æ±‚å¤´è¿™å‡ ä¸ªå±æ€§ï¼Œä½†æ˜¯ç›¸æ¯”æˆ‘ä»¬éœ€è¦çš„è¿˜å·®äº†å‡ ä¸ªã€‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œåœ¨åŸå…ˆåŸºç¡€ä¸ŠåŠ å…¥ä¸Šæ–‡æ‰€æåˆ°çš„é¢å¤–å‡ ä¸ªå±æ€§ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿ Request å¯¹è±¡é‡æ–°å®ç°ä¸€ä¸ªè¯·æ±‚ï¼Œå°†å®ƒå®šä¹‰ä¸º WeixinRequestï¼Œå®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">class</span> <span class="nc">WeixinRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fail_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">):</span>
        <span class="n">Request</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">need_proxy</span> <span class="o">=</span> <span class="n">need_proxy</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">=</span> <span class="n">fail_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å®ç°äº† WeixinRequest æ•°æ®ç»“æ„ã€‚init() æ–¹æ³•å…ˆè°ƒç”¨äº† Request çš„init() æ–¹æ³•ï¼Œç„¶ååŠ å…¥é¢å¤–çš„å‡ ä¸ªå‚æ•°ï¼Œå®šä¹‰ä¸º callbackã€need_proxyã€fail_timeã€timeoutï¼Œåˆ†åˆ«ä»£è¡¨å›è°ƒå‡½æ•°ã€æ˜¯å¦éœ€è¦ä»£ç†çˆ¬å–ã€å¤±è´¥æ¬¡æ•°ã€è¶…æ—¶æ—¶é—´ã€‚</p>

<p>æˆ‘ä»¬å°±å¯ä»¥å°† WeixinRequest ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥æ‰§è¡Œï¼Œä¸€ä¸ªä¸ª WeixinRequest å¯¹è±¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰è‡ªå·±çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å®ƒçš„ callbackï¼Œå°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¯·æ±‚çš„å“åº”åº”è¯¥ç”¨ä»€ä¹ˆæ–¹æ³•æ¥å¤„ç†ï¼Œè°ƒç”¨ fail_time å°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¯·æ±‚å¤±è´¥äº†å¤šå°‘æ¬¡ï¼Œåˆ¤æ–­å¤±è´¥æ¬¡æ•°æ˜¯ä¸æ˜¯åˆ°äº†é˜ˆå€¼ï¼Œè¯¥ä¸è¯¥ä¸¢å¼ƒè¿™ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨äº†é¢å‘å¯¹è±¡çš„ä¸€äº›æ€æƒ³ã€‚</p>

<h3 id="å®ç°è¯·æ±‚é˜Ÿåˆ—">å®ç°è¯·æ±‚é˜Ÿåˆ—</h3>

<p>å­˜å–æ— éå°±æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œä¸€ä¸ªæ˜¯æ”¾ï¼Œä¸€ä¸ªæ˜¯å–ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨ Redis çš„ rpush() å’Œ lpop() æ–¹æ³•å³å¯ã€‚</p>

<p>å¦å¤–è¿˜éœ€è¦æ³¨æ„ï¼Œå­˜å–ä¸èƒ½ç›´æ¥å­˜ Request å¯¹è±¡ï¼ŒRedis é‡Œé¢å­˜çš„æ˜¯å­—ç¬¦ä¸²ã€‚æ‰€ä»¥åœ¨å­˜ Request å¯¹è±¡ä¹‹å‰æˆ‘ä»¬å…ˆæŠŠå®ƒåºåˆ—åŒ–ï¼Œå–å‡ºæ¥çš„æ—¶å€™å†å°†å…¶ååºåˆ—åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ©ç”¨ pickle æ¨¡å—å®ç°ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>

<span class="k">class</span> <span class="nc">RedisQueue</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ– Redis"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        å‘é˜Ÿåˆ—æ·»åŠ åºåˆ—åŒ–åçš„ Request
        :param request: è¯·æ±‚å¯¹è±¡
        :param fail_time: å¤±è´¥æ¬¡æ•°
        :return: æ·»åŠ ç»“æœ
        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">rpush</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        å–å‡ºä¸‹ä¸€ä¸ª Request å¹¶ååºåˆ—åŒ–
        :return: Request or None
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">llen</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">lpop</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">llen</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div></div>

<p>è¿™é‡Œå®ç°äº†ä¸€ä¸ª RedisQueueï¼Œå®ƒçš„ <strong>init</strong>() æ„é€ æ–¹æ³•é‡Œé¢åˆå§‹åŒ–äº†ä¸€ä¸ª StrictRedis å¯¹è±¡ã€‚éšåå®ç°äº† add() æ–¹æ³•ï¼Œé¦–å…ˆåˆ¤æ–­ Request çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ WeixinRequestï¼Œé‚£ä¹ˆå°±æŠŠç¨‹åºå°±ä¼šç”¨ pickle çš„ dumps() æ–¹æ³•åºåˆ—åŒ–ï¼Œç„¶åå†è°ƒç”¨ rpush() æ–¹æ³•åŠ å…¥é˜Ÿåˆ—ã€‚pop() æ–¹æ³•åˆ™ç›¸åï¼Œè°ƒç”¨ lpop() æ–¹æ³•å°†è¯·æ±‚ä»é˜Ÿåˆ—å–å‡ºï¼Œç„¶åå†ç”¨ pickle çš„ loads() æ–¹æ³•å°†å…¶è½¬ä¸º WeixinRequest å¯¹è±¡ã€‚å¦å¤–ï¼Œempty() æ–¹æ³•è¿”å›é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œåªéœ€è¦åˆ¤æ–­é˜Ÿåˆ—é•¿åº¦æ˜¯å¦ä¸º 0 å³å¯ã€‚</p>

<p>åœ¨è°ƒåº¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°å»ºä¸€ä¸ª RedisQueue å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ add() æ–¹æ³•ï¼Œä¼ å…¥ WeixinRequest å¯¹è±¡ï¼Œå³å¯å°† WeixinRequest åŠ å…¥é˜Ÿåˆ—ï¼Œè°ƒç”¨ pop() æ–¹æ³•ï¼Œå³å¯å–å‡ºä¸‹ä¸€ä¸ª WeixinRequest å¯¹è±¡ï¼Œéå¸¸ç®€å•æ˜“ç”¨ã€‚</p>

<h3 id="ä¿®æ”¹ä»£ç†æ± ">ä¿®æ”¹ä»£ç†æ± </h3>

<p>ä¹‹å‰ä»£ç†æ± æ£€æµ‹çš„ URL å¹¶ä¸æ˜¯æœç‹—å¾®ä¿¡ç«™ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»£ç†æ± æ£€æµ‹çš„ URL ä¿®æ”¹æˆæœç‹—å¾®ä¿¡ç«™ç‚¹ï¼Œä»¥ä¾¿äºæŠŠè¢«æœç‹—å¾®ä¿¡ç«™ç‚¹å°ç¦çš„ä»£ç†å‰”é™¤æ‰ï¼Œç•™ä¸‹å¯ç”¨ä»£ç†ã€‚</p>

<p>ç°åœ¨å°†ä»£ç†æ± çš„è®¾ç½®æ–‡ä»¶ä¸­çš„ TEST_URL ä¿®æ”¹ä¸€ä¸‹ï¼Œå¦‚ http://weixin.sogou.com/weixin?type=2&amp;query=nba ï¼Œè¢«æœ¬ç«™ç‚¹å°çš„ä»£ç†å°±ä¼šå‡åˆ†ï¼Œæ­£å¸¸è¯·æ±‚çš„ä»£ç†å°±ä¼šèµ‹å€¼ä¸º 100ï¼Œæœ€åç•™ä¸‹çš„å°±æ˜¯å¯ç”¨ä»£ç†ã€‚</p>

<p>ä¿®æ”¹ä¹‹åå°†è·å–æ¨¡å—ã€æ£€æµ‹æ¨¡å—ã€æ¥å£æ¨¡å—çš„å¼€å…³éƒ½è®¾ç½®ä¸º Trueï¼Œè®©ä»£ç†æ± è¿è¡Œä¸€ä¼š</p>

<p>è¿™æ ·ï¼Œæ•°æ®åº“ä¸­ç•™ä¸‹çš„ 100 åˆ†çš„ä»£ç†å°±æ˜¯é’ˆå¯¹æœç‹—å¾®ä¿¡çš„å¯ç”¨ä»£ç†äº†</p>

<p>åŒæ—¶è®¿é—®ä»£ç†æ¥å£ï¼Œæ¥å£è®¾ç½®ä¸º 5555ï¼Œè®¿é—® http://127.0.0.1:5555/random ï¼Œå³å¯è·å–åˆ°éšæœºå¯ç”¨ä»£ç†</p>

<p>å†å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è·å–éšæœºä»£ç†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PROXY_POOL_URL</span> <span class="o">=</span> <span class="s">'http://127.0.0.1:5555/random'</span>

<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    ä»ä»£ç†æ± è·å–ä»£ç†
    :return:
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Get Proxy'</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="ç¬¬ä¸€ä¸ªè¯·æ±‚">ç¬¬ä¸€ä¸ªè¯·æ±‚</h3>

<p>ä¸€åˆ‡å‡†å¤‡å·¥ä½œéƒ½åšå¥½ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ„é€ ç¬¬ä¸€ä¸ªè¯·æ±‚æ”¾åˆ°é˜Ÿåˆ—é‡Œä»¥ä¾›è°ƒåº¦äº†ã€‚å®šä¹‰ä¸€ä¸ª Spider ç±»ï¼Œå®ç° start() æ–¹æ³•çš„ä»£ç å¦‚ä¸‹:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="k">class</span> <span class="nc">Spider</span><span class="p">():</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s">'http://weixin.sogou.com/weixin'</span>
    <span class="n">keyword</span> <span class="o">=</span> <span class="s">'NBA'</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span><span class="p">,</span>
        <span class="s">'Accept-Encoding'</span><span class="p">:</span> <span class="s">'gzip, deflate'</span><span class="p">,</span>
        <span class="s">'Accept-Language'</span><span class="p">:</span> <span class="s">'zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2,mt;q=0.2'</span><span class="p">,</span>
        <span class="s">'Cache-Control'</span><span class="p">:</span> <span class="s">'max-age=0'</span><span class="p">,</span>
        <span class="s">'Connection'</span><span class="p">:</span> <span class="s">'keep-alive'</span><span class="p">,</span>
        <span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'IPLOC=CN1100; SUID=6FEDCF3C541C940A000000005968CF55; SUV=1500041046435211; ABTEST=0|1500041048|v1; SNUID=CEA85AE02A2F7E6EAFF9C1FE2ABEBE6F; weixinIndexVisited=1; JSESSIONID=aaar_m7LEIW-jg_gikPZv; ld=Wkllllllll2BzGMVlllllVOo8cUlllll5G@HbZllll9lllllRklll5@@@@@@@@@@'</span><span class="p">,</span>
        <span class="s">'Host'</span><span class="p">:</span> <span class="s">'weixin.sogou.com'</span><span class="p">,</span>
        <span class="s">'Upgrade-Insecure-Requests'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span>
        <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36'</span>
    <span class="p">}</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ–å·¥ä½œ"""</span>
        <span class="c1"># å…¨å±€æ›´æ–° Headers
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">({</span><span class="s">'query'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">keyword</span><span class="p">,</span> <span class="s">'type'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">start_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># è°ƒåº¦ç¬¬ä¸€ä¸ªè¯·æ±‚
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œå®šä¹‰äº† Spider ç±»ï¼Œè®¾ç½®äº†å¾ˆå¤šå…¨å±€å˜é‡ï¼Œæ¯”å¦‚ keyword è®¾ç½®ä¸º NBAï¼Œheaders å°±æ˜¯è¯·æ±‚å¤´ã€‚åœ¨æµè§ˆå™¨é‡Œç™»å½•è´¦å·ï¼Œç„¶ååœ¨å¼€å‘è€…å·¥å…·é‡Œå°†è¯·æ±‚å¤´å¤åˆ¶å‡ºæ¥ï¼Œè®°å¾—å¸¦ä¸Š Cookie å­—æ®µï¼Œè¿™æ ·æ‰èƒ½çˆ¬å– 100 é¡µçš„å†…å®¹ã€‚ç„¶ååˆå§‹åŒ–äº† Session å’Œ RedisQueue å¯¹è±¡ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨æ¥æ‰§è¡Œè¯·æ±‚å’Œå­˜å‚¨è¯·æ±‚ã€‚</p>

<p>é¦–å…ˆï¼Œstart() æ–¹æ³•å…¨å±€æ›´æ–°äº† headersï¼Œä½¿å¾—æ‰€æœ‰è¯·æ±‚éƒ½èƒ½åº”ç”¨ Cookiesã€‚ç„¶åæ„é€ äº†ä¸€ä¸ªèµ·å§‹ URLï¼šhttp://weixin.sogou.com/weixin?type=2&amp;query=NBA ï¼Œéšåç”¨æ”¹ URL æ„é€ äº†ä¸€ä¸ª WeixinRequest å¯¹è±¡ã€‚å›è°ƒå‡½æ•°æ˜¯ Spider ç±»çš„ parse_index() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å½“è¿™ä¸ªè¯·æ±‚æˆåŠŸä¹‹åå°±ç”¨ parse_index() æ¥å¤„ç†å’Œè§£æã€‚need_proxy å‚æ•°è®¾ç½®ä¸º Trueï¼Œä»£è¡¨æ‰§è¡Œè¿™ä¸ªè¯·æ±‚éœ€è¦ç”¨åˆ°ä»£ç†ã€‚éšåæˆ‘ä»¬è°ƒç”¨äº† RedisQueue çš„ add() æ–¹æ³•ï¼Œå°†è¿™ä¸ªè¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦ã€‚</p>

<h3 id="è°ƒåº¦è¯·æ±‚">è°ƒåº¦è¯·æ±‚</h3>

<p>åŠ å…¥ç¬¬ä¸€ä¸ªè¯·æ±‚ä¹‹åï¼Œè°ƒåº¦å¼€å§‹äº†ã€‚æˆ‘ä»¬é¦–å…ˆä»é˜Ÿåˆ—ä¸­å–å‡ºè¿™ä¸ªè¯·æ±‚ï¼Œå°†å®ƒçš„ç»“æœè§£æå‡ºæ¥ï¼Œç”Ÿæˆæ–°çš„è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åæ‹¿å‡ºæ–°çš„è¯·æ±‚ï¼Œå°†ç»“æœè§£æï¼Œå†ç”Ÿæˆæ–°çš„è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œè¿™æ ·å¾ªç¯å¾€å¤æ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æ²¡æœ‰è¯·æ±‚ï¼Œåˆ™ä»£è¡¨çˆ¬å–ç»“æŸã€‚æˆ‘ä»¬ç”¨ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VALID_STATUSES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    è°ƒåº¦è¯·æ±‚
    :return:
    """</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">callback</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Schedule'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">VALID_STATUSES</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'New Result'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">'articles'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œå®ç°äº†ä¸€ä¸ª schedule() æ–¹æ³•ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯çš„åˆ¤æ–­æ˜¯é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚</p>

<p>å½“é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ pop() æ–¹æ³•å–å‡ºä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè°ƒç”¨ request() æ–¹æ³•æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼Œrequest() æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">ReadTimeout</span><span class="p">,</span> <span class="nb">ConnectionError</span>

<span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
    <span class="s">"""
    æ‰§è¡Œè¯·æ±‚
    :param weixin_request: è¯·æ±‚
    :return: å“åº”
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">need_proxy</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">get_proxy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
                    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span>
                                         <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="nb">ConnectionError</span><span class="p">,</span> <span class="n">ReadTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯å¦éœ€è¦ä»£ç†ï¼Œå¦‚æœéœ€è¦ä»£ç†ï¼Œåˆ™è°ƒç”¨ get_proxy() æ–¹æ³•è·å–ä»£ç†ï¼Œç„¶åè°ƒç”¨ Session çš„ send() æ–¹æ³•æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ã€‚è¿™é‡Œçš„è¯·æ±‚è°ƒç”¨äº† prepare() æ–¹æ³•è½¬åŒ–ä¸º Prepared Requestï¼Œå…·ä½“çš„ç”¨æ³•å¯ä»¥å‚è€ƒ http://docs.python-requests.org/en/master/user/advanced/#prepared-requests ï¼ŒåŒæ—¶è®¾ç½® allow_redirects ä¸º Falseï¼Œtimeout æ˜¯è¯¥è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œæœ€åå“åº”è¿”å›ã€‚</p>

<p>æ‰§è¡Œ request() æ–¹æ³•ä¹‹åä¼šå¾—åˆ°ä¸¤ç§ç»“æœï¼šä¸€ç§æ˜¯ Falseï¼Œå³è¯·æ±‚å¤±è´¥ï¼Œè¿æ¥é”™è¯¯ï¼›å¦ä¸€ç§æ˜¯ Response å¯¹è±¡ï¼Œè¿˜éœ€è¦åˆ¤æ–­çŠ¶æ€ç ï¼Œå¦‚æœçŠ¶æ€ç åˆæ³•ï¼Œé‚£ä¹ˆå°±è¿›è¡Œè§£æï¼Œå¦åˆ™é‡æ–°å°†è¯·æ±‚åŠ å›é˜Ÿåˆ—ã€‚</p>

<p>å¦‚æœçŠ¶æ€ç åˆæ³•ï¼Œè§£æçš„æ—¶å€™å°±ä¼šè°ƒç”¨ WeixinRequest çš„å›è°ƒå‡½æ•°è¿›è¡Œè§£æã€‚æ¯”å¦‚è¿™é‡Œçš„å›è°ƒå‡½æ•°æ˜¯ parse_index()ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>

<span class="k">def</span> <span class="nf">parse_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="s">"""
    è§£æç´¢å¼•é¡µ
    :param response: å“åº”
    :return: æ–°çš„å“åº”
    """</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.news-box .news-list li .txt-box h3 a'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_detail</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">weixin_request</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#sogou_next'</span><span class="p">).</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">weixin_request</span>
</code></pre></div></div>

<p>æ­¤æ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼šä¸€ä»¶äº‹å°±æ˜¯è·å–æœ¬é¡µçš„æ‰€æœ‰å¾®ä¿¡æ–‡ç« é“¾æ¥ï¼Œå¦ä¸€ä»¶äº‹å°±æ˜¯è·å–ä¸‹ä¸€é¡µçš„é“¾æ¥ï¼Œå†æ„é€ æˆ WeixinRequest ä¹‹å yield è¿”å›ã€‚</p>

<p>ç„¶åï¼Œschedule() æ–¹æ³•å°†è¿”å›çš„ç»“æœè¿›è¡Œéå†ï¼Œåˆ©ç”¨ isinstance() æ–¹æ³•åˆ¤æ–­è¿”å›ç»“æœï¼Œå¦‚æœè¿”å›ç»“æœæ˜¯ WeixinRequestï¼Œå°±å°†å…¶é‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚</p>

<p>è‡³æ­¤ï¼Œç¬¬ä¸€æ¬¡å¾ªç¯ç»“æŸã€‚</p>

<p>è¿™æ—¶ while å¾ªç¯ä¼šç»§ç»­æ‰§è¡Œã€‚é˜Ÿåˆ—å·²ç»åŒ…å«ç¬¬ä¸€é¡µå†…å®¹çš„æ–‡ç« è¯¦æƒ…é¡µè¯·æ±‚å’Œä¸‹ä¸€é¡µçš„è¯·æ±‚ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡å¾ªç¯å¾—åˆ°çš„ä¸‹ä¸€ä¸ªè¯·æ±‚å°±æ˜¯æ–‡ç« è¯¦æƒ…é¡µçš„è¯·æ±‚ï¼Œç¨‹åºé‡æ–°è°ƒç”¨ request() æ–¹æ³•è·å–å…¶å“åº”ï¼Œç„¶åè°ƒç”¨å…¶å¯¹åº”çš„å›è°ƒå‡½æ•°è§£æã€‚è¿™æ—¶è¯¦æƒ…é¡µè¯·æ±‚çš„å›è°ƒæ–¹æ³•å°±ä¸åŒäº†ï¼Œè¿™æ¬¡æ˜¯ parse_detail() æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="s">"""
    è§£æè¯¦æƒ…é¡µ
    :param response: å“åº”
    :return: å¾®ä¿¡å…¬ä¼—å·æ–‡ç« 
    """</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_title'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_content'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'date'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#post-date'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'nickname'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; strong'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'wechat'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; p:nth-child(3) &gt; span'</span><span class="p">).</span><span class="n">text</span><span class="p">()}</span>
    <span class="k">yield</span> <span class="n">data</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•è§£æäº†å¾®ä¿¡æ–‡ç« è¯¦æƒ…é¡µçš„å†…å®¹ï¼Œæå–å‡ºå®ƒçš„æ ‡é¢˜ã€æ­£æ–‡æ–‡æœ¬ã€å‘å¸ƒæ—¥æœŸã€å‘å¸ƒäººæ˜µç§°ã€å¾®ä¿¡å…¬ä¼—å·åç§°ï¼Œå°†è¿™äº›ä¿¡æ¯ç»„åˆæˆä¸€ä¸ªå­—å…¸è¿”å›ã€‚</p>

<p>ç»“æœè¿”å›ä¹‹åè¿˜éœ€è¦åˆ¤æ–­ç±»å‹ï¼Œå¦‚æ˜¯å­—å…¸ç±»å‹ï¼Œç¨‹åºå°±è°ƒç”¨ mysql å¯¹è±¡çš„ insert() æ–¹æ³•å°†æ•°æ®å­˜å…¥æ•°æ®åº“ã€‚</p>

<p>è¿™æ ·ï¼Œç¬¬äºŒæ¬¡å¾ªç¯æ‰§è¡Œå®Œæ¯•ã€‚</p>

<p>ç¬¬ä¸‰æ¬¡å¾ªç¯ã€ç¬¬å››æ¬¡å¾ªç¯ï¼Œå¾ªç¯å¾€å¤ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰å„è‡ªçš„å›è°ƒå‡½æ•°ï¼Œç´¢å¼•é¡µè§£æå®Œæ¯•ä¹‹åä¼šç»§ç»­ç”Ÿæˆåç»­è¯·æ±‚ï¼Œè¯¦æƒ…é¡µè§£æå®Œæ¯•ä¹‹åä¼šè¿”å›ç»“æœä»¥ä¾¿å­˜å‚¨ï¼Œç›´åˆ°çˆ¬å–å®Œæ¯•ã€‚</p>

<p>ç°åœ¨ï¼Œæ•´ä¸ªè°ƒåº¦å°±å®Œæˆäº†ã€‚</p>

<p>æˆ‘ä»¬å®Œå–„ä¸€ä¸‹æ•´ä¸ª Spider ä»£ç ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">mysql</span> <span class="kn">import</span> <span class="n">MySQL</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">ReadTimeout</span><span class="p">,</span> <span class="nb">ConnectionError</span>

<span class="k">class</span> <span class="nc">Spider</span><span class="p">():</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s">'http://weixin.sogou.com/weixin'</span>
    <span class="n">keyword</span> <span class="o">=</span> <span class="s">'NBA'</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span><span class="p">,</span>
        <span class="s">'Accept-Encoding'</span><span class="p">:</span> <span class="s">'gzip, deflate'</span><span class="p">,</span>
        <span class="s">'Accept-Language'</span><span class="p">:</span> <span class="s">'zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2,mt;q=0.2'</span><span class="p">,</span>
        <span class="s">'Cache-Control'</span><span class="p">:</span> <span class="s">'max-age=0'</span><span class="p">,</span>
        <span class="s">'Connection'</span><span class="p">:</span> <span class="s">'keep-alive'</span><span class="p">,</span>
        <span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'IPLOC=CN1100; SUID=6FEDCF3C541C940A000000005968CF55; SUV=1500041046435211; ABTEST=0|1500041048|v1; SNUID=CEA85AE02A2F7E6EAFF9C1FE2ABEBE6F; weixinIndexVisited=1; JSESSIONID=aaar\_m7LEIW-jg\_gikPZv; ld=Wkllllllll2BzGMVlllllVOo8cUlllll5G@HbZllll9lllllRklll5@@@@@@@@@@'</span><span class="p">,</span>
        <span class="s">'Host'</span><span class="p">:</span> <span class="s">'weixin.sogou.com'</span><span class="p">,</span>
        <span class="s">'Upgrade-Insecure-Requests'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span>
        <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36'</span>
    <span class="p">}</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">()</span>
    <span class="n">mysql</span> <span class="o">=</span> <span class="n">MySQL</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        ä»ä»£ç†æ± è·å–ä»£ç†
        :return:
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Get Proxy'</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ–å·¥ä½œ"""</span>
        <span class="c1"># å…¨å±€æ›´æ–° Headers
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">({</span><span class="s">'query'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">keyword</span><span class="p">,</span> <span class="s">'type'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">start_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># è°ƒåº¦ç¬¬ä¸€ä¸ªè¯·æ±‚
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="s">"""
        è§£æç´¢å¼•é¡µ
        :param response: å“åº”
        :return: æ–°çš„å“åº”
        """</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.news-box .news-list li .txt-box h3 a'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_detail</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">weixin_request</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#sogou_next'</span><span class="p">).</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">weixin_request</span>

    <span class="k">def</span> <span class="nf">parse_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="s">"""
        è§£æè¯¦æƒ…é¡µ
        :param response: å“åº”
        :return: å¾®ä¿¡å…¬ä¼—å·æ–‡ç« 
        """</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_title'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'content'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_content'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'date'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#post-date'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'nickname'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; strong'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'wechat'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; p:nth-child(3) &gt; span'</span><span class="p">).</span><span class="n">text</span><span class="p">()}</span>
        <span class="k">yield</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
        <span class="s">"""
        æ‰§è¡Œè¯·æ±‚
        :param weixin_request: è¯·æ±‚
        :return: å“åº”
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">need_proxy</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_proxy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
                        <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span>
                                             <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="nb">ConnectionError</span><span class="p">,</span> <span class="n">ReadTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
        <span class="s">"""
        é”™è¯¯å¤„ç†
        :param weixin_request: è¯·æ±‚
        :return:
        """</span>
        <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Request Failed'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span><span class="p">,</span> <span class="s">'Times'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">&lt;</span> <span class="n">MAX_FAILED_TIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è°ƒåº¦è¯·æ±‚
        :return:
        """</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">callback</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Schedule'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">VALID_STATUSES</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'New Result'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">'articles'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        å…¥å£
        :return:
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">spider</span> <span class="o">=</span> <span class="n">Spider</span><span class="p">()</span>
    <span class="n">spider</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
<span class="sb">``</span><span class="err">`</span>

<span class="c1">### MySQL å­˜å‚¨
</span>
<span class="n">æ•´ä¸ªè°ƒåº¦æ¨¡å—å®Œæˆäº†</span><span class="err">ï¼Œ</span><span class="n">ä¸Šé¢è¿˜æ²¡æåŠåˆ°çš„å°±æ˜¯å­˜å‚¨æ¨¡å—</span><span class="err">ï¼Œ</span><span class="n">åœ¨è¿™é‡Œè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª</span> <span class="n">MySQL</span> <span class="n">ç±»ä¾›å­˜å‚¨æ•°æ®</span><span class="err">ï¼Œ</span><span class="n">å®ç°å¦‚ä¸‹</span><span class="err">ï¼š</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="s">'foobared'</span>
<span class="n">REDIS_KEY</span> <span class="o">=</span> <span class="s">'weixin'</span>

<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">MySQL</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">MYSQL_HOST</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">MYSQL_USER</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">MYSQL_PASSWORD</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">MYSQL_PORT</span><span class="p">,</span>
                 <span class="n">database</span><span class="o">=</span><span class="n">MYSQL_DATABASE</span><span class="p">):</span>
        <span class="s">"""
        MySQL åˆå§‹åŒ–
        :param host:
        :param username:
        :param password:
        :param port:
        :param database:
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">MySQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""
        æ’å…¥æ•°æ®
        :param table:
        :param data:
        :return:
        """</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">'% s'</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="s">'insert into % s (% s) values (% s)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">MySQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>
</code></pre></div></div>

<p>__init__() æ–¹æ³•åˆå§‹åŒ–äº† MySQL è¿æ¥ï¼Œéœ€è¦ MySQL çš„ç”¨æˆ·ã€å¯†ç ã€ç«¯å£ã€æ•°æ®åº“åç­‰ä¿¡æ¯ã€‚æ•°æ®åº“åä¸º weixinï¼Œéœ€è¦è‡ªå·±åˆ›å»ºã€‚</p>

<p>insert() æ–¹æ³•ä¼ å…¥è¡¨åå’Œå­—å…¸å³å¯åŠ¨æ€æ„é€  SQLï¼Œåœ¨ 5.2 èŠ‚ä¸­ä¹Ÿæœ‰è®²åˆ°ï¼ŒSQL æ„é€ ä¹‹åæ‰§è¡Œå³å¯æ’å…¥æ•°æ®ã€‚</p>

<h1 id="æˆ‘ä»¬è¿˜éœ€è¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®è¡¨è¡¨åä¸º-articleså»ºè¡¨çš„-sql-è¯­å¥å¦‚ä¸‹vent-idè¿”å›è®¾å¤‡å½“å‰ç¬æ—¶æ•°æ®ä¿¡æ¯">æˆ‘ä»¬è¿˜éœ€è¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®è¡¨ï¼Œè¡¨åä¸º articlesï¼Œå»ºè¡¨çš„ SQL è¯­å¥å¦‚ä¸‹ï¼švent-idï¼Œè¿”å›è®¾å¤‡å½“å‰ç¬æ—¶æ•°æ®ä¿¡æ¯</h1>
<hr />
<p>layout: post
title: ä»£ç†
subtitle: 
author: Balbo Cheng
categories: python
tags: [reptile]
â€”</p>
<h2 id="ä»£ç†çš„è®¾ç½®-1">ä»£ç†çš„è®¾ç½®</h2>

<h3 id="è·å–ä»£ç†-1">è·å–ä»£ç†</h3>

<p>åœ¨åšæµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·å–ä¸€ä¸ªå¯ç”¨ä»£ç†ï¼Œæœç´¢å¼•æ“æœç´¢â€œä»£ç†â€å…³é”®å­—ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ‰è®¸å¤šä»£ç†æœåŠ¡ç½‘ç«™ï¼Œåœ¨ç½‘ç«™ä¸Šä¼šæœ‰å¾ˆå¤šå…è´¹ä»£ç†ï¼Œæ¯”å¦‚è¥¿åˆºï¼šhttp://www.xicidaili.com/ ï¼Œè¿™é‡Œåˆ—å‡ºäº†å¾ˆå¤šå…è´¹ä»£ç†ï¼Œä½†æ˜¯è¿™äº›å…è´¹ä»£ç†å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä¸å¥½ç”¨çš„ï¼Œæ‰€ä»¥æ¯”è¾ƒé è°±çš„æ–¹æ³•æ˜¯è´­ä¹°ä»˜è´¹ä»£ç†ï¼Œå¾ˆå¤šç½‘ç«™éƒ½æœ‰å”®å–ï¼Œæ•°é‡ä¸ç”¨å¤šï¼Œä¹°ä¸€ä¸ªç¨³å®šå¯ç”¨çš„å³å¯ï¼Œå¯ä»¥è‡ªè¡Œé€‰è´­ã€‚</p>

<p>æˆ–è€…å¦‚æœæˆ‘ä»¬æœ¬æœºæœ‰ç›¸å…³ä»£ç†è½¯ä»¶çš„è¯ï¼Œè½¯ä»¶ä¸€èˆ¬ä¼šåœ¨æœ¬æœºåˆ›å»º HTTP æˆ– SOCKS ä»£ç†æœåŠ¡ï¼Œç›´æ¥ä½¿ç”¨æ­¤ä»£ç†ä¹Ÿå¯ä»¥ã€‚</p>

<h3 id="urllib-1">urllib</h3>
<p>é¦–å…ˆæˆ‘ä»¬ä»¥æœ€åŸºç¡€çš„ urllib ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹ä»£ç†çš„è®¾ç½®æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ProxyHandler</span><span class="p">,</span> <span class="n">build_opener</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">ProxyHandler</span><span class="p">({</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
    "Accept-Encoding": "identity", 
    "Connection": "close", 
    "Host": "httpbin.org", 
   "User-Agent": "Python-urllib/3.6"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>è¿è¡Œè¾“å‡ºç»“æœæ˜¯ä¸€ä¸ª Jsonï¼Œå®ƒæœ‰ä¸€ä¸ªå­—æ®µ originï¼Œæ ‡æ˜äº†å®¢æˆ·ç«¯çš„ IPï¼Œæ­¤å¤„çš„ IP éªŒè¯ä¸€ä¸‹ï¼Œç¡®å®ä¸ºä»£ç†çš„ IPï¼Œè€Œå¹¶ä¸æ˜¯æˆ‘ä»¬çœŸå®çš„ IPï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸè®¾ç½®å¥½ä»£ç†ï¼Œå¹¶å¯ä»¥éšè—çœŸå® IP äº†ã€‚</p>

<p>å¦‚æœé‡åˆ°éœ€è¦è®¤è¯çš„ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„æ–¹æ³•è®¾ç½®ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ProxyHandler</span><span class="p">,</span> <span class="n">build_opener</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
<span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">ProxyHandler</span><span class="p">({</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>å¦‚æœä»£ç†æ˜¯ SOCKS5 ç±»å‹ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼è®¾ç½®ä»£ç†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div></div>

<p>æ­¤å¤„éœ€è¦ä¸€ä¸ª Socks æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install PySocks
</code></pre></div></div>

<h3 id="requests-2">requests</h3>

<p>å¯¹äº Requests æ¥è¯´ï¼Œä»£ç†è®¾ç½®æ›´åŠ ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ proxies å‚æ•°å³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
   
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
   "Accept": "*/*", 
   "Accept-Encoding": "gzip, deflate", 
   "Connection": "close", 
   "Host": "httpbin.org", 
   "User-Agent": "python-requests/2.18.1"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>å¦‚æœä»£ç†éœ€è¦è®¤è¯ï¼ŒåŒæ ·åœ¨ä»£ç†çš„å‰é¢åŠ ä¸Šç”¨æˆ·åå¯†ç å³å¯ï¼Œä»£ç†çš„å†™æ³•å°±å˜æˆï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
</code></pre></div></div>

<p>å¦‚æœéœ€è¦ä½¿ç”¨ SOCKS5 ä»£ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
    
proxy = '127.0.0.1:9742'
proxies = {
    'http': 'socks5://' + proxy,
    'https': 'socks5://' + proxy
}
try:
    response = requests.get('http://httpbin.org/get', proxies=proxies)
    print(response.text)
except requests.exceptions.ConnectionError as e:
    print('Error', e.args)
</code></pre></div></div>

<p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ª Socks æ¨¡å—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install "requests[socks]"
</code></pre></div></div>

<p>å¦å¤–è¿˜æœ‰ä¸€ç§è®¾ç½®æ–¹å¼ï¼Œå’Œ Urllib ä¸­çš„æ–¹æ³•ç›¸åŒï¼Œä½¿ç”¨ socks æ¨¡å—ï¼Œä¹Ÿéœ€è¦åƒä¸Šæ–‡ä¸€æ ·å®‰è£…è¯¥åº“ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
   <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™æ ·ä¹Ÿå¯ä»¥è®¾ç½® SOCKS5 ä»£ç†ï¼Œè¿è¡Œç»“æœå®Œå…¨ç›¸åŒï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å…¨å±€è®¾ç½®ï¼Œä¸åŒæƒ…å†µå¯ä»¥é€‰ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>

<h3 id="requests-3">requests</h3>

<p>å¯¹äº Requests æ¥è¯´ï¼Œä»£ç†è®¾ç½®æ›´åŠ ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ proxies å‚æ•°å³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
   
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "args": {}, 
  "headers": {
   "Accept": "*/*", 
   "Accept-Encoding": "gzip, deflate", 
   "Connection": "close", 
   "Host": "httpbin.org", 
   "User-Agent": "python-requests/2.18.1"
  }, 
  "origin": "106.185.45.153", 
  "url": "http://httpbin.org/get"
}
</code></pre></div></div>

<p>å¦‚æœä»£ç†éœ€è¦è®¤è¯ï¼ŒåŒæ ·åœ¨ä»£ç†çš„å‰é¢åŠ ä¸Šç”¨æˆ·åå¯†ç å³å¯ï¼Œä»£ç†çš„å†™æ³•å°±å˜æˆï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxy</span> <span class="o">=</span> <span class="s">'username:password@127.0.0.1:9743'</span>
</code></pre></div></div>

<p>å¦‚æœéœ€è¦ä½¿ç”¨ SOCKS5 ä»£ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
    
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9742'</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ª Socks æ¨¡å—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install "requests[socks]"
</code></pre></div></div>

<p>å¦å¤–è¿˜æœ‰ä¸€ç§è®¾ç½®æ–¹å¼ï¼Œå’Œ Urllib ä¸­çš„æ–¹æ³•ç›¸åŒï¼Œä½¿ç”¨ socks æ¨¡å—ï¼Œä¹Ÿéœ€è¦åƒä¸Šæ–‡ä¸€æ ·å®‰è£…è¯¥åº“ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
    
<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
   <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™æ ·ä¹Ÿå¯ä»¥è®¾ç½® SOCKS5 ä»£ç†ï¼Œè¿è¡Œç»“æœå®Œå…¨ç›¸åŒï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å…¨å±€è®¾ç½®ï¼Œä¸åŒæƒ…å†µå¯ä»¥é€‰ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>

<h3 id="selenium-1">Selenium</h3>

<ul>
  <li>
    <p>chrome</p>

    <p>å¯¹äº Chrome æ¥è¯´ï¼Œç”¨ Selenium è®¾ç½®ä»£ç†çš„æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
        
<span class="n">proxy</span> <span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--proxy-server=http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">chrome_options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>è¿è¡Œç»“æœï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
"args": {}, 
"headers": {
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8", 
   "Accept-Encoding": "gzip, deflate", 
     "Accept-Language": "zh-CN,zh;q=0.8", 
     "Connection": "close", 
     "Host": "httpbin.org", 
     "Upgrade-Insecure-Requests": "1", 
     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"
}, 
"origin": "106.185.45.153", 
"url": "http://httpbin.org/get"
}
</code></pre></div>    </div>

    <p>å¦‚æœä»£ç†æ˜¯è®¤è¯ä»£ç†ï¼Œåˆ™è®¾ç½®æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.chrome.options</span> <span class="kn">import</span> <span class="n">Options</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
        
<span class="n">ip</span> <span class="o">=</span> <span class="s">'127.0.0.1'</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">9743</span>
<span class="n">username</span> <span class="o">=</span> <span class="s">'foo'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'bar'</span>
        
<span class="n">manifest_json</span> <span class="o">=</span> <span class="s">"""
{
    "version": "1.0.0",
    "manifest_version": 2,
    "name": "Chrome Proxy",
    "permissions": [
       "proxy",
       "tabs",
       "unlimitedStorage",
       "storage",
       "&lt;all_urls&gt;",
       "webRequest",
       "webRequestBlocking"
    ],
     "background": {
     "scripts": ["background.js"]
     }
}
        
background_js = """</span>
<span class="n">var</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">mode</span><span class="p">:</span> <span class="s">"fixed_servers"</span><span class="p">,</span>
        <span class="n">rules</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">singleProxy</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">scheme</span><span class="p">:</span> <span class="s">"http"</span><span class="p">,</span>
            <span class="n">host</span><span class="p">:</span> <span class="s">"%(ip)s"</span><span class="p">,</span>
            <span class="n">port</span><span class="p">:</span> <span class="o">%</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="n">s</span>
        <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
            
          <span class="n">chrome</span><span class="p">.</span><span class="n">proxy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="nb">set</span><span class="p">({</span><span class="n">value</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="s">"regular"</span><span class="p">},</span> <span class="n">function</span><span class="p">()</span> <span class="p">{});</span>
            
          <span class="n">function</span> <span class="n">callbackFn</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="p">{</span>
                  <span class="n">authCredentials</span><span class="p">:</span> <span class="p">{</span>
                      <span class="n">username</span><span class="p">:</span> <span class="s">"%(username)s"</span><span class="p">,</span>
                      <span class="n">password</span><span class="p">:</span> <span class="s">"%(password)s"</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
            
          <span class="n">chrome</span><span class="p">.</span><span class="n">webRequest</span><span class="p">.</span><span class="n">onAuthRequired</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span>
                      <span class="n">callbackFn</span><span class="p">,</span>
                      <span class="p">{</span><span class="n">urls</span><span class="p">:</span> <span class="p">[</span><span class="s">"&lt;all_urls&gt;"</span><span class="p">]},</span>
                      <span class="p">[</span><span class="s">'blocking'</span><span class="p">]</span>
          <span class="p">)</span>
          <span class="s">""" % {'ip': ip, 'port': port, 'username': username, 'password': password}
            
          plugin_file = 'proxy_auth_plugin.zip'
          with zipfile.ZipFile(plugin_file, 'w') as zp:
              zp.writestr("manifest.json", manifest_json)
              zp.writestr("background.js", background_js)
          chrome_options = Options()
          chrome_options.add_argument("--start-maximized")
          chrome_options.add_extension(plugin_file)
          browser = webdriver.Chrome(chrome_options=chrome_options)
          browser.get('http://httpbin.org/get')
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>PhantomJS</p>

    <p>å¯¹äº PhantomJSï¼Œä»£ç†è®¾ç½®æ–¹æ³•å¯ä»¥å€ŸåŠ©äº service_args å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œä»£ç†è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
  
<span class="n">service_args</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'--proxy=127.0.0.1:9743'</span><span class="p">,</span>
    <span class="s">'--proxy-type=http'</span>
<span class="p">]</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">(</span><span class="n">service_args</span><span class="o">=</span><span class="n">service_args</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">page_source</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>è¿è¡Œç»“æœï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "args": {},
    "headers": {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,en,*",
        "Connection": "close",
        "Host": "httpbin.org",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.0 Safari/538.1"
    },
    "origin": "106.185.45.153",
    "url": "http://httpbin.org/get"
}
</code></pre></div>    </div>

    <p>å¦‚æœéœ€è¦è®¤è¯ï¼Œé‚£ä¹ˆåªéœ€è¦å†åŠ å…¥ â€“proxy-auth é€‰é¡¹å³å¯ï¼Œè¿™æ ·å‚æ•°å°±æ”¹ä¸ºï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service_args = [
      '--proxy=127.0.0.1:9743',
      '--proxy-type=http',
      '--proxy-auth=username:password'
  ]
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="ä»£ç†æ± çš„ç»´æŠ¤-1">ä»£ç†æ± çš„ç»´æŠ¤</h2>

<h3 id="ä»£ç†æ± çš„ç›®æ ‡-1">ä»£ç†æ± çš„ç›®æ ‡</h3>

<p>ä»£ç†æ± è¦åšåˆ°æ˜“ç”¨ã€é«˜æ•ˆï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦åšåˆ°ä¸‹é¢çš„å‡ ä¸ªç›®æ ‡ï¼š</p>

<ul>
  <li>åŸºæœ¬æ¨¡å—åˆ†ä¸ºå››å—ï¼Œè·å–æ¨¡å—ã€å­˜å‚¨æ¨¡å—ã€æ£€æŸ¥æ¨¡å—ã€æ¥å£æ¨¡å—ã€‚
    <ul>
      <li>è·å–æ¨¡å—éœ€è¦å®šæ—¶å»å„å¤§ä»£ç†ç½‘ç«™æŠ“å–ä»£ç†ï¼Œä»£ç†å¯ä»¥æ˜¯å…è´¹å…¬å¼€ä»£ç†ä¹Ÿå¯ä»¥æ˜¯ä»˜è´¹ä»£ç†ï¼Œä»£ç†çš„å½¢å¼éƒ½æ˜¯ IP åŠ ç«¯å£ï¼Œå°½é‡ä»ä¸åŒæ¥æºè·å–ï¼Œå°½é‡æŠ“å–é«˜åŒ¿ä»£ç†ï¼ŒæŠ“å–å®Œä¹‹åå°†å¯ç”¨ä»£ç†ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</li>
      <li>å­˜å‚¨æ¨¡å—è´Ÿè´£å­˜å‚¨æŠ“å–ä¸‹æ¥çš„ä»£ç†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿è¯ä»£ç†ä¸é‡å¤ï¼Œå¦å¤–æˆ‘ä»¬è¿˜éœ€è¦æ ‡è¯†ä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œè€Œä¸”éœ€è¦åŠ¨æ€å®æ—¶å¤„ç†æ¯ä¸ªä»£ç†ï¼Œæ‰€ä»¥è¯´ï¼Œä¸€ç§æ¯”è¾ƒé«˜æ•ˆå’Œæ–¹ä¾¿çš„å­˜å‚¨æ–¹å¼å°±æ˜¯ä½¿ç”¨ Redis çš„ Sorted Setï¼Œä¹Ÿå°±æ˜¯æœ‰åºé›†åˆã€‚</li>
      <li>æ£€æµ‹æ¨¡å—éœ€è¦å®šæ—¶å°†æ•°æ®åº“ä¸­çš„ä»£ç†è¿›è¡Œæ£€æµ‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæ£€æµ‹é“¾æ¥ï¼Œæœ€å¥½æ˜¯çˆ¬å–å“ªä¸ªç½‘ç«™å°±æ£€æµ‹å“ªä¸ªç½‘ç«™ï¼Œè¿™æ ·æ›´åŠ æœ‰é’ˆå¯¹æ€§ï¼Œå¦‚æœè¦åšä¸€ä¸ªé€šç”¨å‹çš„ä»£ç†ï¼Œé‚£å¯ä»¥è®¾ç½®ç™¾åº¦ç­‰é“¾æ¥æ¥æ£€æµ‹ã€‚å¦å¤–æˆ‘ä»¬éœ€è¦æ ‡è¯†æ¯ä¸€ä¸ªä»£ç†çš„çŠ¶æ€ï¼Œå¦‚è®¾ç½®åˆ†æ•°æ ‡è¯†ï¼Œ100 åˆ†ä»£è¡¨å¯ç”¨ï¼Œåˆ†æ•°è¶Šå°‘ä»£è¡¨è¶Šä¸å¯ç”¨ï¼Œæ£€æµ‹ä¸€æ¬¡å¦‚æœå¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç«‹å³è®¾ç½®ä¸º100 æ»¡åˆ†ï¼Œä¹Ÿå¯ä»¥åœ¨åŸåŸºç¡€ä¸ŠåŠ  1 åˆ†ï¼Œå½“ä¸å¯ç”¨ï¼Œå¯ä»¥å°†å…¶å‡ 1 åˆ†ï¼Œå½“å‡åˆ°ä¸€å®šé˜ˆå€¼åå°±ç›´æ¥ä»æ•°æ®åº“ç§»é™¤ã€‚é€šè¿‡è¿™æ ·çš„æ ‡è¯†åˆ†æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒºåˆ†å‡ºä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œé€‰ç”¨çš„æ—¶å€™ä¼šæ›´æœ‰é’ˆå¯¹æ€§ã€‚</li>
      <li>æ¥å£æ¨¡å—éœ€è¦ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿æ•°æ®åº“æ¥å–ï¼Œä½†æ˜¯è¿™æ ·å°±éœ€è¦çŸ¥é“æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ï¼Œä¸å¤ªå®‰å…¨ï¼Œè€Œä¸”éœ€è¦é…ç½®è¿æ¥ï¼Œæ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒå®‰å…¨å’Œæ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯æä¾›ä¸€ä¸ª Web API æ¥å£ï¼Œé€šè¿‡è®¿é—®æ¥å£å³å¯æ‹¿åˆ°å¯ç”¨ä»£ç†ã€‚å¦å¤–ç”±äºå¯ç”¨ä»£ç†å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬å¯ä»¥æä¾›éšæœºè¿”å›ä¸€ä¸ªå¯ç”¨ä»£ç†çš„æ¥å£ï¼Œè¿™æ ·ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½å¯ä»¥å–åˆ°ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="ä»£ç†æ± çš„æ¶æ„-1">ä»£ç†æ± çš„æ¶æ„</h3>

<p>ä»£ç†æ± åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œè·å–æ¨¡å—ã€å­˜å‚¨æ¨¡å—ã€æ£€æµ‹æ¨¡å—ã€æ¥å£æ¨¡å—ã€‚</p>

<ul>
  <li>å­˜å‚¨æ¨¡å—ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œç”¨æ¥åšä»£ç†çš„å»é‡å’ŒçŠ¶æ€æ ‡è¯†ï¼ŒåŒæ—¶ä»–ä¹Ÿæ˜¯ä¸­å¿ƒæ¨¡å—å’ŒåŸºç¡€æ¨¡å—ï¼Œå°†å…¶ä»–æ¨¡å—ä¸²è”èµ·æ¥</li>
  <li>è·å–æ¨¡å—å®šæ—¶ä»ä»£ç†ç½‘ç«™è·å–ä»£ç†ï¼Œå°†è·å–çš„ä»£ç†ä¼ é€’ç»™å­˜å‚¨æ¨¡å—ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“</li>
  <li>æ£€æµ‹æ¨¡å—å®šæ—¶é€šè¿‡å­˜å‚¨æ¨¡å—è·å–æ‰€æœ‰ä»£ç†ï¼Œå¹¶å¯¹ä»£ç†è¿›è¡Œæ£€æµ‹ï¼Œæ ¹æ®ä¸åŒçš„æ£€æµ‹ç»“æœå¯¹ä»£ç†è®¾ç½®ä¸åŒçš„æ ‡è¯†</li>
  <li>æ¥å£æ¨¡å—é€šè¿‡ Web API æä¾›æœåŠ¡æ¥å£ï¼Œæ¥å£é€šè¿‡é“¾æ¥æ•°æ®åº“å¹¶é€šè¿‡ Web å½¢å¼è¿”å›å¯ç”¨çš„ä»£ç†</li>
</ul>

<h3 id="ä»£ç†æ± çš„å®ç°-1">ä»£ç†æ± çš„å®ç°</h3>

<ul>
  <li>
    <p>å­˜å‚¨æ¨¡å—</p>

    <p>å­˜å‚¨åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„ï¼Œå¯¹äºä»£ç†ä»£ç†æ± æ¥è¯´ï¼Œé›†åˆçš„å…ƒç´ å°±å˜æˆäº†ä¸€ä¸ªä¸ªä»£ç†ï¼Œä¹Ÿå°±æ˜¯ IP åŠ ç«¯å£çš„å½¢å¼ï¼Œå¦‚ 60.207.237.111:8888ï¼Œè¿™æ ·çš„ä¸€ä¸ªä»£ç†å°±æ˜¯é›†åˆçš„ä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æœ‰åºé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ è¿˜éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°å­—æ®µï¼Œåˆ†æ•°æ˜¯å¯ä»¥é‡å¤çš„ï¼Œæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•´æ•°ç±»å‹ã€‚è¯¥é›†åˆä¼šæ ¹æ®æ¯ä¸€ä¸ªå…ƒç´ çš„åˆ†æ•°å¯¹é›†åˆè¿›è¡Œæ’åºï¼Œæ•°å€¼å°çš„æ’åœ¨å‰é¢ï¼Œæ•°å€¼å¤§çš„æ’åœ¨åé¢ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°é›†åˆå…ƒç´ çš„æ’åºäº†ã€‚</p>

    <p>å¯¹äºä»£ç†æ± æ¥è¯´ï¼Œè¿™ä¸ªåˆ†æ•°å¯ä»¥ä½œä¸ºæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸ªä»£ç†å¯ç”¨ä¸å¯ç”¨çš„æ ‡å¿—ï¼Œæˆ‘ä»¬å°† 100 è®¾ä¸ºæœ€é«˜åˆ†ï¼Œä»£è¡¨å¯ç”¨ï¼Œ0 è®¾ä¸ºæœ€ä½åˆ†ï¼Œä»£è¡¨ä¸å¯ç”¨ã€‚ä»ä»£ç†æ± ä¸­è·å–ä»£ç†çš„æ—¶å€™ä¼šéšæœºè·å–åˆ†æ•°æœ€é«˜çš„ä»£ç†ï¼Œæ³¨æ„è¿™é‡Œæ˜¯éšæœºï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½ä¼šè¢«è°ƒç”¨åˆ°ã€‚</p>

    <ul>
      <li>åˆ†æ•° 100 ä¸ºå¯ç”¨ï¼Œæ£€æµ‹å™¨ä¼šå®šæ—¶å¾ªç¯æ£€æµ‹æ¯ä¸ªä»£ç†å¯ç”¨æƒ…å†µï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰å¯ç”¨çš„ä»£ç†å°±ç«‹å³ç½®ä¸º 100ï¼Œæ£€æµ‹åˆ°ä¸å¯ç”¨å°±å°†åˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åä»£ç†ç§»é™¤</li>
      <li>æ–°è·å–çš„ä»£ç†çš„åˆ†æ•°ä¸º10ï¼Œå¦‚æœæµ‹è¯•å¯è¡Œï¼Œåˆ†æ•°ç«‹å³ç½®ä¸º100ï¼Œä¸å¯è¡Œåˆ™åˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åä»£ç†ç§»é™¤</li>
    </ul>

    <p>è¿™åªæ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå½“ç„¶å¯èƒ½è¿˜æœ‰åˆç†çš„æ–¹æ¡ˆï¼Œä¹‹æ‰€ä»¥è®¾ç½®æ­¤æ–¹æ¡ˆæœ‰å¦‚ä¸‹å‡ ä¸ªåŸå› ï¼š</p>

    <ul>
      <li>åœ¨æ£€æµ‹åˆ°ä»£ç†å¯ç”¨æ—¶ï¼Œåˆ†æ•°ç«‹å³ç½®ä¸º100ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰å¯ç”¨ä»£ç†æœ‰æ›´å¤§çš„æœºä¼šè¢«è·å–åˆ°ã€‚ä¸ºä»€ä¹ˆä¸å°†åˆ†æ•°åŠ 1è€Œæ˜¯ç›´æ¥è®¾ä¸ºæœ€é«˜100å‘¢ï¼Ÿæœ‰ç‚¹ä»£ç†æ˜¯ä»å„å¤§å…è´¹å…¬å¼€ä»£ç†ç½‘ç«™è·å–çš„ï¼Œå¸¸å¸¸ä¸€ä¸ªä»£ç†å¹¶æ²¡æœ‰é‚£ä¹ˆç¨³å®šï¼Œå¹³å‡5æ¬¡è¯·æ±‚å¯èƒ½æœ‰2æ¬¡æˆåŠŸï¼Œ3æ¬¡å¤±è´¥ï¼Œå¦‚æœæŒ‰ç…§è¿™ç§åˆ†æ•°æ¥è®¾ç½®åˆ†æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªä»£ç†å‡ ä¹ä¸å¯èƒ½è¾¾åˆ°ä¸€ä¸ªé«˜çš„åˆ†æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä¾¿ä»–æœ‰æ—¶æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯ç­›é€‰çš„åˆ†æ•°æœ€é«˜ï¼Œé‚£è¿™æ ·çš„ä»£ç†å‡ ä¹ä¸å¯èƒ½è¢«å–åˆ°ã€‚å¦‚æœæƒ³è¿½æ±‚ä»£ç†ç¨³å®šæ€§ï¼Œå¯ç”¨ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å¯ç¡®ä¿åˆ†æ•°æœ€é«˜çš„ä»£ç†ä¸€å®šæ˜¯æœ€ç¨³å®šå¯ç”¨çš„ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡å–â€œå¯ç”¨å³è®¾ç½®ä¸º100â€çš„æ–¹æ³•ï¼Œç¡®ä¿åªè¦å¯ç”¨çš„ä»£ç†éƒ½å¯ä»¥è¢«è·å–</li>
      <li>åœ¨æ£€æµ‹åˆ°ä»£ç†ä¸å¯ç”¨æ—¶ï¼Œåˆ†æ•°å‡1ï¼Œåˆ†æ•°å‡è‡³0åï¼Œä»£ç†ç§»é™¤ã€‚è¿™æ ·ä¸€ä¸ªæœ‰æ•ˆä»£ç†å¦‚æœè¦è¢«ç§»é™¤éœ€è¦è¿ç»­ä¸æ–­å¤±è´¥100æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªå¯ç”¨ä»£ç†å¦‚æœå°è¯•äº†100æ¬¡éƒ½å¤±è´¥äº†ï¼Œå°±ä¸€ç›´å‡åˆ†çŸ¥é“ç§»é™¤ï¼Œä¸€æ—¦æˆåŠŸå°±é‡æ–°ç½®å›100ã€‚å°è¯•çš„æœºä¼šè¶Šå¤šï¼Œåˆ™è¿™ä¸ªä»£ç†æ‹¯æ•‘å›æ¥çš„æœºä¼šè¶Šå¤šï¼Œè¿™æ ·å°±ä¸å®¹æ˜“å°†æ›¾ç»ä¸€ä¸ªå¯ç”¨ä»£ç†ä¸¢å¼ƒï¼Œä»¥ä¸ºä»£ç†ä¸å¯ç”¨çš„åŸå› å¯èƒ½æ—¶ç½‘ç»œç¹å¿™æˆ–è€…å…¶ä»–äººç”¨æ­¤ä»£ç†è¿‡äºé¢‘ç¹ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸º100</li>
      <li>æ–°è·å–çš„ä»£ç†çš„åˆ†æ•°è®¾ç½®ä¸º10.ç”±äºå¾ˆå¤šä»£ç†æ˜¯ä»å…è´¹ç½‘ç«™è·å–çš„ï¼Œæ‰€ä»¥æ–°è·å–çš„ä»£ç†æ— æ•ˆçš„æ¯”ä¾‹éå¸¸é«˜ï¼Œå¯èƒ½å¯ç”¨çš„ä»£ç†ä¸è¶³ 10%ã€‚æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°†åˆ†æ•°è®¾ç½®ä¸º10ï¼Œæ£€æµ‹çš„æœºä¼šæ²¡æœ‰å¯ç”¨ä»£ç†çš„100æ­¤é‚£ä¹ˆå¤šï¼Œè¿™ä¹Ÿå¯ä»¥é€‚å½“å‡å°‘å¼€é”€</li>
    </ul>

    <p>æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å®šä¹‰ä¸€ä¸ªç±»æ¥æ“ä½œæ•°æ®åº“çš„æœ‰åºé›†åˆï¼Œå®šä¹‰ä¸€äº›æ–¹æ³•æ¥å®ç°åˆ†æ•°çš„è®¾ç½®ï¼Œä»£ç†çš„è·å–ç­‰ç­‰ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MAX_SCORE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">MIN_SCORE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">INITIAL_SCORE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">REDIS_KEY</span> <span class="o">=</span> <span class="s">'proxies'</span>
  
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
  
  
<span class="k">class</span> <span class="nc">RedisClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ–
        :param host: Redis åœ°å€
        :param port: Redis ç«¯å£
        :param password: Rediså¯†ç 
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">INITIAL_SCORE</span><span class="p">):</span>
        <span class="s">"""
        æ·»åŠ ä»£ç†ï¼Œè®¾ç½®åˆ†æ•°ä¸ºæœ€é«˜
        :param proxy: ä»£ç†
        :param score: åˆ†æ•°
        :return: æ·»åŠ ç»“æœ
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zadd</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        éšæœºè·å–æœ‰æ•ˆä»£ç†ï¼Œé¦–å…ˆå°è¯•è·å–æœ€é«˜åˆ†æ•°ä»£ç†ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ŒæŒ‰ç…§æ’åè·å–ï¼Œå¦åˆ™å¼‚å¸¸
        :return: éšæœºä»£ç†
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrangebyscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">choice</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrevrange</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">choice</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PoolEmptyError</span>
  
    <span class="k">def</span> <span class="nf">decrease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        ä»£ç†å€¼å‡ä¸€åˆ†ï¼Œå°äºæœ€å°å€¼åˆ™åˆ é™¤
        :param proxy: ä»£ç†
        :return: ä¿®æ”¹åçš„ä»£ç†åˆ†æ•°
        """</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">MIN_SCORE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å½“å‰åˆ†æ•°'</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="s">'å‡1'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zincrby</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å½“å‰åˆ†æ•°'</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="s">'ç§»é™¤'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrem</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        :param proxy: ä»£ç†
        :return: æ˜¯å¦å­˜åœ¨
        """</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span>
  
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        å°†ä»£ç†è®¾ç½®ä¸ºMAX_SCORE
        :param proxy: ä»£ç†
        :return: è®¾ç½®ç»“æœ
        """</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s">'å¯ç”¨ï¼Œè®¾ç½®ä¸º'</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zadd</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ•°é‡
        :return: æ•°é‡
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zcard</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–å…¨éƒ¨ä»£ç†
        :return: å…¨éƒ¨ä»£ç†åˆ—è¡¨
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">zrangebyscore</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">MIN_SCORE</span><span class="p">,</span> <span class="n">MAX_SCORE</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ª RedisClient ç±»ï¼Œç”¨ä»¥æ“ä½œ Redis çš„æœ‰åºé›†åˆï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€äº›æ–¹æ³•æ¥å¯¹é›†åˆä¸­çš„å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

    <ul>
      <li>__init__() æ–¹æ³•æ˜¯åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ Redis çš„è¿æ¥ä¿¡æ¯ï¼Œé»˜è®¤çš„è¿æ¥ä¿¡æ¯å·²ç»å®šä¹‰ä¸ºå¸¸é‡ï¼Œåœ¨ __init__() æ–¹æ³•ç§åˆå§‹åŒ–ä¸€ä¸ª StrictRedis çš„ç±»ï¼Œå»ºç«‹ Redis è¿æ¥</li>
      <li>add() æ–¹æ³•å‘æ•°æ®åº“æ·»åŠ ä»£ç†å¹¶è®¾ç½®åˆ†æ•°ï¼Œé»˜è®¤çš„åˆ†æ•°æ˜¯ INITIAL_SCOREï¼Œä¹Ÿå°±æ˜¯10ï¼Œè¿”å›ç»“æœæ˜¯æ·»åŠ ä»£ç†çš„æ•°é‡</li>
      <li>random() æ–¹æ³•æ˜¯éšæœºè·å–ä»£ç†çš„æ–¹æ³•ï¼Œé¦–å…ˆè·å–100åˆ†çš„ä»£ç†ï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªè¿”å›ã€‚å¦‚æœä¸å­˜åœ¨100åˆ†çš„ä»£ç†ï¼Œåˆ™æ­¤æ–¹æ³•æŒ‰ç…§æ’åæ¥è·å–ï¼Œé€‰å–å‰100åï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªè¿”å›ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</li>
      <li>
        <p>decrease() æ–¹æ³•æ˜¯åœ¨ä»£ç†æ£€æµ‹æ— æ•ˆçš„æ—¶å€™è®¾ç½®åˆ†æ•°å‡1çš„æ–¹æ³•ï¼Œä»£ç†ä¼ å…¥é¦–ï¼Œæ­¤æ–¹æ³•å°†ä»£ç†çš„åˆ†æ•°å‡1ï¼Œå¦‚æœåˆ†æ•°è¾¾åˆ°æœ€ä½å€¼ï¼Œé‚£ä¹ˆä»£ç†å°±åˆ é™¤</p>
      </li>
      <li>è·å–æ¨¡å—</li>
    </ul>

    <p>è·å–æ¨¡å—çš„é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ª Crawler æ¥ä»å„å¤§ç½‘ç«™æŠ“å–ä»£ç†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_page</span>
<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
  
<span class="k">class</span> <span class="nc">ProxyMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFunc__'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">'crawl_'</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFunc__'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__CrawlFuncCount__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
  
<span class="k">class</span> <span class="nc">Crawler</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ProxyMetaclass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="s">"self.{}()"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">callback</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸè·å–åˆ°ä»£ç†'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
            <span class="n">proxies</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proxies</span>
  
    <span class="k">def</span> <span class="nf">crawl_daili66</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_count</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="s">"""
        è·å–ä»£ç†66
        :param page_count: é¡µç 
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.66ip.cn/{}.html'</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_url</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Crawling'</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                <span class="n">trs</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.containerbox table tr:gt(0)'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="p">:</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">tr</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'td:nth-child(1)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">tr</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'td:nth-child(2)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="s">':'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">])</span>
  
    <span class="k">def</span> <span class="nf">crawl_proxy360</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–Proxy360
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.proxy360.cn/Region/China'</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Crawling'</span><span class="p">,</span> <span class="n">start_url</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'div[name="list_proxy_ip"]'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.tbBottomLine:nth-child(1)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.tbBottomLine:nth-child(2)'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
                <span class="k">yield</span> <span class="s">':'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">])</span>
  
    <span class="k">def</span> <span class="nf">crawl_goubanjia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–Goubanjia
        :return: ä»£ç†
        """</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="s">'http://www.goubanjia.com/free/gngn/index.shtml'</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">start_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">tds</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'td.ip'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tds</span><span class="p">:</span>
                <span class="n">td</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p'</span><span class="p">).</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">td</span><span class="p">.</span><span class="n">text</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>ä½ å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯æ€æ ·è·å–äº†æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•åç§°çš„ã€‚å…¶å®è¿™é‡Œå€ŸåŠ©äºå…ƒç±»æ¥å®ç°ï¼Œå®šä¹‰äº†ä¸€ä¸ª ProxyMetaclassï¼ŒCrawl ç±»å°†å®ƒè®¾ç½®ä¸ºå…ƒç±»ï¼Œå…ƒç±»ä¸­å®ç°äº† new() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å›ºå®šçš„å‡ ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬å››ä¸ªå‚æ•° attrs ä¸­åŒ…å«äº†ç±»çš„ä¸€äº›å±æ€§ï¼Œè¿™å…¶ä¸­å°±åŒ…å«äº†ç±»ä¸­æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† attrs è¿™ä¸ªå˜é‡å³å¯è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ã€‚æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬åœ¨ new() æ–¹æ³•ä¸­éå†äº† attrs çš„è¿™ä¸ªå±æ€§ï¼Œå°±åƒéå†ä¸€ä¸ªå­—å…¸ä¸€æ ·ï¼Œé”®åå¯¹åº”çš„å°±æ˜¯æ–¹æ³•çš„åç§°ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­å…¶å¼€å¤´æ˜¯å¦æ˜¯ crawlï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å…¶åŠ å…¥åˆ° CrawlFunc å±æ€§ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸå°†æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•å®šä¹‰æˆäº†ä¸€ä¸ªå±æ€§ï¼Œå°±æˆåŠŸåŠ¨æ€åœ°è·å–åˆ°æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•åˆ—è¡¨äº†ã€‚</p>

    <p>æ‰€ä»¥è¯´ï¼Œå¦‚æœè¦åšæ‰©å±•çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€ä¸ªä»¥ crawlå¼€å¤´çš„æ–¹æ³•ï¼Œä¾‹å¦‚æŠ“å–å¿«ä»£ç†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ Crawler ç±»ä¸­å¢åŠ  crawl_kuaidaili() æ–¹æ³•ï¼Œä»¿ç…§å…¶ä»–çš„å‡ ä¸ªæ–¹æ³•å°†å…¶å®šä¹‰æˆç”Ÿæˆå™¨ï¼ŒæŠ“å–å…¶ç½‘ç«™çš„ä»£ç†ï¼Œç„¶åé€šè¿‡ yield è¿”å›ä»£ç†å³å¯ï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ‰©å±•ï¼Œè€Œä¸ç”¨å…³å¿ƒç±»å…¶ä»–éƒ¨åˆ†çš„å®ç°é€»è¾‘ã€‚</p>

    <p>ä»£ç†ç½‘ç«™çš„æ·»åŠ éå¸¸çµæ´»ï¼Œä¸ä»…å¯ä»¥æ·»åŠ å…è´¹ä»£ç†ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä»˜è´¹ä»£ç†ï¼Œä¸€äº›ä»˜è´¹ä»£ç†çš„æå–æ–¹å¼å…¶å®ä¹Ÿç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡ Web çš„å½¢å¼è·å–ï¼Œç„¶åè¿›è¡Œè§£æï¼Œè§£ææ–¹å¼å¯èƒ½æ›´åŠ ç®€å•ï¼Œå¦‚è§£æçº¯æ–‡æœ¬æˆ– Jsonï¼Œè§£æä¹‹åä»¥åŒæ ·çš„æ–¹å¼è¿”å›å³å¯ï¼Œåœ¨æ­¤ä¸å†æ·»åŠ ï¼Œå¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚</p>

    <p>æ—¢ç„¶å®šä¹‰äº†è¿™ä¸ª Crawler ç±»ï¼Œæˆ‘ä»¬å°±è¦è°ƒç”¨å•Šï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå†å®šä¹‰ä¸€ä¸ª Getter ç±»ï¼ŒåŠ¨æ€åœ°è°ƒç”¨æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•ï¼Œç„¶åè·å–æŠ“å–åˆ°çš„ä»£ç†ï¼Œå°†å…¶åŠ å…¥åˆ°æ•°æ®åº“å­˜å‚¨èµ·æ¥ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
<span class="kn">from</span> <span class="nn">crawler</span> <span class="kn">import</span> <span class="n">Crawler</span>
  
<span class="n">POOL_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mi">10000</span>
  
<span class="k">class</span> <span class="nc">Getter</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span> <span class="o">=</span> <span class="n">Crawler</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">is_over_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        åˆ¤æ–­æ˜¯å¦è¾¾åˆ°äº†ä»£ç†æ± é™åˆ¶
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">POOL_UPPER_THRESHOLD</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
  
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'è·å–å™¨å¼€å§‹æ‰§è¡Œ'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_over_threshold</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">callback_label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">__CrawlFuncCount__</span><span class="p">):</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">__CrawlFunc__</span><span class="p">[</span><span class="n">callback_label</span><span class="p">]</span>
                <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">get_proxies</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>æ£€æµ‹æ¨¡å—</p>

        <p>åœ¨è·å–æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸå°†å„ä¸ªç½‘ç«™çš„ä»£ç†è·å–ä¸‹æ¥äº†ï¼Œç„¶åå°±éœ€è¦ä¸€ä¸ªæ£€æµ‹æ¨¡å—æ¥å¯¹æ‰€æœ‰çš„ä»£ç†è¿›è¡Œä¸€è½®è½®çš„æ£€æµ‹ï¼Œæ£€æµ‹å¯ç”¨å°±è®¾ç½®ä¸º 100ï¼Œä¸å¯ç”¨å°±åˆ†æ•°å‡ 1ï¼Œè¿™æ ·å°±å¯ä»¥å®æ—¶æ”¹å˜æ¯ä¸ªä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œåœ¨è·å–æœ‰æ•ˆä»£ç†çš„æ—¶å€™åªéœ€è¦è·å–åˆ†æ•°é«˜çš„ä»£ç†å³å¯ã€‚</p>

        <p>ç”±äºä»£ç†çš„æ•°é‡éå¸¸å¤šï¼Œä¸ºäº†æé«˜ä»£ç†çš„æ£€æµ‹æ•ˆç‡ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ Aiohttp æ¥è¿›è¡Œæ£€æµ‹ã€‚</p>

        <p>Requests ä½œä¸ºä¸€ä¸ªåŒæ­¥è¯·æ±‚åº“ï¼Œæˆ‘ä»¬åœ¨å‘å‡ºä¸€ä¸ªè¯·æ±‚ä¹‹åéœ€è¦ç­‰å¾…ç½‘é¡µåŠ è½½å®Œæˆä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¼šé˜»å¡åœ¨ç­‰å¾…å“åº”è¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœæœåŠ¡å™¨å“åº”éå¸¸æ…¢ï¼Œæ¯”å¦‚ä¸€ä¸ªè¯·æ±‚ç­‰å¾…åå‡ ç§’ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨ Requests å®Œæˆä¸€ä¸ªè¯·æ±‚å°±ä¼šéœ€è¦åå‡ ç§’çš„æ—¶é—´ï¼Œä¸­é—´å…¶å®å°±æ˜¯ä¸€ä¸ªç­‰å¾…å“åº”çš„è¿‡ç¨‹ï¼Œç¨‹åºä¹Ÿä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè€Œè¿™åå‡ ç§’çš„æ—¶é—´å…¶å®å®Œå…¨å¯ä»¥å»åšå…¶ä»–çš„äº‹æƒ…ï¼Œæ¯”å¦‚è°ƒåº¦å…¶ä»–çš„è¯·æ±‚æˆ–è€…è¿›è¡Œç½‘é¡µè§£æç­‰ç­‰ã€‚</p>

        <p>å¼‚æ­¥è¯·æ±‚åº“å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒç±»ä¼¼ JavaScript ä¸­çš„å›è°ƒï¼Œæ„æ€æ˜¯è¯´åœ¨è¯·æ±‚å‘å‡ºä¹‹åï¼Œç¨‹åºå¯ä»¥ç»§ç»­æ¥ä¸‹å»æ‰§è¡Œå»åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“å“åº”åˆ°è¾¾æ—¶ï¼Œä¼šé€šçŸ¥ç¨‹åºå†å»å¤„ç†è¿™ä¸ªå“åº”ï¼Œè¿™æ ·ç¨‹åºå°±æ²¡æœ‰è¢«é˜»å¡ï¼Œå……åˆ†æŠŠæ—¶é—´å’Œèµ„æºåˆ©ç”¨èµ·æ¥ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚</p>

        <p>å¯¹äºå“åº”é€Ÿåº¦æ¯”è¾ƒå¿«çš„ç½‘ç«™ï¼Œå¯èƒ½ Requests åŒæ­¥è¯·æ±‚å’Œ Aiohttp å¼‚æ­¥è¯·æ±‚çš„æ•ˆæœå·®è·æ²¡é‚£ä¹ˆå¤§ï¼Œå¯å¯¹äºæ£€æµ‹ä»£ç†è¿™ç§äº‹æƒ…ï¼Œä¸€èˆ¬æ˜¯éœ€è¦åå¤šç§’ç”šè‡³å‡ åç§’çš„æ—¶é—´ï¼Œè¿™æ—¶å€™ä½¿ç”¨ Aiohttp å¼‚æ­¥è¯·æ±‚åº“çš„ä¼˜åŠ¿å°±å¤§å¤§ä½“ç°å‡ºæ¥äº†ï¼Œæ•ˆç‡å¯èƒ½ä¼šæé«˜å‡ åå€ä¸æ­¢ã€‚</p>

        <p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬çš„ä»£ç†æ£€æµ‹ä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ Aiohttpï¼Œå®ç°ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VALID_STATUS_CODES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">]</span>
<span class="n">TEST_URL</span> <span class="o">=</span> <span class="s">'http://www.baidu.com'</span>
<span class="n">BATCH_TEST_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    
    
<span class="k">class</span> <span class="nc">Tester</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_single_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="s">"""
        æµ‹è¯•å•ä¸ªä»£ç†
        :param proxy: å•ä¸ªä»£ç†
        :return: None
        """</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">verify_ssl</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">real_proxy</span> <span class="o">=</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨æµ‹è¯•'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">TEST_URL</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">real_proxy</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">VALID_STATUS_CODES</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†å¯ç”¨'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">decrease</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'è¯·æ±‚å“åº”ç ä¸åˆæ³•'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">ClientConnectorError</span><span class="p">,</span> <span class="nb">TimeoutError</span><span class="p">,</span> <span class="nb">AttributeError</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="n">decrease</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†è¯·æ±‚å¤±è´¥'</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        æµ‹è¯•ä¸»å‡½æ•°
        :return: None
        """</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="c1"># æ‰¹é‡æµ‹è¯•
</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxies</span><span class="p">),</span> <span class="n">BATCH_TEST_SIZE</span><span class="p">):</span>
                <span class="n">test_proxies</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">BATCH_TEST_SIZE</span><span class="p">]</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">test_single_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">test_proxies</span><span class="p">]</span>
                <span class="n">loop</span><span class="p">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å‘ç”Ÿé”™è¯¯'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>        </div>

        <p>åœ¨è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç±» Testerï¼Œinit() æ–¹æ³•ä¸­å»ºç«‹äº†ä¸€ä¸ª RedisClient å¯¹è±¡ï¼Œä¾›ç±»ä¸­å…¶ä»–æ–¹æ³•ä½¿ç”¨ã€‚æ¥ä¸‹æ¥å®šä¹‰äº†ä¸€ä¸ª test_single_proxy() æ–¹æ³•ï¼Œç”¨æ¥æ£€æµ‹å•ä¸ªä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œå…¶å‚æ•°å°±æ˜¯è¢«æ£€æµ‹çš„ä»£ç†ï¼Œæ³¨æ„è¿™ä¸ªæ–¹æ³•å‰é¢åŠ äº† async å…³é”®è¯ï¼Œä»£è¡¨è¿™ä¸ªæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ–¹æ³•å†…éƒ¨é¦–å…ˆåˆ›å»ºäº† Aiohttp çš„ ClientSession å¯¹è±¡ï¼Œæ­¤å¯¹è±¡ç±»ä¼¼äº Requests çš„ Session å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥å¯¹è±¡çš„ get() æ–¹æ³•æ¥è®¿é—®é¡µé¢ï¼Œåœ¨è¿™é‡Œä»£ç†çš„è®¾ç½®æ–¹å¼æ˜¯é€šè¿‡ proxy å‚æ•°ä¼ é€’ç»™ get() æ–¹æ³•ï¼Œè¯·æ±‚æ–¹æ³•å‰é¢ä¹Ÿéœ€è¦åŠ ä¸Š async å…³é”®è¯æ ‡æ˜æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œè¿™ä¹Ÿæ˜¯ Aiohttp ä½¿ç”¨æ—¶çš„å¸¸è§å†™æ³•ã€‚</p>

        <p>æµ‹è¯•çš„é“¾æ¥åœ¨è¿™é‡Œå®šä¹‰å¸¸é‡ä¸º TEST_URLï¼Œå¦‚æœé’ˆå¯¹æŸä¸ªç½‘ç«™æœ‰æŠ“å–éœ€æ±‚ï¼Œå»ºè®®å°† TEST_URL è®¾ç½®ä¸ºç›®æ ‡ç½‘ç«™çš„åœ°å€ï¼Œå› ä¸ºåœ¨æŠ“å–çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä»£ç†æœ¬èº«æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯è¯¥ä»£ç†çš„ IP å·²ç»è¢«ç›®æ ‡ç½‘ç«™å°æ‰äº†ã€‚ä¾‹å¦‚ï¼Œå¦‚è¦æŠ“å–çŸ¥ä¹ï¼Œå¯èƒ½å…¶ä¸­æŸäº›ä»£ç†æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚è®¿é—®ç™¾åº¦ç­‰é¡µé¢æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¯èƒ½å¯¹çŸ¥ä¹æ¥è¯´å¯èƒ½å°±è¢«å°äº†ï¼Œæ‰€ä»¥å¯ä»¥å°† TEST_URL è®¾ç½®ä¸ºçŸ¥ä¹çš„æŸä¸ªé¡µé¢çš„é“¾æ¥ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶ï¼Œå½“ä»£ç†è¢«å°æ—¶ï¼Œåˆ†æ•°è‡ªç„¶ä¼šå‡ä¸‹æ¥ï¼Œå°±ä¸ä¼šè¢«å–åˆ°äº†ã€‚</p>

        <p>å¦‚æœæƒ³åšä¸€ä¸ªé€šç”¨çš„ä»£ç†æ± ï¼Œåˆ™ä¸éœ€è¦ä¸“é—¨è®¾ç½® TEST_URLï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªä¸ä¼šå° IP çš„ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºç™¾åº¦è¿™ç±»å“åº”ç¨³å®šçš„ç½‘ç«™ã€‚</p>

        <p>å¦å¤–æˆ‘ä»¬è¿˜å®šä¹‰äº† VALID_STATUS_CODES å˜é‡ï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼ï¼ŒåŒ…å«äº†æ­£å¸¸çš„çŠ¶æ€ç ï¼Œå¦‚å¯ä»¥å®šä¹‰æˆ [200]ï¼Œå½“ç„¶å¯¹äºæŸäº›æ£€æµ‹ç›®æ ‡ç½‘ç«™å¯èƒ½ä¼šå‡ºç°å…¶ä»–çš„çŠ¶æ€ç ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥è‡ªè¡Œé…ç½®ã€‚</p>

        <p>è·å– Response åéœ€è¦åˆ¤æ–­å“åº”çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€ç åœ¨ VALID_STATUS_CODES è¿™ä¸ªåˆ—è¡¨é‡Œï¼Œåˆ™ä»£è¡¨ä»£ç†å¯ç”¨ï¼Œè°ƒç”¨ RedisClient çš„ max() æ–¹æ³•å°†ä»£ç†åˆ†æ•°è®¾ä¸º 100ï¼Œå¦åˆ™è°ƒç”¨ decrease() æ–¹æ³•å°†ä»£ç†åˆ†æ•°å‡ 1ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ä¹ŸåŒæ ·å°†ä»£ç†åˆ†æ•°å‡ 1ã€‚</p>

        <p>å¦å¤–åœ¨æµ‹è¯•çš„æ—¶å€™è®¾ç½®äº†æ‰¹é‡æµ‹è¯•çš„æœ€å¤§å€¼ BATCH_TEST_SIZE ä¸º 100ï¼Œä¹Ÿå°±æ˜¯ä¸€æ‰¹æµ‹è¯•æœ€å¤šæµ‹è¯• 100ä¸ªï¼Œè¿™å¯ä»¥é¿å…å½“ä»£ç†æ± è¿‡å¤§æ—¶å…¨éƒ¨æµ‹è¯•å¯¼è‡´å†…å­˜å¼€é”€è¿‡å¤§çš„é—®é¢˜ã€‚</p>

        <p>éšååœ¨ run() æ–¹æ³•é‡Œé¢è·å–äº†æ‰€æœ‰çš„ä»£ç†åˆ—è¡¨ï¼Œä½¿ç”¨ Aiohttp åˆ†é…ä»»åŠ¡ï¼Œå¯åŠ¨è¿è¡Œï¼Œè¿™æ ·å°±å¯ä»¥è¿›è¡Œå¼‚æ­¥æ£€æµ‹äº†ï¼Œå†™æ³•å¯ä»¥å‚è€ƒ Aiohttp çš„å®˜æ–¹ç¤ºä¾‹ï¼šhttp://aiohttp.readthedocs.io/ã€‚</p>
      </li>
      <li>
        <p>æ¥å£æ¨¡å—</p>

        <p>è¿‡ä¸Šè¿°ä¸‰ä¸ªæ¨¡å—æˆ‘ä»¬å·²ç»å¯ä»¥åšåˆ°ä»£ç†çš„è·å–ã€æ£€æµ‹å’Œæ›´æ–°äº†ï¼Œæ•°æ®åº“ä¸­å°±ä¼šä»¥æœ‰åºé›†åˆçš„å½¢å¼å­˜å‚¨å„ä¸ªä»£ç†è¿˜æœ‰å¯¹åº”çš„åˆ†æ•°ï¼Œåˆ†æ•° 100 ä»£è¡¨å¯ç”¨ï¼Œåˆ†æ•°è¶Šå°ä»£è¡¨è¶Šä¸å¯ç”¨ã€‚</p>

        <p>ä½†æ˜¯æˆ‘ä»¬æ€æ ·æ¥æ–¹ä¾¿åœ°è·å–å¯ç”¨ä»£ç†å‘¢ï¼Ÿç”¨ RedisClient ç±»æ¥ç›´æ¥è¿æ¥ Redis ç„¶åè°ƒç”¨ random() æ–¹æ³•è·å–å½“ç„¶æ²¡é—®é¢˜ï¼Œè¿™æ ·åšæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯æœ‰è¿™ä¹ˆå‡ ä¸ªå¼Šç«¯ï¼š</p>

        <ul>
          <li>å¦‚æœå…¶ä»–äººä½¿ç”¨è¿™ä¸ªä»£ç†æ± ï¼Œä»–éœ€è¦çŸ¥é“ Redis è¿æ¥çš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ï¼Œè¿™æ ·å¾ˆä¸å®‰å…¨ã€‚</li>
          <li>å¦‚æœä»£ç†æ± éœ€è¦éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œï¼ŒäºŒè¿œç¨‹æœåŠ¡å™¨çš„ Redis åªå…è®¸æœ¬åœ°è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½è¿œç¨‹ç›´è¿ Redis æ¥è·å–ä»£ç†</li>
          <li>å¦‚æœçˆ¬è™«æ‰€åœ¨çš„ä¸»æœºæ²¡æœ‰è¿æ¥ Redis æ¨¡å—ï¼Œæˆ–è€…çˆ¬è™«ä¸æ˜¯ç”± Python è¯­è¨€ç¼–å†™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ— æ³•ä½¿ç”¨ RedisClient æ¥è·å–ä»£ç†</li>
          <li>å¦‚æœ RedisClient ç±»æˆ–è€…æ•°æ®åº“ç»“æ„æœ‰æ›´æ–°ï¼Œå‘¢å—çˆ¬è™«ç«¯å¿…é¡»åŒæ­¥è¿™äº›æ›´æ–°ï¼Œè¿™æ ·éå¸¸éº»çƒ¦</li>
        </ul>

        <p>ç»¼ä¸Šè€ƒè™‘ï¼Œä¸ºäº†ä½¿å¾—ä»£ç†æ± å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹æœåŠ¡è¿è¡Œï¼Œæˆ‘ä»¬æœ€å¥½å¢åŠ ä¸€ä¸ªæ¥å£æ¨¡å—ï¼Œä»¥ Web API çš„å½¢å¼æš´éœ²å¯ç”¨ä»£ç†ã€‚</p>

        <p>è¿™æ ·è·å–ä»£ç†åªéœ€è¦è¯·æ±‚ä¸€ä¸‹æ¥å£å³å¯ï¼Œä»¥ä¸Šçš„å‡ ä¸ªç¼ºç‚¹å¼Šç«¯å¯ä»¥è§£å†³ã€‚</p>

        <p>æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„åº“ Flask æ¥å®ç°è¿™ä¸ªæ¥å£æ¨¡å—ï¼Œå®ç°ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
    
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    
<span class="k">def</span> <span class="nf">get_conn</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'redis'</span><span class="p">):</span>
        <span class="n">g</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">redis</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;'</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/random'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="s">"""
    è·å–éšæœºå¯ç”¨ä»£ç†
    :return: éšæœºä»£ç†
    """</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">conn</span><span class="p">.</span><span class="n">random</span><span class="p">()</span>
    
    
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/count'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_counts</span><span class="p">():</span>
    <span class="s">"""
    è·å–ä»£ç†æ± æ€»é‡
    :return: ä»£ç†æ± æ€»é‡
    """</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">count</span><span class="p">())</span>
    
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>        </div>

        <p>è¿è¡Œä¹‹å Flask ä¼šå¯åŠ¨ä¸€ä¸ª Web æœåŠ¡ï¼Œæˆ‘ä»¬åªéœ€è¦è®¿é—®å¯¹åº”çš„æ¥å£å³å¯è·å–åˆ°å¯ç”¨ä»£ç†ã€‚</p>
      </li>
      <li>
        <p>è°ƒåº¦æ¨¡å—</p>

        <p>è¿™ä¸ªæ¨¡å—å…¶å®å°±æ˜¯è°ƒç”¨ä»¥ä¸Šæ‰€å®šä¹‰çš„ä¸‰ä¸ªæ¨¡å—ï¼Œå°†ä»¥ä¸Šä¸‰ä¸ªæ¨¡å—é€šè¿‡å¤šè¿›ç¨‹çš„å½¢å¼è¿è¡Œèµ·æ¥ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">TESTER_CYCLE</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">GETTER_CYCLE</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">TESTER_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">GETTER_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">API_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
      
  <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
  <span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span>
  <span class="kn">from</span> <span class="nn">getter</span> <span class="kn">import</span> <span class="n">Getter</span>
  <span class="kn">from</span> <span class="nn">tester</span> <span class="kn">import</span> <span class="n">Tester</span>
      
      
  <span class="k">class</span> <span class="nc">Scheduler</span><span class="p">():</span>
      <span class="k">def</span> <span class="nf">schedule_tester</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">TESTER_CYCLE</span><span class="p">):</span>
          <span class="s">"""
          å®šæ—¶æµ‹è¯•ä»£ç†
          """</span>
          <span class="n">tester</span> <span class="o">=</span> <span class="n">Tester</span><span class="p">()</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="n">tester</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
              <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">schedule_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">GETTER_CYCLE</span><span class="p">):</span>
          <span class="s">"""
          å®šæ—¶è·å–ä»£ç†
          """</span>
          <span class="n">getter</span> <span class="o">=</span> <span class="n">Getter</span><span class="p">()</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'å¼€å§‹æŠ“å–ä»£ç†'</span><span class="p">)</span>
              <span class="n">getter</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
              <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">schedule_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="s">"""
          å¼€å¯API
          """</span>
          <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">API_HOST</span><span class="p">,</span> <span class="n">API_PORT</span><span class="p">)</span>
      
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'ä»£ç†æ± å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">TESTER_ENABLED</span><span class="p">:</span>
              <span class="n">tester_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_tester</span><span class="p">)</span>
              <span class="n">tester_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
      
          <span class="k">if</span> <span class="n">GETTER_ENABLED</span><span class="p">:</span>
              <span class="n">getter_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_getter</span><span class="p">)</span>
              <span class="n">getter_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
      
          <span class="k">if</span> <span class="n">API_ENABLED</span><span class="p">:</span>
              <span class="n">api_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_api</span><span class="p">)</span>
              <span class="n">api_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>        </div>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯åŠ¨å…¥å£æ˜¯ run() æ–¹æ³•ï¼Œå…¶åˆ†åˆ«åˆ¤æ–­äº†ä¸‰ä¸ªæ¨¡å—çš„å¼€å…³ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œå°±æ–°å»ºä¸€ä¸ª Process è¿›ç¨‹ï¼Œè®¾ç½®å¥½å¯åŠ¨ç›®æ ‡ï¼Œç„¶åè°ƒç”¨ start() æ–¹æ³•è¿è¡Œï¼Œè¿™æ ·ä¸‰ä¸ªè¿›ç¨‹å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚
  
ä¸‰ä¸ªè°ƒåº¦æ–¹æ³•ç»“æ„ä¹Ÿéå¸¸æ¸…æ™°ï¼Œæ¯”å¦‚ schedule_tester() æ–¹æ³•ï¼Œè¿™æ˜¯ç”¨æ¥è°ƒåº¦æµ‹è¯•æ¨¡å—çš„æ–¹æ³•ï¼Œé¦–å…ˆå£°æ˜ä¸€ä¸ª Tester å¯¹è±¡ï¼Œç„¶åè¿›å…¥æ­»å¾ªç¯ä¸æ–­å¾ªç¯è°ƒç”¨å…¶ run() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œä¸€è½®ä¹‹åå°±ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œä¼‘çœ ç»“æŸä¹‹åé‡æ–°å†æ‰§è¡Œã€‚åœ¨è¿™é‡Œä¼‘çœ æ—¶é—´ä¹Ÿå®šä¹‰ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå¦‚ 20 ç§’ï¼Œè¿™æ ·å°±ä¼šæ¯éš” 20 ç§’è¿›è¡Œä¸€æ¬¡ä»£ç†æ£€æµ‹ã€‚
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="è¿è¡Œ-1">è¿è¡Œ</h3>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»£ç æ•´åˆä¸€ä¸‹ï¼Œå°†ä»£ç†è¿è¡Œèµ·æ¥</p>

<p>ä»¥ä¸Šæ˜¯ä»£ç†æ± çš„æ§åˆ¶å°è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°å¯ç”¨ä»£ç†è®¾ç½®ä¸º 100ï¼Œä¸å¯ç”¨ä»£ç†åˆ†æ•°å‡ 1ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†æ‰“å¼€æµè§ˆå™¨ï¼Œå½“å‰é…ç½®äº†è¿è¡Œåœ¨ 5555 ç«¯å£ï¼Œæ‰€ä»¥æ‰“å¼€ï¼šhttp://127.0.0.1:5555ï¼Œå³å¯çœ‹åˆ°å…¶é¦–é¡µ</p>

<p>å†è®¿é—®ï¼šhttp://127.0.0.1:5555/randomï¼Œå³å¯è·å–éšæœºå¯ç”¨ä»£ç†</p>

<p>æ‰€ä»¥åé¢æˆ‘ä»¬åªéœ€è¦è®¿é—®æ­¤æ¥å£å³å¯è·å–ä¸€ä¸ªéšæœºå¯ç”¨ä»£ç†ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>

<p>è·å–ä»£ç†çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">PROXY_POOL_URL</span> <span class="o">=</span> <span class="s">'http://localhost:5555/random'</span>

<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
    <span class="k">except</span> <span class="nb">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<p>æœ‰äº†ä»£ç†æ± ä¹‹åï¼Œæˆ‘ä»¬å†å–å‡ºä»£ç†å³å¯æœ‰æ•ˆé˜²æ­¢IPè¢«å°ç¦çš„æƒ…å†µã€‚</p>

<h2 id="ä½¿ç”¨ä»£ç†çˆ¬å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« -1">ä½¿ç”¨ä»£ç†çˆ¬å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« </h2>

<h3 id="çˆ¬å–åˆ†æ-1">çˆ¬å–åˆ†æ</h3>

<p>æœç‹—å¯¹å¾®ä¿¡å…¬ä¼—å¹³å°çš„å…¬ä¼—å·å’Œæ–‡ç« åšäº†æ•´åˆã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„é“¾æ¥æœç´¢åˆ°ç›¸å…³çš„å…¬ä¼—å·å’Œæ–‡ç« ï¼Œä¾‹å¦‚æœç´¢ NBAï¼Œå¯ä»¥æœç´¢åˆ°æœ€æ–°çš„æ–‡ç« </p>

<p>ç‚¹å‡»æœç´¢åï¼Œæœç´¢ç»“æœçš„ URL ä¸­å…¶å®æœ‰å¾ˆå¤šæ— å…³ GET è¯·æ±‚å‚æ•°ï¼Œå°†æ— å…³çš„å‚æ•°å»æ‰ï¼Œåªä¿ç•™ type å’Œ query å‚æ•°ï¼Œä¾‹å¦‚ http://weixin.sogou.com/weixin?type=2&amp;query=NBAï¼Œæœç´¢å…³é”®è¯ä¸º NBAï¼Œç±»å‹ä¸º 2ï¼Œ2 ä»£è¡¨æœç´¢å¾®ä¿¡æ–‡ç« ã€‚</p>

<p>ä¸‹æ‹‰ç½‘é¡µï¼Œç‚¹å‡»ä¸‹ä¸€é¡µå³å¯ç¿»é¡µ</p>

<p>æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥è´¦å·ç™»å½•ï¼Œé‚£åªèƒ½çœ‹åˆ° 10 é¡µçš„å†…å®¹ï¼Œç™»å½•ä¹‹åå¯ä»¥çœ‹åˆ° 100 é¡µå†…å®¹</p>

<p>å¦‚æœéœ€è¦çˆ¬å–æ›´å¤šå†…å®¹ï¼Œå°±éœ€è¦ç™»å½•å¹¶ä½¿ç”¨ Cookies æ¥çˆ¬å–ã€‚</p>

<p>æœç‹—å¾®ä¿¡ç«™ç‚¹çš„åçˆ¬è™«èƒ½åŠ›å¾ˆå¼ºï¼Œå¦‚è¿ç»­åˆ·æ–°ï¼Œç«™ç‚¹å°±ä¼šå¼¹å‡ºéªŒè¯ã€‚</p>

<p>ç½‘ç»œè¯·æ±‚å‡ºç°äº† 302 è·³è½¬ï¼Œè¿”å›çŠ¶æ€ç ä¸º 302ï¼Œè·³è½¬çš„é“¾æ¥å¼€å¤´ä¸º http://weixin.sogou.com/antispider/ ï¼Œè¿™å¾ˆæ˜æ˜¾å°±æ˜¯ä¸€ä¸ªåçˆ¬è™«çš„éªŒè¯é¡µé¢ã€‚æ‰€ä»¥æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›çŠ¶æ€ç ä¸º 302 è€Œé 200ï¼Œåˆ™ IP è®¿é—®æ¬¡æ•°å¤ªé«˜ï¼ŒIP è¢«å°ç¦ï¼Œæ­¤è¯·æ±‚å°±æ˜¯å¤±è´¥äº†ã€‚</p>

<p>å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¯†åˆ«éªŒè¯ç å¹¶è§£å°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»£ç†ç›´æ¥åˆ‡æ¢ IPã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨ä»£ç†ç›´æ¥è·³è¿‡è¿™ä¸ªéªŒè¯ã€‚ä»£ç†ä½¿ç”¨ä¸Šä¸€èŠ‚æ‰€è®²çš„ä»£ç†æ± ï¼Œè¿˜éœ€è¦æ›´æ”¹æ£€æµ‹çš„ URL ä¸ºæœç‹—å¾®ä¿¡çš„ç«™ç‚¹ã€‚</p>

<p>å¯¹äºè¿™ç§åçˆ¬èƒ½åŠ›å¾ˆå¼ºçš„ç½‘ç«™æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬é‡åˆ°æ­¤ç§è¿”å›çŠ¶æ€å°±éœ€è¦é‡è¯•ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å¦ä¸€ç§çˆ¬å–æ–¹å¼ï¼Œå€ŸåŠ©æ•°æ®åº“æ„é€ ä¸€ä¸ªçˆ¬å–é˜Ÿåˆ—ï¼Œå¾…çˆ¬å–çš„è¯·æ±‚éƒ½æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œå¦‚æœè¯·æ±‚å¤±è´¥äº†é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œå°±ä¼šè¢«é‡æ–°è°ƒåº¦çˆ¬å–ã€‚</p>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Redis çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œæ–°çš„è¯·æ±‚å°±åŠ å…¥é˜Ÿåˆ—ï¼Œæˆ–è€…æœ‰éœ€è¦é‡è¯•çš„è¯·æ±‚ä¹Ÿæ”¾å›é˜Ÿåˆ—ã€‚è°ƒåº¦çš„æ—¶å€™å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œé‚£å°±æŠŠä¸€ä¸ªä¸ªè¯·æ±‚å–å‡ºæ¥æ‰§è¡Œï¼Œå¾—åˆ°å“åº”åå†è¿›è¡Œè§£æï¼Œæå–å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>

<p>è¿™æ¬¡æˆ‘ä»¬é‡‡ç”¨ MySQL å­˜å‚¨ï¼Œå€ŸåŠ© PyMySQL åº“ï¼Œå°†çˆ¬å–ç»“æœæ„é€ ä¸ºä¸€ä¸ªå­—å…¸ï¼Œå®ç°åŠ¨æ€å­˜å‚¨ã€‚</p>

<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬æœ¬èŠ‚å®ç°çš„åŠŸèƒ½æœ‰å¦‚ä¸‹å‡ ç‚¹ã€‚</p>

<ul>
  <li>ä¿®æ”¹ä»£ç†æ± æ£€æµ‹é“¾æ¥ä¸ºæœç‹—å¾®ä¿¡ç«™ç‚¹</li>
  <li>æ„é€  Redis çˆ¬å–é˜Ÿåˆ—ï¼Œç”¨é˜Ÿåˆ—å®ç°è¯·æ±‚çš„å­˜å–</li>
  <li>å®ç°å¼‚å¸¸å¤„ç†ï¼Œå¤±è´¥çš„è¯·æ±‚é‡æ–°åŠ å…¥é˜Ÿåˆ—</li>
  <li>å®ç°ç¿»é¡µå’Œæå–æ–‡ç« åˆ—è¡¨å¹¶æŠŠå¯¹åº”è¯·æ±‚åŠ å…¥é˜Ÿåˆ—</li>
  <li>å®ç°å¾®ä¿¡æ–‡ç« çš„ä¿¡æ¯çš„æå–</li>
  <li>å°†æå–åˆ°çš„ä¿¡æ¯ä¿å­˜åˆ° MySQL</li>
</ul>

<h3 id="è¯·æ±‚æ„é€ -1">è¯·æ±‚æ„é€ </h3>

<p>æ—¢ç„¶æˆ‘ä»¬è¦ç”¨é˜Ÿåˆ—æ¥å­˜å‚¨è¯·æ±‚ï¼Œé‚£ä¹ˆè‚¯å®šè¦å®ç°ä¸€ä¸ªè¯·æ±‚ Request çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªè¯·æ±‚éœ€è¦åŒ…å«ä¸€äº›å¿…è¦ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚é“¾æ¥ã€è¯·æ±‚å¤´ã€è¯·æ±‚æ–¹å¼ã€è¶…æ—¶æ—¶é—´ã€‚å¦å¤–å¯¹äºæŸä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å¯¹åº”çš„æ–¹æ³•æ¥å¤„ç†å®ƒçš„å“åº”ï¼Œæ‰€ä»¥éœ€è¦å†åŠ ä¸€ä¸ª Callback å›è°ƒå‡½æ•°ã€‚æ¯æ¬¡ç¿»é¡µè¯·æ±‚éœ€è¦ä»£ç†æ¥å®ç°ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå‚æ•° NeedProxyã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚å¤±è´¥æ¬¡æ•°å¤ªå¤šï¼Œé‚£å°±ä¸å†é‡æ–°è¯·æ±‚äº†ï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ å¤±è´¥æ¬¡æ•°çš„è®°å½•ã€‚</p>

<p>è¿™äº›å­—æ®µéƒ½éœ€è¦ä½œä¸º Request çš„ä¸€éƒ¨åˆ†ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„ Request å¯¹è±¡æ”¾å…¥é˜Ÿåˆ—å»è°ƒåº¦ï¼Œè¿™æ ·ä»é˜Ÿåˆ—è·å–å‡ºæ¥çš„æ—¶å€™ç›´æ¥æ‰§è¡Œè¿™ä¸ª Request å¯¹è±¡å°±å¥½äº†ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç»§æ‰¿ reqeusts åº“ä¸­çš„ Request å¯¹è±¡çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªæ•°æ®ç»“æ„ã€‚requests åº“ä¸­å·²ç»æœ‰äº† Request å¯¹è±¡ï¼Œå®ƒå°†è¯·æ±‚ Request ä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹è±¡å»æ‰§è¡Œï¼Œå¾—åˆ°å“åº”åå†è¿”å›ã€‚å…¶å® requests åº“çš„ get()ã€post() ç­‰æ–¹æ³•éƒ½æ˜¯é€šè¿‡æ‰§è¡Œ Request å¯¹è±¡å®ç°çš„ã€‚</p>

<p>æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ Request å¯¹è±¡çš„æºç ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">RequestHooksMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c1"># Default empty dicts for dict params.
</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">data</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">files</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">headers</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">hooks</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">hooks</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">default_hooks</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hooks</span><span class="p">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">register_hook</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">hook</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">json</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">cookies</span>
</code></pre></div></div>

<p>è¿™æ˜¯ requests åº“ä¸­ Request å¯¹è±¡çš„æ„é€ æ–¹æ³•ã€‚è¿™ä¸ª Request å·²ç»åŒ…å«äº†è¯·æ±‚æ–¹å¼ã€è¯·æ±‚é“¾æ¥ã€è¯·æ±‚å¤´è¿™å‡ ä¸ªå±æ€§ï¼Œä½†æ˜¯ç›¸æ¯”æˆ‘ä»¬éœ€è¦çš„è¿˜å·®äº†å‡ ä¸ªã€‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œåœ¨åŸå…ˆåŸºç¡€ä¸ŠåŠ å…¥ä¸Šæ–‡æ‰€æåˆ°çš„é¢å¤–å‡ ä¸ªå±æ€§ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿ Request å¯¹è±¡é‡æ–°å®ç°ä¸€ä¸ªè¯·æ±‚ï¼Œå°†å®ƒå®šä¹‰ä¸º WeixinRequestï¼Œå®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">class</span> <span class="nc">WeixinRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fail_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">):</span>
        <span class="n">Request</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">need_proxy</span> <span class="o">=</span> <span class="n">need_proxy</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">=</span> <span class="n">fail_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å®ç°äº† WeixinRequest æ•°æ®ç»“æ„ã€‚init() æ–¹æ³•å…ˆè°ƒç”¨äº† Request çš„init() æ–¹æ³•ï¼Œç„¶ååŠ å…¥é¢å¤–çš„å‡ ä¸ªå‚æ•°ï¼Œå®šä¹‰ä¸º callbackã€need_proxyã€fail_timeã€timeoutï¼Œåˆ†åˆ«ä»£è¡¨å›è°ƒå‡½æ•°ã€æ˜¯å¦éœ€è¦ä»£ç†çˆ¬å–ã€å¤±è´¥æ¬¡æ•°ã€è¶…æ—¶æ—¶é—´ã€‚</p>

<p>æˆ‘ä»¬å°±å¯ä»¥å°† WeixinRequest ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥æ‰§è¡Œï¼Œä¸€ä¸ªä¸ª WeixinRequest å¯¹è±¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰è‡ªå·±çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å®ƒçš„ callbackï¼Œå°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¯·æ±‚çš„å“åº”åº”è¯¥ç”¨ä»€ä¹ˆæ–¹æ³•æ¥å¤„ç†ï¼Œè°ƒç”¨ fail_time å°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¯·æ±‚å¤±è´¥äº†å¤šå°‘æ¬¡ï¼Œåˆ¤æ–­å¤±è´¥æ¬¡æ•°æ˜¯ä¸æ˜¯åˆ°äº†é˜ˆå€¼ï¼Œè¯¥ä¸è¯¥ä¸¢å¼ƒè¿™ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨äº†é¢å‘å¯¹è±¡çš„ä¸€äº›æ€æƒ³ã€‚</p>

<h3 id="å®ç°è¯·æ±‚é˜Ÿåˆ—-1">å®ç°è¯·æ±‚é˜Ÿåˆ—</h3>

<p>å­˜å–æ— éå°±æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œä¸€ä¸ªæ˜¯æ”¾ï¼Œä¸€ä¸ªæ˜¯å–ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨ Redis çš„ rpush() å’Œ lpop() æ–¹æ³•å³å¯ã€‚</p>

<p>å¦å¤–è¿˜éœ€è¦æ³¨æ„ï¼Œå­˜å–ä¸èƒ½ç›´æ¥å­˜ Request å¯¹è±¡ï¼ŒRedis é‡Œé¢å­˜çš„æ˜¯å­—ç¬¦ä¸²ã€‚æ‰€ä»¥åœ¨å­˜ Request å¯¹è±¡ä¹‹å‰æˆ‘ä»¬å…ˆæŠŠå®ƒåºåˆ—åŒ–ï¼Œå–å‡ºæ¥çš„æ—¶å€™å†å°†å…¶ååºåˆ—åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ©ç”¨ pickle æ¨¡å—å®ç°ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>

<span class="k">class</span> <span class="nc">RedisQueue</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ– Redis"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        å‘é˜Ÿåˆ—æ·»åŠ åºåˆ—åŒ–åçš„ Request
        :param request: è¯·æ±‚å¯¹è±¡
        :param fail_time: å¤±è´¥æ¬¡æ•°
        :return: æ·»åŠ ç»“æœ
        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">rpush</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        å–å‡ºä¸‹ä¸€ä¸ª Request å¹¶ååºåˆ—åŒ–
        :return: Request or None
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">llen</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">lpop</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">llen</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div></div>

<p>è¿™é‡Œå®ç°äº†ä¸€ä¸ª RedisQueueï¼Œå®ƒçš„ <strong>init</strong>() æ„é€ æ–¹æ³•é‡Œé¢åˆå§‹åŒ–äº†ä¸€ä¸ª StrictRedis å¯¹è±¡ã€‚éšåå®ç°äº† add() æ–¹æ³•ï¼Œé¦–å…ˆåˆ¤æ–­ Request çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ WeixinRequestï¼Œé‚£ä¹ˆå°±æŠŠç¨‹åºå°±ä¼šç”¨ pickle çš„ dumps() æ–¹æ³•åºåˆ—åŒ–ï¼Œç„¶åå†è°ƒç”¨ rpush() æ–¹æ³•åŠ å…¥é˜Ÿåˆ—ã€‚pop() æ–¹æ³•åˆ™ç›¸åï¼Œè°ƒç”¨ lpop() æ–¹æ³•å°†è¯·æ±‚ä»é˜Ÿåˆ—å–å‡ºï¼Œç„¶åå†ç”¨ pickle çš„ loads() æ–¹æ³•å°†å…¶è½¬ä¸º WeixinRequest å¯¹è±¡ã€‚å¦å¤–ï¼Œempty() æ–¹æ³•è¿”å›é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œåªéœ€è¦åˆ¤æ–­é˜Ÿåˆ—é•¿åº¦æ˜¯å¦ä¸º 0 å³å¯ã€‚</p>

<p>åœ¨è°ƒåº¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°å»ºä¸€ä¸ª RedisQueue å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ add() æ–¹æ³•ï¼Œä¼ å…¥ WeixinRequest å¯¹è±¡ï¼Œå³å¯å°† WeixinRequest åŠ å…¥é˜Ÿåˆ—ï¼Œè°ƒç”¨ pop() æ–¹æ³•ï¼Œå³å¯å–å‡ºä¸‹ä¸€ä¸ª WeixinRequest å¯¹è±¡ï¼Œéå¸¸ç®€å•æ˜“ç”¨ã€‚</p>

<h3 id="ä¿®æ”¹ä»£ç†æ± -1">ä¿®æ”¹ä»£ç†æ± </h3>

<p>ä¹‹å‰ä»£ç†æ± æ£€æµ‹çš„ URL å¹¶ä¸æ˜¯æœç‹—å¾®ä¿¡ç«™ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»£ç†æ± æ£€æµ‹çš„ URL ä¿®æ”¹æˆæœç‹—å¾®ä¿¡ç«™ç‚¹ï¼Œä»¥ä¾¿äºæŠŠè¢«æœç‹—å¾®ä¿¡ç«™ç‚¹å°ç¦çš„ä»£ç†å‰”é™¤æ‰ï¼Œç•™ä¸‹å¯ç”¨ä»£ç†ã€‚</p>

<p>ç°åœ¨å°†ä»£ç†æ± çš„è®¾ç½®æ–‡ä»¶ä¸­çš„ TEST_URL ä¿®æ”¹ä¸€ä¸‹ï¼Œå¦‚ http://weixin.sogou.com/weixin?type=2&amp;query=nba ï¼Œè¢«æœ¬ç«™ç‚¹å°çš„ä»£ç†å°±ä¼šå‡åˆ†ï¼Œæ­£å¸¸è¯·æ±‚çš„ä»£ç†å°±ä¼šèµ‹å€¼ä¸º 100ï¼Œæœ€åç•™ä¸‹çš„å°±æ˜¯å¯ç”¨ä»£ç†ã€‚</p>

<p>ä¿®æ”¹ä¹‹åå°†è·å–æ¨¡å—ã€æ£€æµ‹æ¨¡å—ã€æ¥å£æ¨¡å—çš„å¼€å…³éƒ½è®¾ç½®ä¸º Trueï¼Œè®©ä»£ç†æ± è¿è¡Œä¸€ä¼š</p>

<p>è¿™æ ·ï¼Œæ•°æ®åº“ä¸­ç•™ä¸‹çš„ 100 åˆ†çš„ä»£ç†å°±æ˜¯é’ˆå¯¹æœç‹—å¾®ä¿¡çš„å¯ç”¨ä»£ç†äº†</p>

<p>åŒæ—¶è®¿é—®ä»£ç†æ¥å£ï¼Œæ¥å£è®¾ç½®ä¸º 5555ï¼Œè®¿é—® http://127.0.0.1:5555/random ï¼Œå³å¯è·å–åˆ°éšæœºå¯ç”¨ä»£ç†</p>

<p>å†å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è·å–éšæœºä»£ç†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PROXY_POOL_URL</span> <span class="o">=</span> <span class="s">'http://127.0.0.1:5555/random'</span>

<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    ä»ä»£ç†æ± è·å–ä»£ç†
    :return:
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Get Proxy'</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="ç¬¬ä¸€ä¸ªè¯·æ±‚-1">ç¬¬ä¸€ä¸ªè¯·æ±‚</h3>

<p>ä¸€åˆ‡å‡†å¤‡å·¥ä½œéƒ½åšå¥½ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ„é€ ç¬¬ä¸€ä¸ªè¯·æ±‚æ”¾åˆ°é˜Ÿåˆ—é‡Œä»¥ä¾›è°ƒåº¦äº†ã€‚å®šä¹‰ä¸€ä¸ª Spider ç±»ï¼Œå®ç° start() æ–¹æ³•çš„ä»£ç å¦‚ä¸‹:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="k">class</span> <span class="nc">Spider</span><span class="p">():</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s">'http://weixin.sogou.com/weixin'</span>
    <span class="n">keyword</span> <span class="o">=</span> <span class="s">'NBA'</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span><span class="p">,</span>
        <span class="s">'Accept-Encoding'</span><span class="p">:</span> <span class="s">'gzip, deflate'</span><span class="p">,</span>
        <span class="s">'Accept-Language'</span><span class="p">:</span> <span class="s">'zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2,mt;q=0.2'</span><span class="p">,</span>
        <span class="s">'Cache-Control'</span><span class="p">:</span> <span class="s">'max-age=0'</span><span class="p">,</span>
        <span class="s">'Connection'</span><span class="p">:</span> <span class="s">'keep-alive'</span><span class="p">,</span>
        <span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'IPLOC=CN1100; SUID=6FEDCF3C541C940A000000005968CF55; SUV=1500041046435211; ABTEST=0|1500041048|v1; SNUID=CEA85AE02A2F7E6EAFF9C1FE2ABEBE6F; weixinIndexVisited=1; JSESSIONID=aaar_m7LEIW-jg_gikPZv; ld=Wkllllllll2BzGMVlllllVOo8cUlllll5G@HbZllll9lllllRklll5@@@@@@@@@@'</span><span class="p">,</span>
        <span class="s">'Host'</span><span class="p">:</span> <span class="s">'weixin.sogou.com'</span><span class="p">,</span>
        <span class="s">'Upgrade-Insecure-Requests'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span>
        <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36'</span>
    <span class="p">}</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ–å·¥ä½œ"""</span>
        <span class="c1"># å…¨å±€æ›´æ–° Headers
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">({</span><span class="s">'query'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">keyword</span><span class="p">,</span> <span class="s">'type'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">start_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># è°ƒåº¦ç¬¬ä¸€ä¸ªè¯·æ±‚
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œå®šä¹‰äº† Spider ç±»ï¼Œè®¾ç½®äº†å¾ˆå¤šå…¨å±€å˜é‡ï¼Œæ¯”å¦‚ keyword è®¾ç½®ä¸º NBAï¼Œheaders å°±æ˜¯è¯·æ±‚å¤´ã€‚åœ¨æµè§ˆå™¨é‡Œç™»å½•è´¦å·ï¼Œç„¶ååœ¨å¼€å‘è€…å·¥å…·é‡Œå°†è¯·æ±‚å¤´å¤åˆ¶å‡ºæ¥ï¼Œè®°å¾—å¸¦ä¸Š Cookie å­—æ®µï¼Œè¿™æ ·æ‰èƒ½çˆ¬å– 100 é¡µçš„å†…å®¹ã€‚ç„¶ååˆå§‹åŒ–äº† Session å’Œ RedisQueue å¯¹è±¡ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨æ¥æ‰§è¡Œè¯·æ±‚å’Œå­˜å‚¨è¯·æ±‚ã€‚</p>

<p>é¦–å…ˆï¼Œstart() æ–¹æ³•å…¨å±€æ›´æ–°äº† headersï¼Œä½¿å¾—æ‰€æœ‰è¯·æ±‚éƒ½èƒ½åº”ç”¨ Cookiesã€‚ç„¶åæ„é€ äº†ä¸€ä¸ªèµ·å§‹ URLï¼šhttp://weixin.sogou.com/weixin?type=2&amp;query=NBA ï¼Œéšåç”¨æ”¹ URL æ„é€ äº†ä¸€ä¸ª WeixinRequest å¯¹è±¡ã€‚å›è°ƒå‡½æ•°æ˜¯ Spider ç±»çš„ parse_index() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å½“è¿™ä¸ªè¯·æ±‚æˆåŠŸä¹‹åå°±ç”¨ parse_index() æ¥å¤„ç†å’Œè§£æã€‚need_proxy å‚æ•°è®¾ç½®ä¸º Trueï¼Œä»£è¡¨æ‰§è¡Œè¿™ä¸ªè¯·æ±‚éœ€è¦ç”¨åˆ°ä»£ç†ã€‚éšåæˆ‘ä»¬è°ƒç”¨äº† RedisQueue çš„ add() æ–¹æ³•ï¼Œå°†è¿™ä¸ªè¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦ã€‚</p>

<h3 id="è°ƒåº¦è¯·æ±‚-1">è°ƒåº¦è¯·æ±‚</h3>

<p>åŠ å…¥ç¬¬ä¸€ä¸ªè¯·æ±‚ä¹‹åï¼Œè°ƒåº¦å¼€å§‹äº†ã€‚æˆ‘ä»¬é¦–å…ˆä»é˜Ÿåˆ—ä¸­å–å‡ºè¿™ä¸ªè¯·æ±‚ï¼Œå°†å®ƒçš„ç»“æœè§£æå‡ºæ¥ï¼Œç”Ÿæˆæ–°çš„è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åæ‹¿å‡ºæ–°çš„è¯·æ±‚ï¼Œå°†ç»“æœè§£æï¼Œå†ç”Ÿæˆæ–°çš„è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œè¿™æ ·å¾ªç¯å¾€å¤æ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æ²¡æœ‰è¯·æ±‚ï¼Œåˆ™ä»£è¡¨çˆ¬å–ç»“æŸã€‚æˆ‘ä»¬ç”¨ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VALID_STATUSES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    è°ƒåº¦è¯·æ±‚
    :return:
    """</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">callback</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Schedule'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">VALID_STATUSES</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'New Result'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">'articles'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œå®ç°äº†ä¸€ä¸ª schedule() æ–¹æ³•ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯çš„åˆ¤æ–­æ˜¯é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚</p>

<p>å½“é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ pop() æ–¹æ³•å–å‡ºä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè°ƒç”¨ request() æ–¹æ³•æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼Œrequest() æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">ReadTimeout</span><span class="p">,</span> <span class="nb">ConnectionError</span>

<span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
    <span class="s">"""
    æ‰§è¡Œè¯·æ±‚
    :param weixin_request: è¯·æ±‚
    :return: å“åº”
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">need_proxy</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">get_proxy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
                    <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span>
                                         <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="nb">ConnectionError</span><span class="p">,</span> <span class="n">ReadTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯å¦éœ€è¦ä»£ç†ï¼Œå¦‚æœéœ€è¦ä»£ç†ï¼Œåˆ™è°ƒç”¨ get_proxy() æ–¹æ³•è·å–ä»£ç†ï¼Œç„¶åè°ƒç”¨ Session çš„ send() æ–¹æ³•æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ã€‚è¿™é‡Œçš„è¯·æ±‚è°ƒç”¨äº† prepare() æ–¹æ³•è½¬åŒ–ä¸º Prepared Requestï¼Œå…·ä½“çš„ç”¨æ³•å¯ä»¥å‚è€ƒ http://docs.python-requests.org/en/master/user/advanced/#prepared-requests ï¼ŒåŒæ—¶è®¾ç½® allow_redirects ä¸º Falseï¼Œtimeout æ˜¯è¯¥è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œæœ€åå“åº”è¿”å›ã€‚</p>

<p>æ‰§è¡Œ request() æ–¹æ³•ä¹‹åä¼šå¾—åˆ°ä¸¤ç§ç»“æœï¼šä¸€ç§æ˜¯ Falseï¼Œå³è¯·æ±‚å¤±è´¥ï¼Œè¿æ¥é”™è¯¯ï¼›å¦ä¸€ç§æ˜¯ Response å¯¹è±¡ï¼Œè¿˜éœ€è¦åˆ¤æ–­çŠ¶æ€ç ï¼Œå¦‚æœçŠ¶æ€ç åˆæ³•ï¼Œé‚£ä¹ˆå°±è¿›è¡Œè§£æï¼Œå¦åˆ™é‡æ–°å°†è¯·æ±‚åŠ å›é˜Ÿåˆ—ã€‚</p>

<p>å¦‚æœçŠ¶æ€ç åˆæ³•ï¼Œè§£æçš„æ—¶å€™å°±ä¼šè°ƒç”¨ WeixinRequest çš„å›è°ƒå‡½æ•°è¿›è¡Œè§£æã€‚æ¯”å¦‚è¿™é‡Œçš„å›è°ƒå‡½æ•°æ˜¯ parse_index()ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>

<span class="k">def</span> <span class="nf">parse_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="s">"""
    è§£æç´¢å¼•é¡µ
    :param response: å“åº”
    :return: æ–°çš„å“åº”
    """</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.news-box .news-list li .txt-box h3 a'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_detail</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">weixin_request</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#sogou_next'</span><span class="p">).</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">weixin_request</span>
</code></pre></div></div>

<p>æ­¤æ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼šä¸€ä»¶äº‹å°±æ˜¯è·å–æœ¬é¡µçš„æ‰€æœ‰å¾®ä¿¡æ–‡ç« é“¾æ¥ï¼Œå¦ä¸€ä»¶äº‹å°±æ˜¯è·å–ä¸‹ä¸€é¡µçš„é“¾æ¥ï¼Œå†æ„é€ æˆ WeixinRequest ä¹‹å yield è¿”å›ã€‚</p>

<p>ç„¶åï¼Œschedule() æ–¹æ³•å°†è¿”å›çš„ç»“æœè¿›è¡Œéå†ï¼Œåˆ©ç”¨ isinstance() æ–¹æ³•åˆ¤æ–­è¿”å›ç»“æœï¼Œå¦‚æœè¿”å›ç»“æœæ˜¯ WeixinRequestï¼Œå°±å°†å…¶é‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚</p>

<p>è‡³æ­¤ï¼Œç¬¬ä¸€æ¬¡å¾ªç¯ç»“æŸã€‚</p>

<p>è¿™æ—¶ while å¾ªç¯ä¼šç»§ç»­æ‰§è¡Œã€‚é˜Ÿåˆ—å·²ç»åŒ…å«ç¬¬ä¸€é¡µå†…å®¹çš„æ–‡ç« è¯¦æƒ…é¡µè¯·æ±‚å’Œä¸‹ä¸€é¡µçš„è¯·æ±‚ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡å¾ªç¯å¾—åˆ°çš„ä¸‹ä¸€ä¸ªè¯·æ±‚å°±æ˜¯æ–‡ç« è¯¦æƒ…é¡µçš„è¯·æ±‚ï¼Œç¨‹åºé‡æ–°è°ƒç”¨ request() æ–¹æ³•è·å–å…¶å“åº”ï¼Œç„¶åè°ƒç”¨å…¶å¯¹åº”çš„å›è°ƒå‡½æ•°è§£æã€‚è¿™æ—¶è¯¦æƒ…é¡µè¯·æ±‚çš„å›è°ƒæ–¹æ³•å°±ä¸åŒäº†ï¼Œè¿™æ¬¡æ˜¯ parse_detail() æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="s">"""
    è§£æè¯¦æƒ…é¡µ
    :param response: å“åº”
    :return: å¾®ä¿¡å…¬ä¼—å·æ–‡ç« 
    """</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_title'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_content'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'date'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#post-date'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'nickname'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; strong'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
        <span class="s">'wechat'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; p:nth-child(3) &gt; span'</span><span class="p">).</span><span class="n">text</span><span class="p">()}</span>
    <span class="k">yield</span> <span class="n">data</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•è§£æäº†å¾®ä¿¡æ–‡ç« è¯¦æƒ…é¡µçš„å†…å®¹ï¼Œæå–å‡ºå®ƒçš„æ ‡é¢˜ã€æ­£æ–‡æ–‡æœ¬ã€å‘å¸ƒæ—¥æœŸã€å‘å¸ƒäººæ˜µç§°ã€å¾®ä¿¡å…¬ä¼—å·åç§°ï¼Œå°†è¿™äº›ä¿¡æ¯ç»„åˆæˆä¸€ä¸ªå­—å…¸è¿”å›ã€‚</p>

<p>ç»“æœè¿”å›ä¹‹åè¿˜éœ€è¦åˆ¤æ–­ç±»å‹ï¼Œå¦‚æ˜¯å­—å…¸ç±»å‹ï¼Œç¨‹åºå°±è°ƒç”¨ mysql å¯¹è±¡çš„ insert() æ–¹æ³•å°†æ•°æ®å­˜å…¥æ•°æ®åº“ã€‚</p>

<p>è¿™æ ·ï¼Œç¬¬äºŒæ¬¡å¾ªç¯æ‰§è¡Œå®Œæ¯•ã€‚</p>

<p>ç¬¬ä¸‰æ¬¡å¾ªç¯ã€ç¬¬å››æ¬¡å¾ªç¯ï¼Œå¾ªç¯å¾€å¤ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰å„è‡ªçš„å›è°ƒå‡½æ•°ï¼Œç´¢å¼•é¡µè§£æå®Œæ¯•ä¹‹åä¼šç»§ç»­ç”Ÿæˆåç»­è¯·æ±‚ï¼Œè¯¦æƒ…é¡µè§£æå®Œæ¯•ä¹‹åä¼šè¿”å›ç»“æœä»¥ä¾¿å­˜å‚¨ï¼Œç›´åˆ°çˆ¬å–å®Œæ¯•ã€‚</p>

<p>ç°åœ¨ï¼Œæ•´ä¸ªè°ƒåº¦å°±å®Œæˆäº†ã€‚</p>

<p>æˆ‘ä»¬å®Œå–„ä¸€ä¸‹æ•´ä¸ª Spider ä»£ç ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">RedisQueue</span>
<span class="kn">from</span> <span class="nn">mysql</span> <span class="kn">import</span> <span class="n">MySQL</span>
<span class="kn">from</span> <span class="nn">request</span> <span class="kn">import</span> <span class="n">WeixinRequest</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">ReadTimeout</span><span class="p">,</span> <span class="nb">ConnectionError</span>

<span class="k">class</span> <span class="nc">Spider</span><span class="p">():</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s">'http://weixin.sogou.com/weixin'</span>
    <span class="n">keyword</span> <span class="o">=</span> <span class="s">'NBA'</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span><span class="p">,</span>
        <span class="s">'Accept-Encoding'</span><span class="p">:</span> <span class="s">'gzip, deflate'</span><span class="p">,</span>
        <span class="s">'Accept-Language'</span><span class="p">:</span> <span class="s">'zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2,mt;q=0.2'</span><span class="p">,</span>
        <span class="s">'Cache-Control'</span><span class="p">:</span> <span class="s">'max-age=0'</span><span class="p">,</span>
        <span class="s">'Connection'</span><span class="p">:</span> <span class="s">'keep-alive'</span><span class="p">,</span>
        <span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'IPLOC=CN1100; SUID=6FEDCF3C541C940A000000005968CF55; SUV=1500041046435211; ABTEST=0|1500041048|v1; SNUID=CEA85AE02A2F7E6EAFF9C1FE2ABEBE6F; weixinIndexVisited=1; JSESSIONID=aaar\_m7LEIW-jg\_gikPZv; ld=Wkllllllll2BzGMVlllllVOo8cUlllll5G@HbZllll9lllllRklll5@@@@@@@@@@'</span><span class="p">,</span>
        <span class="s">'Host'</span><span class="p">:</span> <span class="s">'weixin.sogou.com'</span><span class="p">,</span>
        <span class="s">'Upgrade-Insecure-Requests'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span>
        <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36'</span>
    <span class="p">}</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">RedisQueue</span><span class="p">()</span>
    <span class="n">mysql</span> <span class="o">=</span> <span class="n">MySQL</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        ä»ä»£ç†æ± è·å–ä»£ç†
        :return:
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROXY_POOL_URL</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Get Proxy'</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""åˆå§‹åŒ–å·¥ä½œ"""</span>
        <span class="c1"># å…¨å±€æ›´æ–° Headers
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">start_url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s">'?'</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">({</span><span class="s">'query'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">keyword</span><span class="p">,</span> <span class="s">'type'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">start_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># è°ƒåº¦ç¬¬ä¸€ä¸ªè¯·æ±‚
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="s">"""
        è§£æç´¢å¼•é¡µ
        :param response: å“åº”
        :return: æ–°çš„å“åº”
        """</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.news-box .news-list li .txt-box h3 a'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_detail</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">weixin_request</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#sogou_next'</span><span class="p">).</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="n">WeixinRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">parse_index</span><span class="p">,</span> <span class="n">need_proxy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">weixin_request</span>

    <span class="k">def</span> <span class="nf">parse_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="s">"""
        è§£æè¯¦æƒ…é¡µ
        :param response: å“åº”
        :return: å¾®ä¿¡å…¬ä¼—å·æ–‡ç« 
        """</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_title'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'content'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.rich_media_content'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'date'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#post-date'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'nickname'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; strong'</span><span class="p">).</span><span class="n">text</span><span class="p">(),</span>
            <span class="s">'wechat'</span><span class="p">:</span> <span class="n">doc</span><span class="p">(</span><span class="s">'#js_profile_qrcode&gt; div &gt; p:nth-child(3) &gt; span'</span><span class="p">).</span><span class="n">text</span><span class="p">()}</span>
        <span class="k">yield</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
        <span class="s">"""
        æ‰§è¡Œè¯·æ±‚
        :param weixin_request: è¯·æ±‚
        :return: å“åº”
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">need_proxy</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_proxy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">,</span>
                        <span class="s">'https'</span><span class="p">:</span> <span class="s">'https://'</span> <span class="o">+</span> <span class="n">proxy</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span>
                                             <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">prepare</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">weixin_request</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="nb">ConnectionError</span><span class="p">,</span> <span class="n">ReadTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">):</span>
        <span class="s">"""
        é”™è¯¯å¤„ç†
        :param weixin_request: è¯·æ±‚
        :return:
        """</span>
        <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Request Failed'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span><span class="p">,</span> <span class="s">'Times'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">fail_time</span> <span class="o">&lt;</span> <span class="n">MAX_FAILED_TIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è°ƒåº¦è¯·æ±‚
        :return:
        """</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">weixin_request</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">callback</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Schedule'</span><span class="p">,</span> <span class="n">weixin_request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">VALID_STATUSES</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'New Result'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">WeixinRequest</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">'articles'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">weixin_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        å…¥å£
        :return:
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">schedule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">spider</span> <span class="o">=</span> <span class="n">Spider</span><span class="p">()</span>
    <span class="n">spider</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
<span class="sb">``</span><span class="err">`</span>

<span class="c1">### MySQL å­˜å‚¨
</span>
<span class="n">æ•´ä¸ªè°ƒåº¦æ¨¡å—å®Œæˆäº†</span><span class="err">ï¼Œ</span><span class="n">ä¸Šé¢è¿˜æ²¡æåŠåˆ°çš„å°±æ˜¯å­˜å‚¨æ¨¡å—</span><span class="err">ï¼Œ</span><span class="n">åœ¨è¿™é‡Œè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª</span> <span class="n">MySQL</span> <span class="n">ç±»ä¾›å­˜å‚¨æ•°æ®</span><span class="err">ï¼Œ</span><span class="n">å®ç°å¦‚ä¸‹</span><span class="err">ï¼š</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="s">'foobared'</span>
<span class="n">REDIS_KEY</span> <span class="o">=</span> <span class="s">'weixin'</span>

<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">MySQL</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">MYSQL_HOST</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">MYSQL_USER</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">MYSQL_PASSWORD</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">MYSQL_PORT</span><span class="p">,</span>
                 <span class="n">database</span><span class="o">=</span><span class="n">MYSQL_DATABASE</span><span class="p">):</span>
        <span class="s">"""
        MySQL åˆå§‹åŒ–
        :param host:
        :param username:
        :param password:
        :param port:
        :param database:
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">MySQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""
        æ’å…¥æ•°æ®
        :param table:
        :param data:
        :return:
        """</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">'% s'</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="s">'insert into % s (% s) values (% s)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">MySQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>
</code></pre></div></div>

<p>__init__() æ–¹æ³•åˆå§‹åŒ–äº† MySQL è¿æ¥ï¼Œéœ€è¦ MySQL çš„ç”¨æˆ·ã€å¯†ç ã€ç«¯å£ã€æ•°æ®åº“åç­‰ä¿¡æ¯ã€‚æ•°æ®åº“åä¸º weixinï¼Œéœ€è¦è‡ªå·±åˆ›å»ºã€‚</p>

<p>insert() æ–¹æ³•ä¼ å…¥è¡¨åå’Œå­—å…¸å³å¯åŠ¨æ€æ„é€  SQLï¼Œåœ¨ 5.2 èŠ‚ä¸­ä¹Ÿæœ‰è®²åˆ°ï¼ŒSQL æ„é€ ä¹‹åæ‰§è¡Œå³å¯æ’å…¥æ•°æ®ã€‚</p>

<p>æˆ‘ä»¬è¿˜éœ€è¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®è¡¨ï¼Œè¡¨åä¸º articlesï¼Œå»ºè¡¨çš„ SQL è¯­å¥å¦‚ä¸‹ï¼švent-idï¼Œè¿”å›è®¾å¤‡å½“å‰ç¬æ—¶æ•°æ®ä¿¡æ¯</p>
<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>e5c77ca (æ–°é¡µé¢)</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>
:ET