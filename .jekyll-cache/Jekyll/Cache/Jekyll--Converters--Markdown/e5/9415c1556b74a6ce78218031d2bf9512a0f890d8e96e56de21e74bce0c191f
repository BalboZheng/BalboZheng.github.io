I"å<h2 id="-head">Â«Â«Â«&lt; HEAD</h2>
<p>layout:     post
title:      â€œæ¨¡æ‹Ÿç™»å½•â€
subtitle:   â€œâ€
date:       2019-11-29 10:57:05
author:     â€œBalboâ€
header-img: â€œimg/post-bg-2019.jpgâ€
tags:
    - reptile</p>

<hr />

<h2 id="æ¨¡æ‹Ÿç™»å½•å¹¶çˆ¬å–-github">æ¨¡æ‹Ÿç™»å½•å¹¶çˆ¬å– GitHub</h2>

<h3 id="åˆ†æç™»å½•è¿‡ç¨‹">åˆ†æç™»å½•è¿‡ç¨‹</h3>

<p>å¦‚æœå·²ç»ç™»å½• GitHub,å…ˆé€€å‡ºç™»å½•ï¼ŒåŒæ—¶æ¸…é™¤ Cookies</p>

<p>æ‰“å¼€ GitHub çš„ç™»å½•é¡µé¢ï¼Œé“¾æ¥ä¸º https://github.com/login ,è¾“å…¥ GitHub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œå°† Preserve Log é€‰é¡¹å‹¾é€‰ä¸Šï¼Œè¿™ä¸æ˜¯æ˜¾ç¤ºæŒç»­æ—¥å¿—</p>

<p>ç‚¹å‡»ç™»å½•ï¼Œä¾¿ä¼šçœ‹åˆ°å¼€å‘è€…å·¥å…·æ˜¾ç¤ºäº†å„ä¸ªè¯·æ±‚è¿‡ç¨‹</p>

<p>ç‚¹å‡»ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œè¿›å…¥è¯¦æƒ…é¡µ</p>

<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„ URL ä¸º https://github.com/session ,è¯·æ±‚æ–¹å¼ä¸º POST ï¼Œå†å¾€ä¸‹</p>

<p>Headers é‡Œé¢åŒ…å«äº† Cookiesã€Hostã€Originã€Refererã€User-Agentç­‰ä¿¡æ¯</p>

<p>Form Data åŒ…å«äº†5ä¸ªå­—æ®µï¼Œcommit æ˜¯å›ºå®šçš„å­—ç¬¦ä¸²Sign inï¼Œutf8 æ˜¯ä¸€ä¸ªå‹¾é€‰å­—ç¬¦ï¼Œauthenticity_token è¾ƒé•¿ï¼Œå…¶åˆæ­¥åˆ¤æ–­æ˜¯ä¸€ä¸ª Base64 åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œlogin æ˜¯ç™»å½•çš„ç”¨æˆ·åï¼Œpassword çš„ç™»å½•çš„å¯†ç </p>

<p>å†ç™»å½•ä¹‹å‰ä¼šè®¿é—®ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œè¯¥é¡µé¢æ˜¯é€šè¿‡ GET å½¢å¼è®¿é—®çš„ã€‚è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œç‚¹å‡»ç™»å½•ï¼Œæµè§ˆå™¨å‘é€è¿™ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ Cookies å’Œ authenticity_token ä¸€ç‚¹æ˜¯å†è®¿é—®ç™»å½•ä¹Ÿæ—¶è®¾ç½®çš„</p>

<p>å†é€€å‡ºç™»å½•ï¼Œå›åˆ°ç™»å½•é¡µï¼ŒåŒæ—¶æ¸…ç©º Cookies ï¼Œé‡æ–°è®¿é—®ç™»å½•é¡µï¼Œè§£æƒ‘å‘é€çš„è¯·æ±‚</p>

<p>Response Headers æœ‰ä¸€ä¸ª Set-Cookies å­—æ®µï¼Œè¿™å°±æ˜¯è®¾ç½® Cookies çš„è¿‡ç¨‹</p>

<p>å¦å¤–ï¼Œæˆ‘ä»¬å‘ç° Response Headers æ²¡æœ‰å’Œ authenticity_token ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯èƒ½ authenticity_token è¿˜éšè—å†å…¶ä»–çš„åœ°æ–¹æˆ–æ˜¯è®¡ç®—å‡ºæ¥çš„ã€‚æœç´¢æºç ï¼Œå¤§å°æºä»£ç é‡Œé¢éšè—è¿™ä¸ªä¿¡æ¯ï¼Œä»–æ˜¯ä¸€ä¸ªéšè—å¼è¡¨å•å…ƒç´ </p>

<h3 id="ä»£ç ">ä»£ç </h3>

<p>å®šä¹‰ä¸€ä¸ª Login ç±»ï¼š</p>

<p>åˆå§‹åŒ–</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Login</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'Referer'</span><span class="p">:</span> <span class="s">'https://github.com/'</span><span class="p">,</span>
            <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)'</span>
                          <span class="s">' Chrome/57.0.2987.133 Safari/537.36'</span><span class="p">,</span>
            <span class="s">'Host'</span><span class="p">:</span> <span class="s">'github.com'</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">login_url</span> <span class="o">=</span> <span class="s">'https://github.com/login'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">post_url</span> <span class="o">=</span> <span class="s">'https://github.com/session'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logined_url</span> <span class="o">=</span> <span class="s">'https://github.com/settings/profile'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
</code></pre></div></div>

<p>requests.Session() å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»´æŒä¸€ä¸ªä¼šè¯ï¼Œè€Œä¸”å¯ä»¥è‡ªåŠ¨å¤„ç† Cookies</p>

<p>é¡µé¢è·å–åˆå§‹ Cookiesï¼Œæå–å‡º authenticity_token</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">login_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div/input[2]/@value'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>
</code></pre></div></div>

<p>æ¨¡æ‹Ÿç™»å½•</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'commit'</span><span class="p">:</span> <span class="s">'Sign in'</span><span class="p">,</span>
            <span class="s">'utf8'</span><span class="p">:</span> <span class="s">'âœ”'</span><span class="p">,</span>
            <span class="s">'authenticity_token'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">token</span><span class="p">(),</span>
            <span class="s">'login'</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">post_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dynameics</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">logined_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">profile</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">dynamics</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[contains(@class, "name")]//div[contains(@class. "alert")]'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dynamics</span><span class="p">:</span>
            <span class="n">dynamic</span> <span class="o">=</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'.//div[@class="title"]//text()'</span><span class="p">)).</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">dynamic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//input[@id="user_profile_name"]/@value'</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//select[@id="user_profile_email"]/option[@value-""]/text()'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="è¿è¡Œ">è¿è¡Œ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">Login</span><span class="p">()</span>
    <span class="n">login</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="cookies-æ± æ­å»º">Cookies æ± æ­å»º</h2>

<h3 id="cookies-æ± æ¶æ„">Cookies æ± æ¶æ„</h3>

<p>Cookies æ± å’Œä»£ç†æ± ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯4ä¸ªæ ¸å¿ƒæ¨¡å—</p>

<ul>
  <li>å­˜å‚¨æ¨¡å—è´Ÿè´£å­˜å‚¨æ¯ä¸ªè´¦å·çš„ç”¨æˆ·åä»¥åŠæ¯ä¸ªè´¦å·å¯¹åº”çš„ Cookies ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜éœ€è¦æä¾›ä¸€äº›æ–¹æ³•æ¥å®ç°æ–¹ä¾¿çš„å­˜å‚¨æ“ä½œ</li>
  <li>ç”Ÿæˆæ¨¡å—è´Ÿè´£ç”Ÿæˆæ–°çš„ Cookiesï¼Œæ­¤æ¨¡å—ä¼šä»å­˜å‚¨æ¨¡å—é€ä¸ªæ‹¿å»è´¦å·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åæ¨¡æ‹Ÿç™»å½•ç›®æ ‡é¡µé¢ï¼Œåˆ¤æ–­ç™»å½•æˆåŠŸï¼Œå°±å°† Cookies è¿”å›å¹¶äº¤ç»™å­˜å‚¨æ¨¡å—å­˜å‚¨</li>
  <li>æ£€æµ‹æ¨¡å—éœ€è¦å®šæ—¶æ£€æµ‹æ•°æ®åº“ä¸­çš„ Cookiesï¼Œå†è¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæ£€æµ‹é“¾æ¥ï¼Œä¸åŒçš„ç«™ç‚¹æ£€æµ‹é“¾æ¥ä¸åŒï¼Œæ£€æµ‹æ¨¡å—ä¼šé€ä¸ªæ‹¿å»è´¦å·å¯¹åº”çš„ Cookies å»è¯·æ±‚é“¾æ¥ï¼Œå¦‚æœè¿”å›çš„çŠ¶æ€æ˜¯æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆæ­¤ Cookies æ²¡æœ‰å¤±æ•ˆï¼Œå¦åˆ™ Cookies å¤±æ•ˆå¹¶ç§»é™¤ã€‚æ¥ä¸‹æ¥ç­‰å¾…ç”Ÿæˆæ¨¡å—é‡æ–°ç”Ÿæˆå³å¯</li>
  <li>æ¥å£æ¨¡å—éœ€è¦ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£ï¼Œç”±äºå¯ç”¨çš„ Cookies å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬å¯ä»¥éšæœºè¿”å› Cookies çš„æ¥å£ï¼Œè¿™æ ·ä¿è¯æ¯ä¸ª Cookies éƒ½æœ‰å¯èƒ½è¢«å–åˆ°ã€‚Cookiesè¶Šå¤šï¼Œæ¯ä¸ª Cookies è¢«å–åˆ°çš„æ¦‚ç‡å°±ä¼šè¶Šå°ï¼Œä»è€Œå‡å°‘è¢«å°å·çš„é£é™©</li>
</ul>

<h3 id="cookies-æ± å®ç°">Cookies æ± å®ç°</h3>

<ul>
  <li>
    <p>å­˜å‚¨æ¨¡å—</p>

    <p>éœ€è¦å­˜å‚¨çš„å†…å®¹åŒ…æ‹¬è´¦å·ä¿¡æ¯ä¸Cookiesä¿¡æ¯ã€‚</p>

    <p>è´¦å·ç”±ç”¨æˆ·åå’Œå¯†ç ä¸¤éƒ¨åˆ†ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥å­˜æˆç”¨æˆ·åå’Œå¯†ç çš„æ˜ å°„ã€‚Cookieså¯ä»¥å­˜æˆJSONå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢å¾—éœ€è¦æ ¹æ®è´¦å·æ¥ç”ŸæˆCookiesã€‚ç”Ÿæˆçš„æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“å“ªäº›è´¦å·å·²ç»ç”Ÿæˆäº†Cookiesï¼Œå“ªäº›æ²¡æœ‰ç”Ÿæˆï¼Œæ‰€ä»¥éœ€è¦åŒæ—¶ä¿å­˜è¯¥Cookieså¯¹åº”çš„ç”¨æˆ·åä¿¡æ¯ï¼Œå…¶å®ä¹Ÿæ˜¯ç”¨æˆ·åå’ŒCookiesçš„æ˜ å°„ã€‚</p>

    <p>è¿™é‡Œå°±æ˜¯ä¸¤ç»„æ˜ å°„ï¼ŒRedisçš„Hashæœ‰å¤©ç„¶çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±å»ºç«‹ä¸¤ä¸ªHashã€‚Hashçš„Keyå°±æ˜¯è´¦å·ï¼ŒValueå¯¹åº”ç€å¯†ç æˆ–è€…Cookiesã€‚</p>

    <p>ç”±äºCookiesæ± éœ€è¦å¯æ‰©å±•ï¼Œå­˜å‚¨çš„è´¦å·å’ŒCookieså¯èƒ½ä¸æ­¢ä¸€ä¸ªç½‘ç«™ï¼Œæ‰€ä»¥è¿™é‡ŒHashçš„åç§°å¯ä»¥åšäºŒçº§åˆ†ç±»ã€‚ä»¥é©¬èœ‚çªä¸ºä¾‹ï¼Œå­˜æ”¾è´¦å·çš„Hashåç§°å¯ä»¥ä¸ºaccounts:mafengï¼Œå­˜æ”¾Cookiesçš„Hashåç§°ä¸ºcookies:mafengã€‚è¿™æ ·æ–¹ä¾¿æ‰©å±•ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
  
<span class="kn">import</span> <span class="nn">redis</span>
  
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="bp">None</span>
  
<span class="k">class</span> <span class="nc">RedisClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">website</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ– Redis è¿æ¥
        :param host: åœ°å€
        :param port: ç«¯å£
        :param password: å¯†ç 
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
  
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å– Hash çš„åç§°
        :return: Hash åç§°
        """</span>
        <span class="k">return</span> <span class="s">"{type}: {website}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">"""
        è®¾ç½®é”®å€¼å¯¹
        :param username: ç”¨æˆ·å
        :param value: å¯†ç /Cookies
        :return:
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="s">"""
        æ ¹æ®é”®åè·å–é”®å€¼
        :param username: ç”¨æˆ·å
        :return:
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="s">"""
        æ ¹æ®é”®ååˆ é™¤é”®å€¼å¯¹
        :param username: ç”¨æˆ·å
        :return: åˆ é™¤ç»“æœ
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hdel</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ•°ç›®
        :return: æ•°ç›®
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hlen</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        éšæœºå¾—åˆ°é”®å€¼ï¼Œç”¨äºéšæœº Cookies è·å–
        :return: éšæœº Cookies
        """</span>
        <span class="k">return</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hvals</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">()))</span>
  
    <span class="k">def</span> <span class="nf">usernames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ‰€æœ‰è´¦æˆ·ä¿¡æ¯
        :return: æ‰€æœ‰ç”¨æˆ·å
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ‰€æœ‰é”®å€¼å¯¹
        :return: ç”¨æˆ·åå’Œå¯†ç /Cookiesçš„æ˜ å°„è¡¨
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="s">'weibo'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'hell2o'</span><span class="p">,</span> <span class="s">'sss3s'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>    </div>

    <p><strong>æ³¨ï¼š</strong> name()æ–¹æ³•æ‹¼æ¥äº†typeå’Œwebsite,ç»„æˆHashçš„åç§°ã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é…ç½®æ–‡ä»¶
# Redisæ•°æ®åº“åœ°å€
REDIS_HOST = 'localhost'
  
# Redisç«¯å£
REDIS_PORT = 6379
  
# Rediså¯†ç ï¼Œå¦‚æ— å¡«None
REDIS_PASSWORD = 'foobared'
  
# äº§ç”Ÿå™¨ä½¿ç”¨çš„æµè§ˆå™¨
BROWSER_TYPE = 'Chrome'
  
# äº§ç”Ÿå™¨ç±»ï¼Œå¦‚æ‰©å±•å…¶ä»–ç«™ç‚¹ï¼Œè¯·åœ¨æ­¤é…ç½®
GENERATOR_MAP = {
    'weibo': 'WeiboCookiesGenerator'
}
  
# æµ‹è¯•ç±»ï¼Œå¦‚æ‰©å±•å…¶ä»–ç«™ç‚¹ï¼Œè¯·åœ¨æ­¤é…ç½®
TESTER_MAP = {
    'weibo': 'WeiboValidTester'
}
  
TEST_URL_MAP = {
    'weibo': 'https://m.weibo.cn/'
}
  
# äº§ç”Ÿå™¨å’ŒéªŒè¯å™¨å¾ªç¯å‘¨æœŸ
CYCLE = 120
  
# APIåœ°å€å’Œç«¯å£
API_HOST = '0.0.0.0'
API_PORT = 5000
  
# äº§ç”Ÿå™¨å¼€å…³ï¼Œæ¨¡æ‹Ÿç™»å½•æ·»åŠ Cookies
GENERATOR_PROCESS = False
# éªŒè¯å™¨å¼€å…³ï¼Œå¾ªç¯æ£€æµ‹æ•°æ®åº“ä¸­Cookiesæ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨åˆ é™¤
VALID_PROCESS = False
# APIæ¥å£æœåŠ¡
API_PROCESS = True
</code></pre></div>    </div>

    <p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¯¼å…¥æ•°æ®çš„æ–¹æ³•ï¼Œä¾¿äºæ‰¹é‡å¯¼å…¥ç”¨æˆ·åä¸å¯†ç ã€‚</p>
  </li>
  <li>
    <p>ç”Ÿæˆæ¨¡å—</p>

    <p>ç”Ÿæˆæ¨¡å—è´Ÿè´£è·å–å„ä¸ªè´¦å·ä¿¡æ¯å¹¶æ¨¡æ‹Ÿç™»å½•ï¼Œéšåç”ŸæˆCookieså¹¶ä¿å­˜ã€‚æˆ‘ä»¬é¦–å…ˆè·å–ä¸¤ä¸ªHashçš„ä¿¡æ¯ï¼Œçœ‹çœ‹è´¦æˆ·çš„Hashæ¯”Cookiesçš„å¤šäº†å“ªäº›è¿˜æ²¡æœ‰ç”ŸæˆCookiesçš„è´¦å·ï¼Œç„¶åå°†å‰©ä½™çš„è´¦å·éå†ï¼Œå†å»ç”ŸæˆCookieså³å¯ã€‚</p>

    <p>è¿™é‡Œä¸»è¦é€»è¾‘å°±æ˜¯æ‰¾å‡ºé‚£äº›è¿˜æ²¡å¯¹åº” Cookies è´¦æˆ·ï¼Œç„¶åå†é€ä¸ªè·å– Cookies</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">DesiredCapabilities</span>
<span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
<span class="kn">from</span> <span class="nn">login.weibo.cookies</span> <span class="kn">import</span> <span class="n">WeiboCookies</span>
  
  
<span class="k">class</span> <span class="nc">CookiesGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'default'</span><span class="p">):</span>
        <span class="s">"""
        çˆ¶ç±», åˆå§‹åŒ–ä¸€äº›å¯¹è±¡
        :param website: åç§°
        :param browser: æµè§ˆå™¨, è‹¥ä¸ä½¿ç”¨æµè§ˆå™¨åˆ™å¯è®¾ç½®ä¸º None
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'cookies'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">init_browser</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">init_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        é€šè¿‡browserå‚æ•°åˆå§‹åŒ–å…¨å±€æµè§ˆå™¨ä¾›æ¨¡æ‹Ÿç™»å½•ä½¿ç”¨
        :return:
        """</span>
        <span class="k">if</span> <span class="n">BROWSER_TYPE</span> <span class="o">==</span> <span class="s">'PhantomJS'</span><span class="p">:</span>
            <span class="n">caps</span> <span class="o">=</span> <span class="n">DesiredCapabilities</span><span class="p">.</span><span class="n">PHANTOMJS</span>
            <span class="n">caps</span><span class="p">[</span>
                <span class="s">"phantomjs.page.settings.userAgent"</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36'</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">(</span><span class="n">desired_capabilities</span><span class="o">=</span><span class="n">caps</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">BROWSER_TYPE</span> <span class="o">==</span> <span class="s">'Chrome'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">new_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="s">"""
        æ–°ç”ŸæˆCookiesï¼Œå­ç±»éœ€è¦é‡å†™
        :param username: ç”¨æˆ·å
        :param password: å¯†ç 
        :return:
        """</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>
  
    <span class="k">def</span> <span class="nf">process_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
        <span class="s">"""
        å¤„ç†Cookies
        :param cookies:
        :return:
        """</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">cookie</span><span class="p">[</span><span class="s">'name'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span>
  
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è¿è¡Œ, å¾—åˆ°æ‰€æœ‰è´¦æˆ·, ç„¶åé¡ºæ¬¡æ¨¡æ‹Ÿç™»å½•
        :return:
        """</span>
        <span class="n">accounts_usernames</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">usernames</span><span class="p">()</span>
        <span class="n">cookies_usernames</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">usernames</span><span class="p">()</span>
  
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">accounts_usernames</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">cookies_usernames</span><span class="p">:</span>
                <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨ç”ŸæˆCookies'</span><span class="p">,</span> <span class="s">'è´¦å·'</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="s">'å¯†ç '</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">new_cookies</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
                <span class="c1"># æˆåŠŸè·å–
</span>                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'status'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">process_cookies</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸè·å–åˆ°Cookies'</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cookies</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸä¿å­˜Cookies'</span><span class="p">)</span>
                <span class="c1"># å¯†ç é”™è¯¯ï¼Œç§»é™¤è´¦å·
</span>                <span class="k">elif</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'status'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸåˆ é™¤è´¦å·'</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æ‰€æœ‰è´¦å·éƒ½å·²ç»æˆåŠŸè·å–Cookies'</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    å…³é—­
    :return:
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Closing Browser'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser</span>
    <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Browser not opened'</span><span class="p">)</span>
  
  
<span class="k">class</span> <span class="nc">WeiboCookiesGenerator</span><span class="p">(</span><span class="n">CookiesGenerator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'weibo'</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ–æ“ä½œ
        :param website: ç«™ç‚¹åç§°
        :param browser: ä½¿ç”¨çš„æµè§ˆå™¨
        """</span>
        <span class="n">CookiesGenerator</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
  
    <span class="k">def</span> <span class="nf">new_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="s">"""
        ç”ŸæˆCookies
        :param username: ç”¨æˆ·å
        :param password: å¯†ç 
        :return: ç”¨æˆ·åå’ŒCookies
        """</span>
        <span class="k">return</span> <span class="n">WeiboCookies</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">).</span><span class="n">main</span><span class="p">()</span>
  
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">WeiboCookiesGenerator</span><span class="p">()</span>
    <span class="n">generator</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ£€æµ‹æ¨¡å—</p>

    <p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨ç”Ÿæˆæ¨¡å—æ¥ç”ŸæˆCookiesï¼Œä½†æ˜¯è¿˜æ˜¯å…ä¸äº†Cookieså¤±æ•ˆçš„é—®é¢˜ï¼Œä¾‹å¦‚æ—¶é—´å¤ªé•¿æˆ–è€…Cookiesä½¿ç”¨å¤ªé¢‘ç¹å¯¼è‡´æ— æ³•æ­£å¸¸è¯·æ±‚ç½‘é¡µã€‚</p>

    <p>å¦‚æœé‡åˆ°è¿™æ ·çš„Cookiesï¼Œæˆ‘ä»¬è‚¯å®šä¸èƒ½è®©å®ƒç»§ç»­ä¿å­˜åœ¨æ•°æ®åº“é‡Œäº†ã€‚</p>

    <p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªå®šæ—¶æ£€æµ‹æ¨¡å—ï¼Œè´Ÿè´£éå†æ± ä¸­çš„æ‰€æœ‰Cookiesï¼ŒåŒäº‹è®¾ç½®å¥½å¯¹åº”çš„æ£€æµ‹é“¾æ¥ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¸ªCookieså»è¯·æ±‚è¿™ä¸ªé“¾æ¥ã€‚å¦‚æœæ£€æµ‹å¤±æ•ˆï¼Œå°±å°†è¯¥Cookiesä»æ•°æ®åº“ä¸­ç§»é™¤ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">import</span> <span class="nn">json</span>
  <span class="kn">import</span> <span class="nn">requests</span>
  <span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="nb">ConnectionError</span>
  <span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="o">*</span>
    
  <span class="k">class</span> <span class="nc">ValidTester</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'default'</span><span class="p">):</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'cookies'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
          <span class="k">raise</span> <span class="nb">NotImplementedError</span>
    
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="n">cookies_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span> <span class="ow">in</span> <span class="n">cookies_groups</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
              <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
    
  <span class="k">class</span> <span class="nc">WeiboValidTester</span><span class="p">(</span><span class="n">ValidTester</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'weibo'</span><span class="p">):</span>
          <span class="n">ValidTester</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨æµ‹è¯•Cookies'</span><span class="p">,</span> <span class="s">'ç”¨æˆ·å'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">cookies</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
          <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesä¸åˆæ³•'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'åˆ é™¤Cookies'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="k">return</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">test_url</span> <span class="o">=</span> <span class="n">TEST_URL_MAP</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">]</span>
              <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæœ‰æ•ˆ'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'Cookieså¤±æ•ˆ'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                  <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'åˆ é™¤Cookies'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
          <span class="k">except</span> <span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'å‘ç”Ÿå¼‚å¸¸'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
    
  <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
      <span class="n">WeiboValidTester</span><span class="p">().</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¥å£æ¨¡å—</p>

    <p>ç”Ÿæˆæ¨¡å—å’Œæ£€æµ‹æ¨¡å—å¦‚æœå®šæ—¶è¿è¡Œï¼Œå°±å¯ä»¥å®ŒæˆCookieså®æ—¶æ£€æµ‹å’Œæ›´æ–°ã€‚</p>

    <p>ä½†æ˜¯Cookieséœ€è¦ç»™çˆ¬è™«æ¥ç”¨ï¼ŒåŒæ—¶ä¸€ä¸ªCookiesæ± å¯ä¾›å¤šä¸ªçˆ¬è™«ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªWebæ¥å£ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="o">*</span>
  
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
  
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'&lt;h2&gt;Welcome to Cookie Pool System&lt;/h2&gt;'</span>
  
<span class="k">def</span> <span class="nf">get_conn</span><span class="p">():</span>
    <span class="s">"""
    è·å–
    :return:
    """</span>
    <span class="k">for</span> <span class="n">website</span> <span class="ow">in</span> <span class="n">GENERATOR_MAP</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">website</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'RedisClient'</span> <span class="o">+</span> <span class="s">'("cookies", "'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_accounts'</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'RedisClient'</span> <span class="o">+</span> <span class="s">'("accounts", "'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">g</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/random'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">website</span><span class="p">):</span>
    <span class="s">"""
    è·å–éšæœºçš„Cookie, è®¿é—®åœ°å€å¦‚ /weibo/random
    :return: éšæœºCookie
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">).</span><span class="n">random</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cookies</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/add/&lt;username&gt;/&lt;password&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">website</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="s">"""
    æ·»åŠ ç”¨æˆ·, è®¿é—®åœ°å€å¦‚ /weibo/add/user/password
    :param website: ç«™ç‚¹
    :param username: ç”¨æˆ·å
    :param password: å¯†ç 
    :return:
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_accounts'</span><span class="p">).</span><span class="nb">set</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">})</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/count'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">website</span><span class="p">):</span>
    <span class="s">"""
    è·å–Cookiesæ€»æ•°
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>
  
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">)</span>
  
</code></pre></div>    </div>
  </li>
  <li>
    <p>è°ƒåº¦æ¨¡å—
  æœ€åï¼Œæˆ‘ä»¬å†åŠ ä¸Šä¸€ä¸ªè°ƒåº¦æ¨¡å—è®©è¿™å‡ ä¸ªæ¨¡å—é…åˆè¿è¡Œèµ·æ¥ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯é©±åŠ¨å‡ ä¸ªæ¨¡å—å®šæ—¶è¿è¡Œï¼ŒåŒæ—¶å„ä¸ªæ¨¡å—éœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¸Šè¿è¡Œ</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">import</span> <span class="nn">time</span>
  <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
    
  <span class="kn">from</span> <span class="nn">cookiespool.api</span> <span class="kn">import</span> <span class="n">app</span>
  <span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="kn">from</span> <span class="nn">cookiespool.generator</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="kn">from</span> <span class="nn">cookiespool.tester</span> <span class="kn">import</span> <span class="o">*</span>
    
    
  <span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">valid_cookie</span><span class="p">(</span><span class="n">cycle</span><span class="o">=</span><span class="n">CYCLE</span><span class="p">):</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæ£€æµ‹è¿›ç¨‹å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">website</span><span class="p">,</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">TESTER_MAP</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                      <span class="n">tester</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cls</span> <span class="o">+</span> <span class="s">'(website="'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">)</span>
                      <span class="n">tester</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
                      <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæ£€æµ‹å®Œæˆ'</span><span class="p">)</span>
                      <span class="k">del</span> <span class="n">tester</span>
                      <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
              <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">generate_cookie</span><span class="p">(</span><span class="n">cycle</span><span class="o">=</span><span class="n">CYCLE</span><span class="p">):</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesç”Ÿæˆè¿›ç¨‹å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">website</span><span class="p">,</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">GENERATOR_MAP</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                      <span class="n">generator</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cls</span> <span class="o">+</span> <span class="s">'(website="'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">)</span>
                      <span class="n">generator</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
                      <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesç”Ÿæˆå®Œæˆ'</span><span class="p">)</span>
                      <span class="n">generator</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                      <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
              <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'APIæ¥å£å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
          <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">API_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">API_PORT</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">API_PROCESS</span><span class="p">:</span>
              <span class="n">api_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">api</span><span class="p">)</span>
              <span class="n">api_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
          <span class="k">if</span> <span class="n">GENERATOR_PROCESS</span><span class="p">:</span>
              <span class="n">generate_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">generate_cookie</span><span class="p">)</span>
              <span class="n">generate_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
          <span class="k">if</span> <span class="n">VALID_PROCESS</span><span class="p">:</span>
              <span class="n">valid_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">valid_cookie</span><span class="p">)</span>
              <span class="n">valid_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1>â€‹</h1>
<hr />
<p>layout: post
title: æ¨¡æ‹Ÿç™»å½•
subtitle: 
author: Balbo Cheng
categories: python
tags: [reptile]
â€”</p>

<h2 id="æ¨¡æ‹Ÿç™»å½•å¹¶çˆ¬å–-github-1">æ¨¡æ‹Ÿç™»å½•å¹¶çˆ¬å– GitHub</h2>

<h3 id="åˆ†æç™»å½•è¿‡ç¨‹-1">åˆ†æç™»å½•è¿‡ç¨‹</h3>

<p>å¦‚æœå·²ç»ç™»å½• GitHub,å…ˆé€€å‡ºç™»å½•ï¼ŒåŒæ—¶æ¸…é™¤ Cookies</p>

<p>æ‰“å¼€ GitHub çš„ç™»å½•é¡µé¢ï¼Œé“¾æ¥ä¸º https://github.com/login ,è¾“å…¥ GitHub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œå°† Preserve Log é€‰é¡¹å‹¾é€‰ä¸Šï¼Œè¿™ä¸æ˜¯æ˜¾ç¤ºæŒç»­æ—¥å¿—</p>

<p>ç‚¹å‡»ç™»å½•ï¼Œä¾¿ä¼šçœ‹åˆ°å¼€å‘è€…å·¥å…·æ˜¾ç¤ºäº†å„ä¸ªè¯·æ±‚è¿‡ç¨‹</p>

<p>ç‚¹å‡»ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œè¿›å…¥è¯¦æƒ…é¡µ</p>

<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„ URL ä¸º https://github.com/session ,è¯·æ±‚æ–¹å¼ä¸º POST ï¼Œå†å¾€ä¸‹</p>

<p>Headers é‡Œé¢åŒ…å«äº† Cookiesã€Hostã€Originã€Refererã€User-Agentç­‰ä¿¡æ¯</p>

<p>Form Data åŒ…å«äº†5ä¸ªå­—æ®µï¼Œcommit æ˜¯å›ºå®šçš„å­—ç¬¦ä¸²Sign inï¼Œutf8 æ˜¯ä¸€ä¸ªå‹¾é€‰å­—ç¬¦ï¼Œauthenticity_token è¾ƒé•¿ï¼Œå…¶åˆæ­¥åˆ¤æ–­æ˜¯ä¸€ä¸ª Base64 åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œlogin æ˜¯ç™»å½•çš„ç”¨æˆ·åï¼Œpassword çš„ç™»å½•çš„å¯†ç </p>

<p>å†ç™»å½•ä¹‹å‰ä¼šè®¿é—®ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œè¯¥é¡µé¢æ˜¯é€šè¿‡ GET å½¢å¼è®¿é—®çš„ã€‚è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œç‚¹å‡»ç™»å½•ï¼Œæµè§ˆå™¨å‘é€è¿™ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ Cookies å’Œ authenticity_token ä¸€ç‚¹æ˜¯å†è®¿é—®ç™»å½•ä¹Ÿæ—¶è®¾ç½®çš„</p>

<p>å†é€€å‡ºç™»å½•ï¼Œå›åˆ°ç™»å½•é¡µï¼ŒåŒæ—¶æ¸…ç©º Cookies ï¼Œé‡æ–°è®¿é—®ç™»å½•é¡µï¼Œè§£æƒ‘å‘é€çš„è¯·æ±‚</p>

<p>Response Headers æœ‰ä¸€ä¸ª Set-Cookies å­—æ®µï¼Œè¿™å°±æ˜¯è®¾ç½® Cookies çš„è¿‡ç¨‹</p>

<p>å¦å¤–ï¼Œæˆ‘ä»¬å‘ç° Response Headers æ²¡æœ‰å’Œ authenticity_token ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯èƒ½ authenticity_token è¿˜éšè—å†å…¶ä»–çš„åœ°æ–¹æˆ–æ˜¯è®¡ç®—å‡ºæ¥çš„ã€‚æœç´¢æºç ï¼Œå¤§å°æºä»£ç é‡Œé¢éšè—è¿™ä¸ªä¿¡æ¯ï¼Œä»–æ˜¯ä¸€ä¸ªéšè—å¼è¡¨å•å…ƒç´ </p>

<h3 id="ä»£ç -1">ä»£ç </h3>

<p>å®šä¹‰ä¸€ä¸ª Login ç±»ï¼š</p>

<p>åˆå§‹åŒ–</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Login</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'Referer'</span><span class="p">:</span> <span class="s">'https://github.com/'</span><span class="p">,</span>
            <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)'</span>
                          <span class="s">' Chrome/57.0.2987.133 Safari/537.36'</span><span class="p">,</span>
            <span class="s">'Host'</span><span class="p">:</span> <span class="s">'github.com'</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">login_url</span> <span class="o">=</span> <span class="s">'https://github.com/login'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">post_url</span> <span class="o">=</span> <span class="s">'https://github.com/session'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logined_url</span> <span class="o">=</span> <span class="s">'https://github.com/settings/profile'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
</code></pre></div></div>

<p>requests.Session() å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»´æŒä¸€ä¸ªä¼šè¯ï¼Œè€Œä¸”å¯ä»¥è‡ªåŠ¨å¤„ç† Cookies</p>

<p>é¡µé¢è·å–åˆå§‹ Cookiesï¼Œæå–å‡º authenticity_token</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">login_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div/input[2]/@value'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>
</code></pre></div></div>

<p>æ¨¡æ‹Ÿç™»å½•</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'commit'</span><span class="p">:</span> <span class="s">'Sign in'</span><span class="p">,</span>
            <span class="s">'utf8'</span><span class="p">:</span> <span class="s">'âœ”'</span><span class="p">,</span>
            <span class="s">'authenticity_token'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">token</span><span class="p">(),</span>
            <span class="s">'login'</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">post_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dynameics</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">logined_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">profile</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">dynamics</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[contains(@class, "name")]//div[contains(@class. "alert")]'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dynamics</span><span class="p">:</span>
            <span class="n">dynamic</span> <span class="o">=</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'.//div[@class="title"]//text()'</span><span class="p">)).</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">dynamic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//input[@id="user_profile_name"]/@value'</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">selector</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//select[@id="user_profile_email"]/option[@value-""]/text()'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="è¿è¡Œ-1">è¿è¡Œ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">Login</span><span class="p">()</span>
    <span class="n">login</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="cookies-æ± æ­å»º-1">Cookies æ± æ­å»º</h2>

<h3 id="cookies-æ± æ¶æ„-1">Cookies æ± æ¶æ„</h3>

<p>Cookies æ± å’Œä»£ç†æ± ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯4ä¸ªæ ¸å¿ƒæ¨¡å—</p>

<ul>
  <li>å­˜å‚¨æ¨¡å—è´Ÿè´£å­˜å‚¨æ¯ä¸ªè´¦å·çš„ç”¨æˆ·åä»¥åŠæ¯ä¸ªè´¦å·å¯¹åº”çš„ Cookies ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜éœ€è¦æä¾›ä¸€äº›æ–¹æ³•æ¥å®ç°æ–¹ä¾¿çš„å­˜å‚¨æ“ä½œ</li>
  <li>ç”Ÿæˆæ¨¡å—è´Ÿè´£ç”Ÿæˆæ–°çš„ Cookiesï¼Œæ­¤æ¨¡å—ä¼šä»å­˜å‚¨æ¨¡å—é€ä¸ªæ‹¿å»è´¦å·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åæ¨¡æ‹Ÿç™»å½•ç›®æ ‡é¡µé¢ï¼Œåˆ¤æ–­ç™»å½•æˆåŠŸï¼Œå°±å°† Cookies è¿”å›å¹¶äº¤ç»™å­˜å‚¨æ¨¡å—å­˜å‚¨</li>
  <li>æ£€æµ‹æ¨¡å—éœ€è¦å®šæ—¶æ£€æµ‹æ•°æ®åº“ä¸­çš„ Cookiesï¼Œå†è¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæ£€æµ‹é“¾æ¥ï¼Œä¸åŒçš„ç«™ç‚¹æ£€æµ‹é“¾æ¥ä¸åŒï¼Œæ£€æµ‹æ¨¡å—ä¼šé€ä¸ªæ‹¿å»è´¦å·å¯¹åº”çš„ Cookies å»è¯·æ±‚é“¾æ¥ï¼Œå¦‚æœè¿”å›çš„çŠ¶æ€æ˜¯æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆæ­¤ Cookies æ²¡æœ‰å¤±æ•ˆï¼Œå¦åˆ™ Cookies å¤±æ•ˆå¹¶ç§»é™¤ã€‚æ¥ä¸‹æ¥ç­‰å¾…ç”Ÿæˆæ¨¡å—é‡æ–°ç”Ÿæˆå³å¯</li>
  <li>æ¥å£æ¨¡å—éœ€è¦ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£ï¼Œç”±äºå¯ç”¨çš„ Cookies å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬å¯ä»¥éšæœºè¿”å› Cookies çš„æ¥å£ï¼Œè¿™æ ·ä¿è¯æ¯ä¸ª Cookies éƒ½æœ‰å¯èƒ½è¢«å–åˆ°ã€‚Cookiesè¶Šå¤šï¼Œæ¯ä¸ª Cookies è¢«å–åˆ°çš„æ¦‚ç‡å°±ä¼šè¶Šå°ï¼Œä»è€Œå‡å°‘è¢«å°å·çš„é£é™©</li>
</ul>

<h3 id="cookies-æ± å®ç°-1">Cookies æ± å®ç°</h3>

<ul>
  <li>
    <p>å­˜å‚¨æ¨¡å—</p>

    <p>éœ€è¦å­˜å‚¨çš„å†…å®¹åŒ…æ‹¬è´¦å·ä¿¡æ¯ä¸Cookiesä¿¡æ¯ã€‚</p>

    <p>è´¦å·ç”±ç”¨æˆ·åå’Œå¯†ç ä¸¤éƒ¨åˆ†ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥å­˜æˆç”¨æˆ·åå’Œå¯†ç çš„æ˜ å°„ã€‚Cookieså¯ä»¥å­˜æˆJSONå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢å¾—éœ€è¦æ ¹æ®è´¦å·æ¥ç”ŸæˆCookiesã€‚ç”Ÿæˆçš„æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“å“ªäº›è´¦å·å·²ç»ç”Ÿæˆäº†Cookiesï¼Œå“ªäº›æ²¡æœ‰ç”Ÿæˆï¼Œæ‰€ä»¥éœ€è¦åŒæ—¶ä¿å­˜è¯¥Cookieså¯¹åº”çš„ç”¨æˆ·åä¿¡æ¯ï¼Œå…¶å®ä¹Ÿæ˜¯ç”¨æˆ·åå’ŒCookiesçš„æ˜ å°„ã€‚</p>

    <p>è¿™é‡Œå°±æ˜¯ä¸¤ç»„æ˜ å°„ï¼ŒRedisçš„Hashæœ‰å¤©ç„¶çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±å»ºç«‹ä¸¤ä¸ªHashã€‚Hashçš„Keyå°±æ˜¯è´¦å·ï¼ŒValueå¯¹åº”ç€å¯†ç æˆ–è€…Cookiesã€‚</p>

    <p>ç”±äºCookiesæ± éœ€è¦å¯æ‰©å±•ï¼Œå­˜å‚¨çš„è´¦å·å’ŒCookieså¯èƒ½ä¸æ­¢ä¸€ä¸ªç½‘ç«™ï¼Œæ‰€ä»¥è¿™é‡ŒHashçš„åç§°å¯ä»¥åšäºŒçº§åˆ†ç±»ã€‚ä»¥é©¬èœ‚çªä¸ºä¾‹ï¼Œå­˜æ”¾è´¦å·çš„Hashåç§°å¯ä»¥ä¸ºaccounts:mafengï¼Œå­˜æ”¾Cookiesçš„Hashåç§°ä¸ºcookies:mafengã€‚è¿™æ ·æ–¹ä¾¿æ‰©å±•ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
  
<span class="kn">import</span> <span class="nn">redis</span>
  
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="s">'localhost'</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="mi">6379</span>
<span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="bp">None</span>
  
<span class="k">class</span> <span class="nc">RedisClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">website</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">REDIS_PASSWORD</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ– Redis è¿æ¥
        :param host: åœ°å€
        :param port: ç«¯å£
        :param password: å¯†ç 
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
  
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å– Hash çš„åç§°
        :return: Hash åç§°
        """</span>
        <span class="k">return</span> <span class="s">"{type}: {website}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">"""
        è®¾ç½®é”®å€¼å¯¹
        :param username: ç”¨æˆ·å
        :param value: å¯†ç /Cookies
        :return:
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="s">"""
        æ ¹æ®é”®åè·å–é”®å€¼
        :param username: ç”¨æˆ·å
        :return:
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="s">"""
        æ ¹æ®é”®ååˆ é™¤é”®å€¼å¯¹
        :param username: ç”¨æˆ·å
        :return: åˆ é™¤ç»“æœ
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hdel</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">username</span><span class="p">)</span>
  
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ•°ç›®
        :return: æ•°ç›®
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hlen</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        éšæœºå¾—åˆ°é”®å€¼ï¼Œç”¨äºéšæœº Cookies è·å–
        :return: éšæœº Cookies
        """</span>
        <span class="k">return</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hvals</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">()))</span>
  
    <span class="k">def</span> <span class="nf">usernames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ‰€æœ‰è´¦æˆ·ä¿¡æ¯
        :return: æ‰€æœ‰ç”¨æˆ·å
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è·å–æ‰€æœ‰é”®å€¼å¯¹
        :return: ç”¨æˆ·åå’Œå¯†ç /Cookiesçš„æ˜ å°„è¡¨
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">())</span>
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="s">'weibo'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'hell2o'</span><span class="p">,</span> <span class="s">'sss3s'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>    </div>

    <p><strong>æ³¨ï¼š</strong> name()æ–¹æ³•æ‹¼æ¥äº†typeå’Œwebsite,ç»„æˆHashçš„åç§°ã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é…ç½®æ–‡ä»¶
# Redisæ•°æ®åº“åœ°å€
REDIS_HOST = 'localhost'
  
# Redisç«¯å£
REDIS_PORT = 6379
  
# Rediså¯†ç ï¼Œå¦‚æ— å¡«None
REDIS_PASSWORD = 'foobared'
  
# äº§ç”Ÿå™¨ä½¿ç”¨çš„æµè§ˆå™¨
BROWSER_TYPE = 'Chrome'
  
# äº§ç”Ÿå™¨ç±»ï¼Œå¦‚æ‰©å±•å…¶ä»–ç«™ç‚¹ï¼Œè¯·åœ¨æ­¤é…ç½®
GENERATOR_MAP = {
    'weibo': 'WeiboCookiesGenerator'
}
  
# æµ‹è¯•ç±»ï¼Œå¦‚æ‰©å±•å…¶ä»–ç«™ç‚¹ï¼Œè¯·åœ¨æ­¤é…ç½®
TESTER_MAP = {
    'weibo': 'WeiboValidTester'
}
  
TEST_URL_MAP = {
    'weibo': 'https://m.weibo.cn/'
}
  
# äº§ç”Ÿå™¨å’ŒéªŒè¯å™¨å¾ªç¯å‘¨æœŸ
CYCLE = 120
  
# APIåœ°å€å’Œç«¯å£
API_HOST = '0.0.0.0'
API_PORT = 5000
  
# äº§ç”Ÿå™¨å¼€å…³ï¼Œæ¨¡æ‹Ÿç™»å½•æ·»åŠ Cookies
GENERATOR_PROCESS = False
# éªŒè¯å™¨å¼€å…³ï¼Œå¾ªç¯æ£€æµ‹æ•°æ®åº“ä¸­Cookiesæ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨åˆ é™¤
VALID_PROCESS = False
# APIæ¥å£æœåŠ¡
API_PROCESS = True
</code></pre></div>    </div>

    <p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¯¼å…¥æ•°æ®çš„æ–¹æ³•ï¼Œä¾¿äºæ‰¹é‡å¯¼å…¥ç”¨æˆ·åä¸å¯†ç ã€‚</p>
  </li>
  <li>
    <p>ç”Ÿæˆæ¨¡å—</p>

    <p>ç”Ÿæˆæ¨¡å—è´Ÿè´£è·å–å„ä¸ªè´¦å·ä¿¡æ¯å¹¶æ¨¡æ‹Ÿç™»å½•ï¼Œéšåç”ŸæˆCookieså¹¶ä¿å­˜ã€‚æˆ‘ä»¬é¦–å…ˆè·å–ä¸¤ä¸ªHashçš„ä¿¡æ¯ï¼Œçœ‹çœ‹è´¦æˆ·çš„Hashæ¯”Cookiesçš„å¤šäº†å“ªäº›è¿˜æ²¡æœ‰ç”ŸæˆCookiesçš„è´¦å·ï¼Œç„¶åå°†å‰©ä½™çš„è´¦å·éå†ï¼Œå†å»ç”ŸæˆCookieså³å¯ã€‚</p>

    <p>è¿™é‡Œä¸»è¦é€»è¾‘å°±æ˜¯æ‰¾å‡ºé‚£äº›è¿˜æ²¡å¯¹åº” Cookies è´¦æˆ·ï¼Œç„¶åå†é€ä¸ªè·å– Cookies</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">DesiredCapabilities</span>
<span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="n">RedisClient</span>
<span class="kn">from</span> <span class="nn">login.weibo.cookies</span> <span class="kn">import</span> <span class="n">WeiboCookies</span>
  
  
<span class="k">class</span> <span class="nc">CookiesGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'default'</span><span class="p">):</span>
        <span class="s">"""
        çˆ¶ç±», åˆå§‹åŒ–ä¸€äº›å¯¹è±¡
        :param website: åç§°
        :param browser: æµè§ˆå™¨, è‹¥ä¸ä½¿ç”¨æµè§ˆå™¨åˆ™å¯è®¾ç½®ä¸º None
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'cookies'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">init_browser</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">init_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        é€šè¿‡browserå‚æ•°åˆå§‹åŒ–å…¨å±€æµè§ˆå™¨ä¾›æ¨¡æ‹Ÿç™»å½•ä½¿ç”¨
        :return:
        """</span>
        <span class="k">if</span> <span class="n">BROWSER_TYPE</span> <span class="o">==</span> <span class="s">'PhantomJS'</span><span class="p">:</span>
            <span class="n">caps</span> <span class="o">=</span> <span class="n">DesiredCapabilities</span><span class="p">.</span><span class="n">PHANTOMJS</span>
            <span class="n">caps</span><span class="p">[</span>
                <span class="s">"phantomjs.page.settings.userAgent"</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36'</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">(</span><span class="n">desired_capabilities</span><span class="o">=</span><span class="n">caps</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">BROWSER_TYPE</span> <span class="o">==</span> <span class="s">'Chrome'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">new_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="s">"""
        æ–°ç”ŸæˆCookiesï¼Œå­ç±»éœ€è¦é‡å†™
        :param username: ç”¨æˆ·å
        :param password: å¯†ç 
        :return:
        """</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>
  
    <span class="k">def</span> <span class="nf">process_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
        <span class="s">"""
        å¤„ç†Cookies
        :param cookies:
        :return:
        """</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">cookie</span><span class="p">[</span><span class="s">'name'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span>
  
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        è¿è¡Œ, å¾—åˆ°æ‰€æœ‰è´¦æˆ·, ç„¶åé¡ºæ¬¡æ¨¡æ‹Ÿç™»å½•
        :return:
        """</span>
        <span class="n">accounts_usernames</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">usernames</span><span class="p">()</span>
        <span class="n">cookies_usernames</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">usernames</span><span class="p">()</span>
  
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">accounts_usernames</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">cookies_usernames</span><span class="p">:</span>
                <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨ç”ŸæˆCookies'</span><span class="p">,</span> <span class="s">'è´¦å·'</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="s">'å¯†ç '</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">new_cookies</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
                <span class="c1"># æˆåŠŸè·å–
</span>                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'status'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">process_cookies</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸè·å–åˆ°Cookies'</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cookies</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸä¿å­˜Cookies'</span><span class="p">)</span>
                <span class="c1"># å¯†ç é”™è¯¯ï¼Œç§»é™¤è´¦å·
</span>                <span class="k">elif</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'status'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">'æˆåŠŸåˆ é™¤è´¦å·'</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">))</span>
  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'æ‰€æœ‰è´¦å·éƒ½å·²ç»æˆåŠŸè·å–Cookies'</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    å…³é—­
    :return:
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Closing Browser'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser</span>
    <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Browser not opened'</span><span class="p">)</span>
  
  
<span class="k">class</span> <span class="nc">WeiboCookiesGenerator</span><span class="p">(</span><span class="n">CookiesGenerator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'weibo'</span><span class="p">):</span>
        <span class="s">"""
        åˆå§‹åŒ–æ“ä½œ
        :param website: ç«™ç‚¹åç§°
        :param browser: ä½¿ç”¨çš„æµè§ˆå™¨
        """</span>
        <span class="n">CookiesGenerator</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
  
    <span class="k">def</span> <span class="nf">new_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="s">"""
        ç”ŸæˆCookies
        :param username: ç”¨æˆ·å
        :param password: å¯†ç 
        :return: ç”¨æˆ·åå’ŒCookies
        """</span>
        <span class="k">return</span> <span class="n">WeiboCookies</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">browser</span><span class="p">).</span><span class="n">main</span><span class="p">()</span>
  
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">WeiboCookiesGenerator</span><span class="p">()</span>
    <span class="n">generator</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ£€æµ‹æ¨¡å—</p>

    <p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨ç”Ÿæˆæ¨¡å—æ¥ç”ŸæˆCookiesï¼Œä½†æ˜¯è¿˜æ˜¯å…ä¸äº†Cookieså¤±æ•ˆçš„é—®é¢˜ï¼Œä¾‹å¦‚æ—¶é—´å¤ªé•¿æˆ–è€…Cookiesä½¿ç”¨å¤ªé¢‘ç¹å¯¼è‡´æ— æ³•æ­£å¸¸è¯·æ±‚ç½‘é¡µã€‚</p>

    <p>å¦‚æœé‡åˆ°è¿™æ ·çš„Cookiesï¼Œæˆ‘ä»¬è‚¯å®šä¸èƒ½è®©å®ƒç»§ç»­ä¿å­˜åœ¨æ•°æ®åº“é‡Œäº†ã€‚</p>

    <p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªå®šæ—¶æ£€æµ‹æ¨¡å—ï¼Œè´Ÿè´£éå†æ± ä¸­çš„æ‰€æœ‰Cookiesï¼ŒåŒäº‹è®¾ç½®å¥½å¯¹åº”çš„æ£€æµ‹é“¾æ¥ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¸ªCookieså»è¯·æ±‚è¿™ä¸ªé“¾æ¥ã€‚å¦‚æœæ£€æµ‹å¤±æ•ˆï¼Œå°±å°†è¯¥Cookiesä»æ•°æ®åº“ä¸­ç§»é™¤ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">import</span> <span class="nn">json</span>
  <span class="kn">import</span> <span class="nn">requests</span>
  <span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="nb">ConnectionError</span>
  <span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="o">*</span>
    
  <span class="k">class</span> <span class="nc">ValidTester</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'default'</span><span class="p">):</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="n">website</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'cookies'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">accounts_db</span> <span class="o">=</span> <span class="n">RedisClient</span><span class="p">(</span><span class="s">'accounts'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
          <span class="k">raise</span> <span class="nb">NotImplementedError</span>
    
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="n">cookies_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span> <span class="ow">in</span> <span class="n">cookies_groups</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
              <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
    
  <span class="k">class</span> <span class="nc">WeiboValidTester</span><span class="p">(</span><span class="n">ValidTester</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s">'weibo'</span><span class="p">):</span>
          <span class="n">ValidTester</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨æµ‹è¯•Cookies'</span><span class="p">,</span> <span class="s">'ç”¨æˆ·å'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">cookies</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
          <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesä¸åˆæ³•'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'åˆ é™¤Cookies'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="k">return</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">test_url</span> <span class="o">=</span> <span class="n">TEST_URL_MAP</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">website</span><span class="p">]</span>
              <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæœ‰æ•ˆ'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'Cookieså¤±æ•ˆ'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                  <span class="bp">self</span><span class="p">.</span><span class="n">cookies_db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                  <span class="k">print</span><span class="p">(</span><span class="s">'åˆ é™¤Cookies'</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
          <span class="k">except</span> <span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'å‘ç”Ÿå¼‚å¸¸'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
    
  <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
      <span class="n">WeiboValidTester</span><span class="p">().</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¥å£æ¨¡å—</p>

    <p>ç”Ÿæˆæ¨¡å—å’Œæ£€æµ‹æ¨¡å—å¦‚æœå®šæ—¶è¿è¡Œï¼Œå°±å¯ä»¥å®ŒæˆCookieså®æ—¶æ£€æµ‹å’Œæ›´æ–°ã€‚</p>

    <p>ä½†æ˜¯Cookieséœ€è¦ç»™çˆ¬è™«æ¥ç”¨ï¼ŒåŒæ—¶ä¸€ä¸ªCookiesæ± å¯ä¾›å¤šä¸ªçˆ¬è™«ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªWebæ¥å£ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cookiespool.db</span> <span class="kn">import</span> <span class="o">*</span>
  
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
  
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'&lt;h2&gt;Welcome to Cookie Pool System&lt;/h2&gt;'</span>
  
<span class="k">def</span> <span class="nf">get_conn</span><span class="p">():</span>
    <span class="s">"""
    è·å–
    :return:
    """</span>
    <span class="k">for</span> <span class="n">website</span> <span class="ow">in</span> <span class="n">GENERATOR_MAP</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">website</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'RedisClient'</span> <span class="o">+</span> <span class="s">'("cookies", "'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_accounts'</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'RedisClient'</span> <span class="o">+</span> <span class="s">'("accounts", "'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">g</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/random'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">website</span><span class="p">):</span>
    <span class="s">"""
    è·å–éšæœºçš„Cookie, è®¿é—®åœ°å€å¦‚ /weibo/random
    :return: éšæœºCookie
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">).</span><span class="n">random</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cookies</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/add/&lt;username&gt;/&lt;password&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">website</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="s">"""
    æ·»åŠ ç”¨æˆ·, è®¿é—®åœ°å€å¦‚ /weibo/add/user/password
    :param website: ç«™ç‚¹
    :param username: ç”¨æˆ·å
    :param password: å¯†ç 
    :return:
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_accounts'</span><span class="p">).</span><span class="nb">set</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">})</span>
  
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/&lt;website&gt;/count'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">website</span><span class="p">):</span>
    <span class="s">"""
    è·å–Cookiesæ€»æ•°
    """</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'_cookies'</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>
  
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">)</span>
  
</code></pre></div>    </div>
  </li>
  <li>
    <p>è°ƒåº¦æ¨¡å—
  æœ€åï¼Œæˆ‘ä»¬å†åŠ ä¸Šä¸€ä¸ªè°ƒåº¦æ¨¡å—è®©è¿™å‡ ä¸ªæ¨¡å—é…åˆè¿è¡Œèµ·æ¥ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯é©±åŠ¨å‡ ä¸ªæ¨¡å—å®šæ—¶è¿è¡Œï¼ŒåŒæ—¶å„ä¸ªæ¨¡å—éœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¸Šè¿è¡Œ</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">import</span> <span class="nn">time</span>
  <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
    
  <span class="kn">from</span> <span class="nn">cookiespool.api</span> <span class="kn">import</span> <span class="n">app</span>
  <span class="kn">from</span> <span class="nn">cookiespool.config</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="kn">from</span> <span class="nn">cookiespool.generator</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="kn">from</span> <span class="nn">cookiespool.tester</span> <span class="kn">import</span> <span class="o">*</span>
    
    
  <span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">valid_cookie</span><span class="p">(</span><span class="n">cycle</span><span class="o">=</span><span class="n">CYCLE</span><span class="p">):</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæ£€æµ‹è¿›ç¨‹å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">website</span><span class="p">,</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">TESTER_MAP</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                      <span class="n">tester</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cls</span> <span class="o">+</span> <span class="s">'(website="'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">)</span>
                      <span class="n">tester</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
                      <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesæ£€æµ‹å®Œæˆ'</span><span class="p">)</span>
                      <span class="k">del</span> <span class="n">tester</span>
                      <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
              <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">generate_cookie</span><span class="p">(</span><span class="n">cycle</span><span class="o">=</span><span class="n">CYCLE</span><span class="p">):</span>
          <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesç”Ÿæˆè¿›ç¨‹å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">website</span><span class="p">,</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">GENERATOR_MAP</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                      <span class="n">generator</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cls</span> <span class="o">+</span> <span class="s">'(website="'</span> <span class="o">+</span> <span class="n">website</span> <span class="o">+</span> <span class="s">'")'</span><span class="p">)</span>
                      <span class="n">generator</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
                      <span class="k">print</span><span class="p">(</span><span class="s">'Cookiesç”Ÿæˆå®Œæˆ'</span><span class="p">)</span>
                      <span class="n">generator</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                      <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
              <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
    
      <span class="o">@</span><span class="nb">staticmethod</span>
      <span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
          <span class="k">print</span><span class="p">(</span><span class="s">'APIæ¥å£å¼€å§‹è¿è¡Œ'</span><span class="p">)</span>
          <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">API_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">API_PORT</span><span class="p">)</span>
    
      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">API_PROCESS</span><span class="p">:</span>
              <span class="n">api_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">api</span><span class="p">)</span>
              <span class="n">api_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
          <span class="k">if</span> <span class="n">GENERATOR_PROCESS</span><span class="p">:</span>
              <span class="n">generate_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">generate_cookie</span><span class="p">)</span>
              <span class="n">generate_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
          <span class="k">if</span> <span class="n">VALID_PROCESS</span><span class="p">:</span>
              <span class="n">valid_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">valid_cookie</span><span class="p">)</span>
              <span class="n">valid_process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>â€‹</p>
<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>e5c77ca (æ–°é¡µé¢)</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>
:ET